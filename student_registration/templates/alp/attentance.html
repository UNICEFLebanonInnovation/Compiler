{#{% extends "base.appcache.html" %}#}
{#{% load staticfiles i18n %}#}
{#{% get_current_language as LANGUAGE_CODE %}#}
{##}
{#{% block extra_head %}#}
{##}
{#	<link rel="stylesheet" type="text/css" href="{% static 'css/jquery.dataTables.min.css' %}">#}
{#	<link rel="stylesheet" type="text/css" href="{% static 'css/buttons.dataTables.min.css' %}">#}
{#	<link rel="stylesheet" type="text/css" href="{% static 'css/select.dataTables.min.css' %}">#}
{##}
{#{% endblock %}#}
{##}
{##}
{#{% block content-full-page %}#}
{##}
{#         <section class="main-content-wrapper">#}
{#            <section id="main-content">#}
{#                 <div class="row">#}
{#                    <div class="col-md-12">#}
{#                        </br>#}
{#                    </div>#}
{#                </div>#}
{#            <div class="row">#}
{#                    <div class="col-md-12">#}
{#                        <div class="panel panel-default">#}
{#                          <div class="panel-heading">#}
{#                            <h3 class="panel-title">{% trans "Attendance" %}#}
{#                              <a class="btn btn-info" id="attendance-synchro" href="#">#}
{#                                <i class="icon-synch-sign icon-white"></i>&nbsp;#}
{#                                    {% trans "synchronize" %}#}
{#                              </a>#}
{#                              <a class="btn btn-info" id="attendance-export" href="{% url "alp:attendance_export" %}" target="_blank">#}
{#                                <i class="icon-export-sign icon-white"></i>&nbsp;#}
{#                                    {% trans "Export" %}#}
{#                              </a>#}
{#                            </h3>#}
{#                            <div class="actions pull-right">#}
{#                                <i class="fa fa-chevron-down"></i>#}
{#                                <i class="fa fa-times"></i>#}
{#                            </div>#}
{#                          </div>#}
{#                          <div class="panel-body">#}
{#                                <table id="attendances-table" class="table table-striped table-bordered cell-border"#}
{#                                       data-height="500"#}
{#                                       data-pagination="true"#}
{#                                       data-search="true"#}
{#                                       cellspacing="0"#}
{#                                       width="100%">#}
{#                                <thead>#}
{#                                    <tr id="thead-line-1">#}
{#                                        <th rowspan="2">#}
{#                                            {% trans "School" %}#}
{#                                            <input type="checkbox" name="duplicate_school" id="duplicate_school" />#}
{#                                        </th>#}
{#                                        <th rowspan="2">#}
{#                                            {% trans "Grade" %}#}
{#                                            <input type="checkbox" name="duplicate_grade" id="duplicate_grade" />#}
{#                                        </th>#}
{#                                        <th rowspan="2">#}
{#                                            {% trans "Section" %}#}
{#                                            <input type="checkbox" name="duplicate_section" id="duplicate_section" />#}
{#                                        </th>#}
{#                                        <th rowspan="2">{% trans "Student fullname" %}</th>#}
{#                                        <th rowspan="2">{% trans "Student number" %}#}
{#                                            <i class="icon-info-sign" data-toggle="tooltip" title="{% trans "Student number tooltip" %}"></i>#}
{#                                        </th>#}
{#                                    </tr>#}
{#                                </thead>#}
{##}
{#                                <tbody>#}
{##}
{#                                </tbody>#}
{#                            </table>#}
{#                        </div>#}
{#                     </div>#}
{#                </div>#}
{#            </div>#}
{##}
{#            </section>#}
{#         </section>#}
{##}
{#{% endblock %}#}
{##}
{#{% block extra_js %}#}
{##}
{#    <script type="text/javascript" language="javascript" src="{% static 'js/jquery-1.12.3.min.js' %}"></script>#}
{#    <script type="text/javascript" src="{% static 'js/jquery.dataTables.min.js' %}"></script>#}
{#    <script type="text/javascript" src="{% static 'js/dataTables.bootstrap.min.js' %}"></script>#}
{#    <script type="text/javascript" src="{% static 'js/util.js' %}"></script>#}
{#    <script type="text/javascript" src="{% static 'js/tooltip.js' %}"></script>#}
{#    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>#}
{#    <script type="text/javascript" src="{% static 'js/bootbox.js' %}"></script>#}
{#    <script type="text/javascript">#}
{#        var oTable = null;#}
{#        var db = null;#}
{#        var language  = '{{ LANGUAGE_CODE }}';#}
{#        var user_id = {{ request.user.id }};#}
{#        var user_username = '{{ request.user.username }}';#}
{#        var user_email = '{{ request.user.email }}';#}
{#        var columns = 0;#}
{#        var rows = 1;#}
{#        var protocol = 'http://';#}
{#        {% if request.is_secure %}#}
{#            protocol = 'https://';#}
{#        {% endif %}#}
{#        var host = '{{ request.get_host }}';#}
{#        var synchro_path = protocol+host+'/api/attendance/';#}
{##}
{#        window.addEventListener("offline", function(e) {#}
{#          $('#attendance-synchro').hide();#}
{#        }, false);#}
{##}
{#        window.addEventListener("online", function(e) {#}
{#          $('#attendance-synchro').show();#}
{#        }, false);#}
{##}
{#        $(document).ready(function(){#}
{##}
{#            createStores();#}
{##}
{#            setInterval(function(){#}
{#                if(navigator.onLine) {#}
{#                    synchronize_data(false);#}
{#                }#}
{#            }, 3600000);#}
{##}
{#            $('[data-toggle="tooltip"]').tooltip();#}
{##}
{#            $(document).on('blur', '.attendance-field', function(){#}
{#                update_item_store($(this).attr('itemscope'), $(this).attr('name'), $(this).val());#}
{#            });#}
{##}
{#            $(document).on('click', '#attendance-synchro', function(){#}
{#                synchronize_data(true);#}
{#            });#}
{##}
{#        });#}
{##}
{#        function scrollToBottom()#}
{#        {#}
{#            $("html, body").animate({ scrollTop: $(document).height() }, 10);#}
{#        }#}
{##}
{#        function add_attendance_newline(itemid)#}
{#        {#}
{#            var line_html =  $('#attendance_prototype').find('tbody').html().replace(/\$\$itemscope_id\$\$/g, itemid);#}
{#            $('#attendances-table').find('tbody').append(line_html);#}
{#        }#}
{##}
{#        function duplicate_item_values(duplicata, fields)#}
{#        {#}
{#            var new_item = create_item_store_default_keys();#}
{#            $.each(fields, function(field, flag){#}
{#                if(flag){#}
{#                    new_item[field] = duplicata[field];#}
{#                }#}
{#            });#}
{##}
{#            add_to_store(new_item);#}
{#            add_fill_line_data(new_item);#}
{#            scrollToBottom();#}
{#        }#}
{##}
{#        function create_item_store_default_keys()#}
{#        {#}
{#            var item = {id: rows, synchronized: false, deleted: false, owner: user_id};#}
{#            var fields = $('#attendance_prototype').find('.attendance-field');#}
{#            $(fields).each(function(i, field){#}
{#                item[$(field).attr('name')] = '';#}
{#            });#}
{##}
{#            return item;#}
{#        }#}
{##}
{#        function add_to_store(data)#}
{#        {#}
{#            var store = getObjectStore();#}
{#            var request = store.put(data);#}
{#            add_attendance_newline(data.id);#}
{#            rows = rows + 1;#}
{#        }#}
{##}
{#        function delete_from_store(itemid)#}
{#        {#}
{#            var store = getObjectStore();#}
{#            var request = store.get(parseInt(itemid));#}
{#            request.onsuccess = function(){#}
{#                result = request.result;#}
{#                if(result.synchronized == true){#}
{#                    update_item_store(itemid, 'deleted', true);#}
{#                }else{#}
{#                    store.delete(parseInt(itemid));#}
{#                    rows = rows - 1;#}
{#                }#}
{#            }#}
{#        }#}
{##}
{#        function update_item_store(itemid, name, value)#}
{#        {#}
{#            var store = getObjectStore();#}
{#            var request = store.get(parseInt(itemid));#}
{#            request.onsuccess = function(){#}
{#                var item = request.result;#}
{#                item[name] = value;#}
{#                store.put(item);#}
{#            };#}
{#        }#}
{##}
{#        function patch_item_store(item)#}
{#        {#}
{#            var store = getObjectStore();#}
{#            var request = store.get(parseInt(item.id));#}
{#            request.onsuccess = function(){#}
{#                store.put(item);#}
{#            };#}
{#        }#}
{##}
{#        function getCookie(name) {#}
{#            var cookieValue = null;#}
{#            if (document.cookie && document.cookie != '') {#}
{#                var cookies = document.cookie.split(';');#}
{#                for (var i = 0; i < cookies.length; i++) {#}
{#                    var cookie = jQuery.trim(cookies[i]);#}
{#                    // Does this cookie string begin with the name we want?#}
{#                    if (cookie.substring(0, name.length + 1) == (name + '=')) {#}
{#                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));#}
{#                        break;#}
{#                    }#}
{#                }#}
{#            }#}
{#            return cookieValue;#}
{#        }#}
{##}
{#        function build_datatable()#}
{#        {#}
{#            var store = getObjectStore();#}
{#            var request = store.getAll();#}
{#            request.onsuccess = function() {#}
{#                var result = request.result;#}
{#                $(result).each(function(i, item){#}
{#                    rows = item.id;#}
{#                    if(item.deleted == false){#}
{#                        add_attendance_newline(item.id);#}
{#                        add_fill_line_data(item);#}
{#                    }#}
{#                });#}
{#                rows = rows + 1;#}
{#            };#}
{#        }#}
{##}
{#        function add_fill_line_data(item)#}
{#        {#}
{#            var fields = $('#line-'+item.id).find('.attendance-field');#}
{#            $(fields).each(function(i, field){#}
{#                $(field).val(item[$(field).attr('name')]);#}
{#            });#}
{#        }#}
{##}
{#        function synchronize_data(showFeedback)#}
{#        {#}
{#            var store = getObjectStore();#}
{#            var request = store.getAll();#}
{#            request.onsuccess = function() {#}
{#                var result = request.result;#}
{#                $(result).each(function(i, item){#}
{#                    if(item.synchronized == false) {#}
{#                        push_data_to_server(item);#}
{#                    }else if(item.deleted == true){#}
{#                        delete_data_from_server(item);#}
{#                    }else{#}
{#                        update_data_into_server(item);#}
{#                    }#}
{#                });#}
{#                if(showFeedback){#}
{#                    bootbox.alert("{% trans 'Synchronization done' %}", function() {});#}
{#                }#}
{#            };#}
{#        }#}
{##}
{#        function push_data_to_server(item)#}
{#        {#}
{#            var csrftoken = getCookie('csrftoken');#}
{#            var data = item;#}
{#            data['csrfmiddlewaretoken'] = csrftoken;#}
{##}
{#            $.ajax({#}
{#                type: "POST",#}
{#                url: synchro_path,#}
{#                data: data,#}
{#                cache: false,#}
{#                headers: {"X-CSRFToken":csrftoken},#}
{#                dataType: 'json',#}
{#                success: function (response) {#}
{#                    if(response.status == '201'){#}
{#                        $('#line-'+item.id).find('.attendance-field').removeClass('required');#}
{#                        update_item_store(item.id, 'synchronized', true);#}
{#                        item.original_id = response.data.id;#}
{#                        update_item_store(item.id, 'original_id', response.data.id);#}
{#                    }#}
{#                },#}
{#                error: function (response) {#}
{#                    var required_fields = JSON.parse(response.responseText);#}
{#                    $('#line-'+item.id).find('.attendance-field').removeClass('required');#}
{#                    $.each(required_fields, function(field_name, field_msg){#}
{#                        $('#line-'+item.id).find('#'+field_name).addClass('required');#}
{#                    });#}
{#                    console.log(response);#}
{#                }#}
{#            });#}
{#        }#}
{##}
{#        function update_data_into_server(item)#}
{#        {#}
{#            var csrftoken = getCookie('csrftoken');#}
{#            var data = item;#}
{#            data['csrfmiddlewaretoken'] = csrftoken;#}
{##}
{#            $.ajax({#}
{#                type: "PUT",#}
{#                url: synchro_path+item.original_id+'/',#}
{#                data: data,#}
{#                cache: false,#}
{#                headers: {"X-CSRFToken":csrftoken},#}
{#                dataType: 'json',#}
{#                success: function (response) {#}
{#                    if(response.status == '200'){#}
{#                        $('#line-'+item.id).find('.attendance-field').removeClass('required');#}
{#                        update_item_store(item.id, 'synchronized', true);#}
{#                    }#}
{#                },#}
{#                error: function (response) {#}
{#                    var required_fields = JSON.parse(response.responseText);#}
{#                    $('#line-'+item.id).find('.attendance-field').removeClass('required');#}
{#                    $.each(required_fields, function(field_name, field_msg){#}
{#                        $('#line-'+item.id).find('#'+field_name).addClass('required');#}
{#                    });#}
{#                    console.log(response);#}
{#                }#}
{#            });#}
{#        }#}
{##}
{#        function delete_data_from_server(item)#}
{#        {#}
{#            var csrftoken = getCookie('csrftoken');#}
{#            $.ajax({#}
{#                type: "DELETE",#}
{#                url: synchro_path+item.original_id+'/',#}
{#                cache: false,#}
{#                headers: {"X-CSRFToken":csrftoken},#}
{#                dataType: 'json',#}
{#                success: function (response) {#}
{#                    if(response.status = '200') {#}
{#                        var store = getObjectStore();#}
{#                        store.delete(parseInt(item.id));#}
{#                    }#}
{#                },#}
{#                error: function (response) {#}
{##}
{#                }#}
{#            });#}
{#        }#}
{##}
{#        function pull_data_from_server()#}
{#        {#}
{#            var csrftoken = getCookie('csrftoken');#}
{#            data['csrfmiddlewaretoken'] = csrftoken;#}
{##}
{#            $.ajax({#}
{#                type: "GET",#}
{#                url: synchro_path,#}
{#                cache: false,#}
{#                headers: {"X-CSRFToken":csrftoken},#}
{#                dataType: 'json',#}
{#                success: function (response) {#}
{#                    if(response.status == '201'){#}
{#                        var store = getObjectStore();#}
{#                        $(response.data).each(function(i, item){#}
{#                            rows = item.id;#}
{#                            item.synchronized = true;#}
{#                            item.deleted = false;#}
{#                            store.put(item);#}
{#                            add_attendance_newline();#}
{#                        });#}
{#                        rows = rows + 1;#}
{#                    }#}
{#                },#}
{#                error: function (response) {#}
{#                    console.log(response);#}
{#                }#}
{#            });#}
{#        }#}
{##}
{#        function createStores()#}
{#        {#}
{#            var request = indexedDB.open("compile_bd_3", 3);#}
{##}
{#            request.onupgradeneeded = function() {#}
{#                // The database did not previously exist, so create object stores and indexes.#}
{#                db = request.result;#}
{#                var flag = false;#}
{#                try {#}
{#                    if(!db.objectStoreNames().contains('attendances')) {#}
{#                        flag = true;#}
{#                    }#}
{#                }catch(err) {#}
{#                    flag = true;#}
{#                }#}
{#                if(flag){#}
{#                    db.createObjectStore("attendances", {keyPath: "id", autoIncrement:true});#}
{#                    db.createObjectStore("students", {keyPath: "id", autoIncrement:true});#}
{#                    var profile_store = db.createObjectStore("user", {keyPath: "id"});#}
{#                    profile_store.put({id: user_id, username: user_username, email: user_email});#}
{#                }#}
{#            };#}
{##}
{#            request.onsuccess = function() {#}
{#                db = request.result;#}
{#                build_datatable();#}
{#            };#}
{#        }#}
{##}
{#        function getObjectStore()#}
{#        {#}
{#            var store = db.transaction(["attendances"], "readwrite").objectStore("attendances");#}
{#            return store;#}
{#        }#}
{##}
{#        function getRecord(itemid)#}
{#        {#}
{#            var store = getObjectStore();#}
{#            var request = store.get(parseInt(itemid));#}
{#            return request;#}
{#        }#}
{##}
{#    </script>#}
{##}
{#{% endblock %}#}
