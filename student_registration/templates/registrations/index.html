{% extends "base.html" %}
{% load staticfiles i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% load util_tags %}

{% block extra_head %}

	<link rel="stylesheet" type="text/css" href="{% static 'css/jquery.dataTables.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/buttons.dataTables.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/select.dataTables.min.css' %}">

{% endblock %}

{% block content-full-page %}

    {% include 'registrations/prototype.html' %}

         <section class="main-content-wrapper">
            <section id="main-content">
                 <div class="row">
                    <div class="col-md-12">
                        </br>
                    </div>
                </div>
            <div class="row">
                <div class="alert alert-success" role="alert" id="alert-synchro-success" style="display: none;"><strong>{% trans 'Well done' %}</strong> {% trans 'Synchronization success' %}</div>
                <div class="alert alert-warning" role="alert" id="alert-synchro-warning" style="display: none;"><strong>{% trans 'Warning' %}</strong> {% trans 'Please check fill required field' %}</div>
                <div class="alert alert-danger" role="alert" id="alert-connection" style="display: none;">{% trans 'Please check your internet connectivity' %}</div>
            </div>
            <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                          <div class="panel-heading">
                            <h3 class="panel-title">{% trans "Registration" %}
                              <button class="btn btn-info" id="registration-synchro">
                                <i class="icon-synch-sign icon-white"></i>&nbsp;
                                    {% trans "Save" %}
                              </button>
{#                              <button class="btn btn-info" id="registration-add-column">#}
{#                                <i class="icon-plus-sign icon-white"></i>&nbsp;#}
{#                                    {% trans "add column" %}#}
{#                              </button>#}
                              <a class="btn btn-info" id="registration-export" href="{% url "registrations:registration_export" %}" target="_blank">
                                <i class="icon-export-sign icon-white"></i>&nbsp;
                                    {% trans "Export" %}
                              </a>
                            </h3>
                            <div class="actions pull-right">
                                <i class="fa fa-chevron-down"></i>
                                <i class="fa fa-times"></i>
                            </div>
                          </div>
                          <div class="panel-body">
                                <table id="registrations-table" class="table table-striped table-bordered cell-border"
                                       data-height="500"
                                       data-pagination="true"
                                       data-search="true"
                                       cellspacing="0"
                                       width="100%">
                                <thead>
                                    <tr id="thead-line-1">
                                        <th rowspan="2">&nbsp;</th>
                                        <th rowspan="2">
                                            {% trans "District" %}
                                            <input type="checkbox" name="duplicate_section" id="duplicate_location" />
                                        </th>
                                        <th rowspan="2">
                                            {% trans "Governorate" %}
                                        </th>
                                        <th rowspan="2">
                                            {% trans "School number" %}
                                        </th>
                                        <th rowspan="2">
                                            {% trans "School" %}
                                            <input type="checkbox" name="duplicate_school" id="duplicate_school" />
                                        </th>
                                        <th rowspan="2">
                                            {% trans "Class room" %}
                                            <input type="checkbox" name="duplicate_classroom" id="duplicate_classroom" />
                                        </th>
{#                                        <th rowspan="2">#}
{#                                            {% trans "Grade" %}#}
{#                                            <input type="checkbox" name="duplicate_grade" id="duplicate_grade" />#}
{#                                        </th>#}
                                        <th rowspan="2">
                                            {% trans "Section" %}
                                            <input type="checkbox" name="duplicate_section" id="duplicate_section" />
                                        </th>
                                        <th rowspan="2">
                                            {% trans "Student living address" %}
                                        </th>
                                        <th rowspan="2">
                                            {% trans "Phone number" %}
                                        </th>
                                        <th rowspan="2">
                                            {% trans "ID Type" %}
{#                                            <i class="icon-info-sign" data-toggle="tooltip" title="{% trans "ID Number type tooltip" %}"></i>#}
                                        </th>
                                        <th rowspan="2">
                                            {% trans "ID Number" %}
                                            <i class="icon-info-sign" data-toggle="tooltip" title="{% trans "ID Number tooltip" %}"></i>
                                        </th>
                                        <th rowspan="2">{% trans "Sex" %}</th>
                                        <th colspan="3">{% trans "Birthday" %}</th>
                                        <th rowspan="2">{% trans "Age" %}</th>
                                        <th rowspan="2">{% trans "Nationality" %}</th>
                                        <th rowspan="2">{% trans "Mother fullname" %}</th>
                                        <th rowspan="2">{% trans "Mother nationality" %}</th>
                                        <th rowspan="2">{% trans "Student first name" %}</th>
                                        <th rowspan="2">{% trans "Student father name" %}</th>
                                        <th rowspan="2">{% trans "Student last name" %}</th>
{#                                        <th rowspan="2">{% trans "Student number" %}#}
{#                                            <i class="icon-info-sign" data-toggle="tooltip" title="{% trans "Student number tooltip" %}"></i>#}
{#                                        </th>#}
                                    </tr>
                                    <tr id="thead-line-2">
                                        <th>{% trans "year" %}</th>
                                        <th>{% trans "month" %}</th>
                                        <th>{% trans "day" %}</th>
                                    </tr>
                                </thead>

                                <tbody>

                                </tbody>
                            </table>
                        </div>
                          <button class="btn btn-success" id="add_datatable_line">
                            <i class="icon-plus-sign icon-white"></i>&nbsp;
                                {% trans "Add empty line" %}
                          </button>
                          <button class="btn btn-success" id="add_defined_lines">
                            <i class="icon-plus-sign icon-white"></i>&nbsp;
                                {% trans "Add defined number of lines" %}
                          </button>
                          <button class="btn btn-success" id="duplicate_last_line_select">
                            <i class="icon-plus-sign icon-white"></i>&nbsp;
                                {% trans "duplicate last line with selected option" %}
                          </button>
                     </div>
                </div>
            </div>

            </section>
         </section>

{% endblock %}

{% block extra_js %}

    {% get_user_token request.user.id as user_token %}
    <script type="text/javascript" language="javascript" src="{% static 'js/jquery-1.12.3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/dataTables.bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/util.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/tooltip.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootbox.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/appcache.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/indexedDB.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/eav.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/validator.js' %}"></script>
    <script type="text/javascript">
        var oTable = null;
        var db = null;
        var language  = '{{ LANGUAGE_CODE }}';
        var user_id = {{ request.user.id }};
        var user_username = '{{ request.user.username }}';
        var user_email = '{{ request.user.email }}';
        var user_token = '{{ user_token }}';
        var columns = 0;
        var rows = 1;
        var entity_ct = 20;
        var eav_type = '{{ eav_type }}';
        var synchro_result = true;
        var prototype = $('#registration_prototype');
        var table = $('#registrations-table');
        var protocol = 'http://';
        {% if request.is_secure %}
            protocol = 'https://';
        {% endif %}
        var host = protocol+'{{ request.get_host }}';
        var synchro_path = host+'/api/registrations/';
        var synchro_path_extra = host+'/api/eav/attributes/';
        var synchro_path_extra2 = host+'/api/eav/values/';
        var arabic_fields = "#student_mother_fullname, #student_first_name, #student_father_name, #student_last_name";

        window.addEventListener("offline", function(e) {
          $('#registration-synchro').hide();
        }, false);

        window.addEventListener("online", function(e) {
          $('#registration-synchro').show();
        }, false);

        $(document).ready(function(){

            createStores();
            bootbox.addLocale(language, {
                OK : '{% trans "Ok" %}',
                CANCEL : '{% trans "Cancel" %}',
                CONFIRM : '{% trans "Confirm" %}'
            });
            bootbox.setLocale(language);

            setInterval(function(){
                synchro_result = true;
                $('.alert').hide();
                if(navigator.onLine) {
                    synchronize_data(false);
                }else{
                    $('#alert-connection').show();
                }
            }, 3600000);

            $(document).on("click", ".delete-column", function(e) {
                var itemid = $(this).parent().attr('itemscope');
                var iremref = $(this).parent().attr('itemref');
                var breakline = '<br/>';
                var field_values = breakline + '{% trans "This column contains there following data:" %}' + breakline;
                $('#registrations-table').find('.extra-field-'+itemid).each(function(){
                    field_values = field_values + $(this).val() + breakline;
                });
                bootbox.confirm("{% trans 'are you sure you want to delete this column?' %}"+field_values, function(result) {
                    if(result == true){
                        delete_extra_column(itemid, iremref);
                        delete_column_values(itemid);
                    }
                });
            });

            $('[data-toggle="tooltip"]').tooltip();

            $(document).on('blur', arabic_fields, function(){
                checkArabicOnly($(this));
            });

            $(document).on('click', '#add_defined_lines', function(){
                bootbox.prompt("{% trans 'Please enter the number of lines' %}", function(result) {
                    if (result === null) {
                    } else {
                        var number = parseInt(result);
                        for (var i = 0; i < number; i++) {
                            $('#add_datatable_line').trigger('click');
                        }
                    }
                });
            });

            $(document).on('click', '#add_datatable_line', function(){
                var item = create_item_store_default_keys();
                add_to_store(item);
                scrollToBottom();
            });

            $(document).on('click', '#duplicate_last_line_select', function(){
                if(rows == 0) {
                    return false;
                }else{
                    var lastid = $('.registration-field-id:last').val();
                    var request = getRecord(parseInt(lastid), 'registrations');
                    request.onsuccess = function(){

                        var params = {
                            location: $('#duplicate_location').is(':checked'),
                            governorate_name: $('#duplicate_location').is(':checked'),
                            school: $('#duplicate_school').is(':checked'),
                            school_number: $('#duplicate_school').is(':checked'),
                            classroom: $('#duplicate_classroom').is(':checked'),
                            section: $('#duplicate_section').is(':checked'),
{#                            grade: $('#duplicate_grade').is(':checked'),#}
                        };
                        duplicate_item_values(request.result, params);
                    };
                }
            });

            $(document).on('click', '.delete-registration-row', function(){
                var item = $(this);
                bootbox.confirm("{% trans 'are you sure you want to delete this row?' %}", function(result) {
                    if(result == true){
                        delete_from_store(item.attr('itemscope'), 'registrations');
                        item.parents('tr').remove();
                    }
                });
            });

            $(document).on('change', '.registration-location', function(){
                if($(this).val()){
                    var option = $(this).find('option:selected');
                    var itemblock = '.governorate_name_'+$(this).attr('itemscope');
                    update_item_store(parseInt($(this).attr('itemscope')), 'governorate_name', option.attr('data-parent'), 'registrations');
                    $(itemblock).val(option.attr('data-parent'));

                    var school = $('#line-'+$(this).attr('itemscope')).find('.registration-school');
                    school.find('option').hide();
                    school.find('option[value=""]').show();
                    school.find('option[data-parent='+$(this).val()+']').show();
                }
            });

            $(document).on('change', '.registration-school', function(){
                if($(this).val()){
                    var option = $(this).find('option:selected');
                    update_item_store(parseInt($(this).attr('itemscope')), 'school_number', option.attr('itemcontent'), 'registrations');
                    var itemblock = '.school_number_'+$(this).attr('itemscope');
                    $(itemblock).val(option.attr('itemcontent'));
                }
            });

            $(document).on('change', '.student_birthday', function(){
                if($(this).val()) {
                    var option = $(this).find('option:selected');
                    var age = calculateAge($(this).attr('itemscope'));
                    update_item_store(parseInt($(this).attr('itemscope')), 'student_age', age, 'registrations');
                    var itemblock = '.student_age_'+$(this).attr('itemscope');
                    $(itemblock).val(age);
                }
            });

            $(document).on('blur', '.registration-field', function(){
                if($(this).hasClass('extra-field')){
                    update_one_by_index('name', $(this).attr('name'), 'value_text', $(this).val(), 'eav-columns-values')
                }else{
                    update_item_store(parseInt($(this).attr('itemscope')), $(this).attr('name'), $(this).val(), 'registrations');
                }
            });

            $(document).on('click', '#registration-synchro', function(){
                synchro_result = true;
                $('.alert').hide();
                if(navigator.onLine) {
                    synchronize_data(true);
                }else{
                    $('#alert-connection').show();
                }
            });

            $(document).on('click', '#registration-pull', function(){
                load_base_data();
            });

            $(document).on('click', '#registration-add-column', function(){
                bootbox.prompt("{% trans 'Please enter extra column name' %}", function(result) {
                  if (result === null) {
                  } else {
                    columns = columns + 1;
                    var column_name = 'extra-column-'+user_id+'-'+columns;
                    var column_label = result;
                    var column = {id: columns, name: column_name, label: column_label, synchronized: false, owner: user_id, deleted: false, type: eav_type};

                    add_column_to_store(column);
                    create_extra_columns_html(column, true);

                    var store = getStoreByName('registrations');
                    var request = store.getAll();
                    request.onsuccess = function(){
                        var result = request.result;
                        if(result){
                            $(result).each(function(i, item){
                                if(item.deleted == false){
                                    var td = create_extra_field_html(columns, item.id, user_id);
                                    $('#line-'+item.id).append(td);
                                    var field_name = 'extra-field-'+user_id+'-'+columns+'-'+item.id;
                                    create_column_values(item, field_name, {id: columns, original_id: 0});
                                }
                            });
                        }
                    };
                  }
                });
            });
        });

        function calculateAge(itemid)
        {
            var age = 0;
            var form = $('#line-'+itemid);

            var birthday_day = form.find('#student_birthday_day').val();
            var birthday_month = form.find('#student_birthday_month').val()-1;
            var birthday_year = form.find('#student_birthday_year').val();

            var birthDate = new Date(birthday_year, birthday_month, birthday_day);

            if(birthday_day != "" && birthday_month != "" && birthday_year != "" ) {
                age = getDateDiff(birthDate,new Date());
            }

            return age;
        }

        function getDateDiff(dateOfBirth, dateToCalculate) {
            var calculateYear = dateToCalculate.getFullYear();
            var calculateMonth = dateToCalculate.getMonth();
            var calculateDay = dateToCalculate.getDate();

            var birthYear = dateOfBirth.getFullYear();
            var birthMonth = dateOfBirth.getMonth();
            var birthDay = dateOfBirth.getDate();

            var age = calculateYear - birthYear;
            var ageMonth = calculateMonth - birthMonth;
            var ageDay = calculateDay - birthDay;

            if (ageMonth < 0 || (ageMonth == 0 && ageDay < 0)) {
                age = parseInt(age) - 1;
            }

            return age;
        }

        function duplicate_item_values(duplicata, fields)
        {
            var new_item = create_item_store_default_keys();
            $.each(fields, function(field, flag){
                if(flag){
                    new_item[field] = duplicata[field];
                }
            });

            add_to_store(new_item);
            add_fill_line_data(new_item);
            scrollToBottom();
        }

        function create_item_store_default_keys()
        {
            var item = {id: rows, synchronized: false, deleted: false, owner: user_id, original_id: 0};
            var fields = $('#registration_prototype').find('.registration-field');
            $(fields).each(function(i, field){
                item[$(field).attr('name')] = '';
            });

            var store1 = getStoreByName('eav-shared-columns');
            var request1 = store1.getAll();
            request1.onsuccess = function(){
                var result1 = request1.result;
                if(result1){
                    $(result1).each(function(i, col){
                        var field_name = 'extra-field-'+col.owner+'-'+col.id+'-'+item.id;
                        create_column_values(item, field_name, col);
                    });
                }
            };

            var store = getStoreByName('eav-columns');
            var request = store.getAll();
            request.onsuccess = function(){
                var result = request.result;
                if(result){
                    $(result).each(function(i, col){
                        if(col.deleted == false){
                            var field_name = 'extra-field-'+user_id+'-'+col.id+'-'+item.id;
                            create_column_values(item, field_name, col);
                        }
                    });
                }
            };

            return item;
        }

        function add_to_store(data)
        {
            var store = getStoreByName('registrations');
            var request = store.put(data);
            add_table_newline(data.id, prototype, table);
            rows = rows + 1;
        }

        function build_datatable()
        {
            add_extra_columns();
            var store = getStoreByName('registrations');
            var request = store.getAll();
            request.onsuccess = function() {
                var result = request.result;
                $(result).each(function(i, item){
                    rows = item.id;
                    if(item.deleted == false){
                        add_table_newline(item.id, prototype, table);
                        add_fill_line_data(item);
                        add_fill_extra_fields_data(item.id);
                    }
                });
                rows = rows + 1;
            };
        }

        function add_fill_line_data(item)
        {
            var fields = $('#line-'+item.id).find('.registration-field');
            $(fields).each(function(i, field){
                $(field).val(item[$(field).attr('name')]);
            });
        }

        function synchronize_data(showFeedback)
        {
            var store = getStoreByName('registrations');
            var request = store.getAll();
            request.onsuccess = function() {
                var result = request.result;
                $(result).each(function(i, item){
                    if(item.synchronized == false) {
                        push_data_to_server(item);
                    }else if(item.deleted == true){
                        delete_data_from_server(synchro_path, item.original_id, item.id, 'registrations');
                    }else{
                        update_data_into_server(item);
                    }
                });
                if(showFeedback && synchro_result == true){
                    $('#alert-synchro-success').show();
                }
                if(showFeedback && synchro_result == false){
                    $('#alert-synchro-warning').show();
                }
            };

            var col_store = getStoreByName('eav-columns');
            var col_request = col_store.getAll();
            col_request.onsuccess = function() {
                var col_result = col_request.result;
                $(col_result).each(function(i, col){
                    if(col.synchronized == false && col.deleted == false) {
                        push_extra_columns_to_server(col);
                    }else if(col.synchronized == true && col.deleted == true){
                        delete_data_from_server(synchro_path_extra, col.original_id, col.id, 'eav-columns');
                    }else{
                        col_store.delete(parseInt(col.id));
                    }
                });
            };

            var colv_store = getStoreByName('eav-columns-values');
            var colv_request = colv_store.getAll();
            colv_request.onsuccess = function() {
                var colv_result = colv_request.result;
                $(colv_result).each(function(i, colv){
                    if(colv.entity_id && colv.attribute) {
                        if (colv.synchronized == false && colv.deleted == false) {
                            push_column_values_to_server(colv);
                        } else if (colv.synchronized == true && colv.deleted == true) {
                            delete_data_from_server(synchro_path_extra2, colv.original_id, colv.id, 'eav-columns-values');
                        } else {
                            update_data_server(synchro_path_extra2, colv, colv.original_id);
                        }
                    }
                });
            };
        }

        function push_data_to_server(item)
        {
            var data = item;

            $.ajax({
                type: "POST",
                url: synchro_path,
                data: data,
                cache: false,
                async: false,
                headers: getHeader(),
                dataType: 'json',
                success: function (response) {
                    if(response.status == '201'){
                        $('#line-'+item.id).find('.registration-field').removeClass('required');
                        item.synchronized = true;
                        item.original_id = response.data.id;

                        update_item_store(parseInt(item.id), 'synchronized', true, 'registrations');
                        update_item_store(parseInt(item.id), 'original_id', response.data.id, 'registrations');
                        update_items_by_index('entity', parseInt(item.id), 'entity_id', response.data.id, 'eav-columns-values');
                        synchro_result = true;
                    }
                },
                error: function (response) {
                    var required_fields = JSON.parse(response.responseText);
                    $('#line-'+item.id).find('.registration-field').removeClass('required');
                    $.each(required_fields, function(field_name, field_msg){
                        $('#line-'+item.id).find('#'+field_name).addClass('required');
                    });
                    console.log(response);
                    synchro_result = false;
                }
            });
        }

        function update_data_into_server(item)
        {
            var data = item;

            $.ajax({
                type: "PUT",
                url: synchro_path+item.original_id+'/',
                data: data,
                cache: false,
                headers: getHeader(),
                dataType: 'json',
                success: function (response) {
                    if(response.status == '200'){
                        $('#line-'+item.id).find('.registration-field').removeClass('required');
                        update_item_store(parseInt(item.id), 'synchronized', true, 'registrations');
                        update_items_by_index('entity', parseInt(item.id), 'entity_id', item.original_id, 'eav-columns-values');
                        synchro_result = true;
                    }
                },
                error: function (response) {
                    var required_fields = JSON.parse(response.responseText);
                    $('#line-'+item.id).find('.registration-field').removeClass('required');
                    $.each(required_fields, function(field_name, field_msg){
                        $('#line-'+item.id).find('#'+field_name).addClass('required');
                    });
                    console.log(response);
                    synchro_result = false;
                }
            });
        }

        function load_base_data()
        {
            pull_data_from_server(host+'/api/eav/attributes/?type='+eav_type, 'eav-shared-columns');
        }

        function createStores()
        {
            var request = indexedDB.open("compile_bd_4", 3);

            request.onupgradeneeded = function() {
                // The database did not previously exist, so create object stores and indexes.
                db = request.result;
                var flag = false;
                try {
                    if(!db.objectStoreNames().contains('registrations')) {
                        flag = true;
                    }
                }catch(err) {
                    flag = true;
                }
                if(flag){
                    db.createObjectStore("registrations", {keyPath: "id", autoIncrement:true});
                    var store1 = db.createObjectStore("eav-shared-columns", {keyPath: "id", autoIncrement:true});
                    store1.createIndex('name', 'name');

                    var store2 = db.createObjectStore("eav-columns", {keyPath: "id", autoIncrement:true});
                    store2.createIndex('name', 'name');
                    var store3 = db.createObjectStore("eav-columns-values", {keyPath: "id", autoIncrement:true});
                    store3.createIndex('name', 'name');
                    store3.createIndex('entity', 'entity');
                    store3.createIndex('column', 'column');
                    store3.createIndex('attribute', 'attribute');

                    var profile_store = db.createObjectStore("user", {keyPath: "id"});
                    profile_store.put({id: user_id, username: user_username, email: user_email});
                }
            };

            request.onsuccess = function() {
                db = request.result;
                load_base_data();
                setTimeout(function(){
                    build_datatable();
                }, 5000);
            };
        }

    </script>

{% endblock %}
