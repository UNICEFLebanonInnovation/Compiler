{% extends "base.html" %}
{% load staticfiles i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% load util_tags %}

{% block extra_head %}

    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-breadcrumbs.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-alert.css' %}">

{% endblock %}

{% block content-full-page %}

{% get_range_str 2001 2020 as last_education_years %}
{% get_range_str 2001 2020 as last_informal_years %}

    <style>
        .incremental_number.success {
            background-color: #1ABB9C !important;
        }
        .incremental_number.failed {
            background-color: #ac2925 !important;
        }
        tr.highlighted {
            background-color: darkseagreen !important;
        }
        .registration-field-p:focus {
            background-color: yellow;
        }
        .registration-field:focus {
            background-color: yellow;
        }
        tr.warning {
            border: 3px solid #90111A;
        }
    </style>

         <section class="main-content-wrapper">
            <section id="main-content">
                 <div class="row">
                    <div class="col-md-12">
                        </br>
                    </div>
                </div>
            <div class="row">
                <div class="alert alert-success" role="alert" id="alert-synchro-success" style="display: none;"><strong>{% trans 'Well done' %}</strong> {% trans 'Synchronization success' %}</div>
                <div class="alert alert-warning" role="alert" id="alert-synchro-warning" style="display: none;"><strong>{% trans 'Warning' %}</strong> {% trans 'Please check fill required field' %}</div>
                <div class="alert alert-danger" role="alert" id="alert-connection" style="display: none;">{% trans 'Please check your internet connectivity' %}</div>
            </div>
            <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                          <div class="panel-heading" style="position: absolute; top:0px;" id="header">
                            <ol class="breadcrumb">
                                <li><h3 class="panel-title">{% trans "Registration" %}</h3></li>
                                <li>
                                  <button class="btn btn-info" id="registration-synchro">
                                    <i class="icon-synch-sign icon-white"></i>&nbsp;
                                        {% trans "synchronize" %}
                                  </button>
                                </li>
                                <li>
                                    <select name="classroom" id="filter_class" class="col-200">
                                        <option value="">{% trans "Filter by Class" %}</option>
                                        {% for item in classrooms %}
                                            <option value="{{ item.id }}">{{ item.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <a class="btn btn-info" id="registration-export" href="{% url "enrollments:enrollment_export" %}" target="_blank">
                                        <i class="icon-export-sign icon-white"></i>&nbsp;
                                            {% trans "Export" %}
                                    </a>
                                    <button class="btn btn-warning" id="filter_cancel">
                                        {% trans "Rest filter" %}
                                    </button>
                                </li>
                            </ol>
                            <div class="actions pull-right">
                                <i class="fa fa-chevron-down"></i>
                                <i class="fa fa-times"></i>
                            </div>
                          </div>
                          <div class="panel-body">
                              <div class="loader"></div>
                                <table id="registrations-table" class="table table-striped table-bordered cell-border"
                                       data-height="500"
                                       data-pagination="true"
                                       data-search="true"
                                       cellspacing="0"
                                       width="100%" style="margin-bottom: 100px; margin-top: 75px;">
                                <thead>
                                    <tr id="thead-line-1">
                                        <th rowspan="2">#</th>
                                        <th rowspan="2"><label>{% trans "Governorate" %}</label></th>
                                        <th rowspan="2"><label>{% trans "District" %}</label></th>
                                        <th rowspan="2"><label>{% trans "School number" %}</label></th>
                                        <th rowspan="2"><label>{% trans "School" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Student first name" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Student father name" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Student last name" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Sex" %}</label></th>
                                        <th colspan="3" style="text-align: center;"><label>{% trans "Student birthday" %}</label></th>
                                        <th rowspan="2"><label class="col-60">{% trans "Student age" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Student nationality" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Mother fullname" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Mother nationality" %}</label></th>
                                        <th rowspan="2"><label class="col-100">{% trans "Registered in UNHCR" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Student ID Type" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Student ID Number" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Student living address" %}</label></th>
                                        <th rowspan="2"><label class="col-100">{% trans "Phone number (6 digits)" %}</label></th>
                                        <th rowspan="2"><label class="col-100">{% trans "Phone prefix (2 digits)" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Current Class" %}</label></th>
                                        <th rowspan="2"><label>{% trans "Current Section" %}</label></th>
                                        <th colspan="6" style="text-align: center; background-color: #67b168;"><label>{% trans "Last student education" %}</label></th>
                                        <th colspan="4" style="text-align: center; background-color: #ec971f;"><label>{% trans "Last student informal education" %}</label></th>
                                    </tr>
                                    <tr id="thead-line-2">
                                        <th><label>{% trans "year" %}</label></th>
                                        <th><label>{% trans "month" %}</label></th>
                                        <th><label>{% trans "day" %}</label></th>
                                        <th style="background-color: #67b168;"><label class="col-100">{% trans "Last education level" %}</label></th>
                                        <th style="background-color: #67b168;"><label>{% trans "School type" %}</label></th>
                                        <th style="background-color: #67b168;"><label>{% trans "School shift" %}</label></th>
                                        <th style="background-color: #67b168;"><label>{% trans "School" %}</label></th>
                                        <th style="background-color: #67b168;"><label>{% trans "Education year" %}</label></th>
                                        <th style="background-color: #67b168;"><label>{% trans "Result" %}</label></th>
                                        <th style="background-color: #ec971f;"><label class="col-150">{% trans "Is the child participated in an ALP/2016-2 program" %}</label></th>
                                        <th style="background-color: #ec971f;"><label>{% trans "ALP level" %}</label></th>
                                        <th style="background-color: #ec971f;"><label>{% trans "ALP round" %}</label></th>
                                        <th style="background-color: #ec971f;"><label>{% trans "ALP result" %}</label></th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for line in data %}
{#                                    {% include 'enrollments/prototype_history.html' %}#}
{#{% load staticfiles i18n %}#}
{#{% load util_tags %}#}

{#{% get_range_str 2001 2020 as last_education_years %}#}
{#{% get_range_str 2001 2020 as last_informal_years %}#}

    <tr id="line-{{ line.id }}" class="registration-line" itemscope="{{ line.id }}">
        <td>
            <input type="hidden" name="id" value="{{ line.id }}" class="registration-field-id" />
            <span class="incremental_number" itemscope="{{ line.id }}" style="font-weight: bold;"></span>
        </td>
        <td>
            {% if location_parent %}{{ location_parent.name }}{% endif %}
        </td>
        <td>
            {% if location %}{{ location.name }}{% endif %}
        </td>
        <td>
            {% if school %}{{ school.number }}{% endif %}
        </td>
        <td>
            {% if school %}{{ school.name }}{% endif %}
        </td>
        <td>
            {{ line.student_first_name }}
        </td>
        <td>
            {{ line.student_father_name }}
        </td>
        <td>
            {{ line.student_last_name }}
        </td>
        <td>
            {{ line.student_sex }}
        </td>
        <td>
            {{ line.student_birthday_year }}
        </td>
        <td>
            {{ line.student_birthday_month }}
        </td>
        <td>
            {{ line.student_birthday_day }}
        </td>
        <td>
            {{ line.student_age }}
        </td>
        <td>
            {{ line.student_nationality }}
        </td>
        <td>
            {{ line.student_mother_fullname }}
        </td>
        <td>
            {{ line.student_mother_nationality }}
        </td>
        <td>
            {% if line.registered_in_unhcr %}Yes{% else %}No{% endif %}
        </td>
        <td>
            {{ line.student_id_type }}
        </td>
        <td>
            {{ line.student_id_number }}
        <td>
            {{ line.student_address }}
        </td>
        <td>
            {{ line.student_phone }}
        </td>
        <td>
            {{ line.student_phone_prefix }}
        </td>
        <td>
            {{ line.classroom_name }}
        </td>
        <td>
            {{ line.section_name }}
        </td>
        <td>
            <select name="last_education_level" id="last_education_level" class="registration-field" itemscope="{{ line.id }}">
                <option value="">{% trans "Last education level" %}</option>
                {% for item in education_levels %}
                    <option value="{{ item.id }}" {% if line.last_education_level_id == item.id %}selected="selected"{% endif %}>{{ item.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select name="last_school_type" id="last_school_type" class="registration-field" itemscope="{{ line.id }}">
                <option value="">{% trans "School type" %}</option>
                {% for key, item in school_types %}
                    <option value="{{ key }}" {% if line.last_school_type == key %}selected="selected"{% endif %}>{{ item }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select name="last_school_shift" id="last_school_shift" class="registration-field" itemscope="{{ line.id }}">
                <option value="">{% trans "School shift" %}</option>
                {% for key, item in school_shifts %}
                    <option value="{{ key }}" {% if line.last_school_shift == key %}selected="selected"{% endif %}>{{ item }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select name="last_school" id="last_school" class="registration-field" itemscope="{{ line.id }}">
                <option value="">{% trans "School" %}</option>
                {% for item in schools %}
                    <option value="{{ item.id }}" {% if line.last_school_id == item.id %}selected="selected"{% endif %}>{{ item }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select name="last_education_year" id="last_education_year" class="registration-field" itemscope="{{ line.id }}">
                <option value="">{% trans "Education year" %}</option>
                {% for item in last_education_years %}
                    <option value="{{ item }}" {% if line.last_education_year == item %}selected="selected"{% endif %}>{{ item }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select name="last_year_result" id="last_year_result" class="registration-field" itemscope="{{ line.id }}">
                <option value="">{% trans "Result" %}</option>
                {% for key, item in education_results %}
                    <option value="{{ key }}" {% if line.last_year_result == key %}selected="selected"{% endif %}>{{ item }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <label><input type="radio" name="participated_in_alp_{{ line.id }}"
                          data-name="participated_in_alp" value="1"
                          data-value="yes" id="participated_in_alp_1"
                          class="registration-field registration-field-check"
                          itemscope="{{ line.id }}" itemref=""
                          {% if line.participated_in_alp == 'yes' %}checked="checked"{% endif %}/>
                {% trans "Yes" %}
            </label>
            <label><input type="radio" name="participated_in_alp_{{ line.id }}"
                          data-name="participated_in_alp" value="0"
                          data-value="no" id="participated_in_alp_0"
                          class="registration-field registration-field-check"
                          itemscope="{{ line.id }}" itemref="alp_details"
                          {% if line.participated_in_alp == 'no' %}checked="checked"{% endif %} />
                {% trans "No" %}
            </label>
        </td>
        <td>
            <select name="last_informal_edu_level" id="last_informal_edu_level" class="registration-field alp_details" itemscope="{{ line.id }}">
                <option value="">{% trans "ALP level" %}</option>
                {% for item in informal_educations %}
                    <option value="{{ item.id }}" {% if line.last_informal_edu_level_id == item.id %}selected="selected"{% endif %}>{{ item.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select name="last_informal_edu_round" id="last_informal_edu_round" class="registration-field alp_details" itemscope="{{ line.id }}">
                <option value="">{% trans "ALP round" %}</option>
                {% for item in alp_rounds %}
                    <option value="{{ item.id }}" {% if line.last_informal_edu_round_id == item.id %}selected="selected"{% endif %}>{{ item.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select name="last_informal_edu_final_result" id="last_informal_edu_final_result" class="registration-field alp_details" itemscope="{{ line.id }}">
                <option value="">{% trans "ALP result" %}</option>
                {% for item in education_final_results %}
                    <option value="{{ item.id }}" {% if line.last_informal_edu_final_result_id == item.id %}selected="selected"{% endif %}>{{ item.name }}</option>
                {% endfor %}
            </select>
        </td>
    </tr>

                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div style="position: fixed; bottom: 10px; {% if LANGUAGE_CODE == 'ar-ar' %}right: 35px;{% else %}left: 35px;{% endif %}">
{#                              <button class="btn btn-success" id="add_datatable_line">#}
{#                                <i class="icon-plus-sign icon-white"></i>&nbsp;#}
{#                                    {% trans "Add empty line" %}#}
{#                              </button>#}
{#                              <button class="btn btn-success" id="add_defined_lines">#}
{#                                <i class="icon-plus-sign icon-white"></i>&nbsp;#}
{#                                    {% trans "Add defined number of lines" %}#}
{#                              </button>#}
                        </div>
                     </div>
                </div>
            </div>

            </section>
         </section>

{% endblock %}

{% block extra_js %}

    {% get_user_token request.user.id as user_token %}
    <script type="text/javascript">
        var oTable = null;
        var db = null;
    </script>
    <script type="text/javascript" language="javascript" src="{% static 'js/jquery-1.12.3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/dataTables.bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/util.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/tooltip.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootbox.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/appcache.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/indexedDB.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/eav.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/validator.js' %}"></script>
    <script type="text/javascript">
        var db = null;
        var language  = '{{ LANGUAGE_CODE }}';
        var user_id = {{ request.user.id }};
        var school_id = {{ request.user.school_id }};
        var user_username = '{{ request.user.username }}';
        var user_email = '{{ request.user.email }}';
        var user_token = '{{ user_token }}';
        var columns = 0;
        var rows = 1;
        var entity_ct = 20;
        var limit = 100;
        var offset = 0;
        var total = 0;
        var synchro_result = true;
        var prototype = $('#registration_prototype');
        var table = $('#registrations-table');
        var protocol = 'http://';
        {% if request.is_secure %}
            protocol = 'https://';
        {% endif %}
        var host = protocol+'{{ request.get_host }}';
        var synchro_path = host+'/api/enrollments/';
        var arabic_fields = "#student_address, #student_mother_fullname, #student_first_name, #student_father_name, #student_last_name";

        window.addEventListener("offline", function(e) {
          $('#registration-synchro').hide();
        }, false);

        window.addEventListener("online", function(e) {
          $('#registration-synchro').show();
        }, false);

        $(document).ready(function(){

            createStores();

            $(document).on('blur', arabic_fields, function(){
                checkArabicOnly($(this));
            });

            $(document).on('click', 'tbody tr', function(){
                $('tbody').find('tr').removeClass('highlighted');
                $(this).addClass('highlighted');
            });

            $(window).scroll(function () {
                var l = $(this).scrollLeft();
                if(parseInt(l) <= 0){
                    $('#header').css({'left': l});
                }else{
                    $('#header').css({'right': -l});
                }
            });

            $(document).on('click', '#participated_in_alp_1, #participated_in_alp_0', function(){
                var itemscope = $(this).attr('itemscope');
                var alp_details = $('#line-'+itemscope).find('.alp_details');
                if($(this).attr('data-value') == 'yes'){
                    $(alp_details).removeAttr('disabled');
                }else{
                    $(alp_details).val('');
                    $(alp_details).trigger('blur');
                    $(alp_details).attr('disabled', 'disabled');
                }
            });

            $(document).on('change', '#filter_section, #filter_class, #filter_id_type, #filter_nationality', function(){
                if($(this).val()){
                    var value = $(this).val();
                    var name = $(this).attr('name');
                    $('.registration-line').hide();
                    $('.registration-line').each(function(i, item){
                        var select = $(this).find('#'+name);
                        if($(select).val() == value){
                            $(this).show();
                        }
                    });
                }else{
                    $('.registration-line').show();
                }
            });

            $(document).on('click', '#filter_cancel', function(){
                $('.registration-line').show();
                $('#filter_section').val('');
                $('#filter_class').val('');
                $('#filter_id_type').val('');
                $('#filter_nationality').val('');
            });

            $(document).on('blur, change', '.registration-field', function(){
                if($(this).attr('data-value')){
                    update_or_create_item(parseInt($(this).attr('itemscope')), $(this).attr('data-name'), $(this).attr('data-value'), 'registrations');
                }else{
                    update_or_create_item(parseInt($(this).attr('itemscope')), $(this).attr('name'), $(this).val(), 'registrations');
                }
                flag_record_to_update(parseInt($(this).attr('itemscope')), 'registrations');
            });

            $(document).on('change', '.registration-field-check', function(){
                update_or_create_item(parseInt($(this).attr('itemscope')), $(this).attr('data-name'), $(this).attr('data-value'), 'registrations');
                flag_record_to_update(parseInt($(this).attr('itemscope')), 'registrations');
            });

            $(document).on('click', '#registration-synchro', function(){
                synchro_result = true;
                $('.alert').hide();
                if(navigator.onLine) {
                    $(".loader").show();
                    synchronize_data(true);
                }else{
                    $('#alert-connection').show();
                }
            });

        });

        function synchronize_data()
        {
            push_data();
        }

        function push_data()
        {
            var store = getStoreByName('registrations');
            var request = store.getAll();
            request.onsuccess = function() {
                var result = request.result;
                $(result).each(function(i, item){
                    $(".loader").show();
                    if(item.to_update == true){
                        patch_data_into_server(item);
                    }
                    $(".loader").hide();
                });
            };
        }

        function patch_data_into_server(item)
        {
            var itemid = item.id;
            var data = item;
            delete data.id;

            $.ajax({
                type: "PATCH",
                url: synchro_path+itemid+'/',
                data: data,
                cache: false,
                headers: getHeader(),
                dataType: 'json',
                success: function (response, result, jqXHR) {
                    update_item_store(parseInt(itemid), 'to_update', false, 'registrations');
                },
                error: function (response) {
                    console.log(response);
                    $('#line-'+itemid).addClass('warning');
                    var required_fields = JSON.parse(response.responseText);
                    $.each(required_fields, function(field_name, field_msg){
                        $('#line-'+itemid).find('#'+field_name).addClass('required');
                    });
                }
            });
        }

        function createStores()
        {
            var request = indexedDB.open("compile_bd_edit_history", 3);

            request.onupgradeneeded = function() {
                // The database did not previously exist, so create object stores and indexes.
                db = request.result;
                var flag = false;
                try {
                    if(!db.objectStoreNames().contains('registrations')) {
                        flag = true;
                    }
                }catch(err) {
                    flag = true;
                }
                if(flag){
                    var store = db.createObjectStore("registrations", {keyPath: "id", autoIncrement:true});
                    store.createIndex('original_id', 'original_id');

                    var store1 = db.createObjectStore("eav-shared-columns", {keyPath: "id", autoIncrement:true});
                    store1.createIndex('name', 'name');
                    var store2 = db.createObjectStore("eav-columns", {keyPath: "id", autoIncrement:true});
                    store2.createIndex('name', 'name');
                    var store3 = db.createObjectStore("eav-columns-values", {keyPath: "id", autoIncrement:true});
                    store3.createIndex('name', 'name');
                    store3.createIndex('entity', 'entity');
                    store3.createIndex('column', 'column');
                    store3.createIndex('attribute', 'attribute');

                    var profile_store = db.createObjectStore("user", {keyPath: "id"});
                    profile_store.put({id: user_id, username: user_username, email: user_email});
                }
            };

            request.onsuccess = function() {
                db = request.result;
                $(".loader").show();
                setTimeout(function(){
                    $(".loader").hide();
                }, 5000);
            };
        }

    </script>

{% endblock %}
