{% extends "base.html" %}

{% load staticfiles i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% load util_tags %}

{% block extra_head %}

{#    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-badge.css' %}">#}
{#    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-progressbars.css' %}">#}
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-switch.min.css' %}">
{#    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-button-group.css' %}">#}
{#    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-breadcrumbs.css' %}">#}
    <style>
        .breadcrumb {
            position: relative;
        }
        .row-class  {
            max-height:75px;
            border-radius: 0 8px 8px 0;
            margin: 15px 0px;
            cursor: pointer;
            background: #f5f5f5; /* For browsers that do not support gradients */
            background: -webkit-linear-gradient(left top, #f5f5f5, #EDEFF1); /* For Safari 5.1 to 6.0 */
            background: -o-linear-gradient(left top, #f5f5f5, #EDEFF1); /* For Opera 11.1 to 12.0 */
            background: -moz-linear-gradient(left top, #f5f5f5, #EDEFF1); /* For Firefox 3.6 to 15 */
            background: linear-gradient(left top, #f5f5f5, #EDEFF1); /* Standard syntax */
            box-shadow: 1px 1px 5px #888888;
        }
        .row-class:hover {
            text-decoration: none;
        }
        .row-class div {
{#            border: 1px solid;#}
        }
        .row-class .s-col {
            height: 75px;
            max-height: 75px;
        }
        .row-class .progress-success {
            color: #5cb85c !important;
            border: 1px solid #5cb85c;
        }
        .progress-bar.progress-bar-success {
            background: #5cb85c;
        }
        .progress-bar.progress-bar-danger {
            background: #d9534f;
        }
        .row-class .progress-danger {
            color: #d9534f !important;
            border: 1px solid #d9534f;
        }
        .row-class .progress .progress-bar {
{#            color: #2aabd2 !important;#}
            color: #0b0b0b;
        }
        .row-class.disabled {
            pointer-events: none;
            cursor: not-allowed !important;
            opacity: .65;
        }
        .row-student  {
            border-radius: 0 8px 8px 0;
            margin: 15px 0px;
            background: #f5f5f5; /* For browsers that do not support gradients */
            background: -webkit-linear-gradient(left top, #f5f5f5, #EDEFF1); /* For Safari 5.1 to 6.0 */
            background: -o-linear-gradient(left top, #f5f5f5, #EDEFF1); /* For Opera 11.1 to 12.0 */
            background: -moz-linear-gradient(left top, #f5f5f5, #EDEFF1); /* For Firefox 3.6 to 15 */
            background: linear-gradient(left top, #f5f5f5, #EDEFF1); /* Standard syntax */
            box-shadow: 1px 1px 5px #888888;
        }
        .row-student .s-col {
            padding-top: 15px;
        }
        .row-student div {
{#            border: 1px solid;#}
        }
        .row-student .absence-reasons label {
            font-style: italic;
            padding-right: 5px;
        }
        .row-student .absence-reasons input {
            margin-right: 10px;
        }
        .btn-attendance-day.active {
            background-color: #2aabd2;
            color: red;
        }
        .s-lft {
        }
        .s-lft div {
            padding-top: 5px;
            margin-top: 5px;
        }
        .s-rgt {
            border-radius: 0 8px 8px 0;
            background: #2aabd2;
        }
        .row-class .s-progs {
            padding-top: 5px;
        }
        .s-progs .progress {
            margin-top: 10px;
        }
        .breadcrumb li:first-child {
            padding-left: 10px;
        }
        .absolute-top-7 {
            position: absolute;
            top: 7px;
        }
        .absolute-top-15 {
            position: absolute;
            top: 15px;
        }
        .absolute-right-30 {
            position: absolute;
            right: 30px;
        }
    </style>
{% endblock %}

{% block header %}
      <li class="nav-item">
        <a class="nav-link" href="">{{ school }} - {{ location }} - {{ location_parent }}
            - <span class="badge">{{ total }}</span>
        </a>
      </li>
{% endblock %}

{% block content-full-page %}

         <section class="main-content-wrapper">
            <section id="main-content">
                 <div class="row">
                    <div class="col-md-12">
                        </br>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="alert alert-success d-none" role="alert">
                                {% trans 'Your data has been sent successfully to the server' %}
                            </div>
                            <div class="alert alert-danger d-none" role="alert">
                                {% trans 'En error has been occurred please contact the admin or try later' %}
                            </div>
                        {% if not level %}
                          <div class="panel-heading">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <select name="dates" id="dates" class="form-control">
                                        {% for date in dates %}
                                            <option value="{{ date.value }}" {% if date.value == selected_date %}selected="selected"{% endif %} data-action="{% url "attendances:attendance" %}?date={{ date.value }}">{{ date.label }}</option>
                                        {% endfor %}
                                    </select>
                                </li>
                                <li class="breadcrumb-item" style="font-size: 20px"><span>{{ school }}</span></li>
                                <li class="absolute-right-30 absolute-top-15" style="font-size: 20px"><span class="badge badge-primary">{{ total }}</span></li>
                            </ol>
                          </div>
                        {% endif %}
                          <div class="panel-heading">
                                {% if level %}
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a class="btn btn-info" href="{% url "attendances:attendance" %}?date={{ selected_date }}">{% trans "Back to " %} {{ selected_date_view }}</a>
                                    <button type="button" class="btn btn-warning absolute-right-30 absolute-top-15" id="exam_day" translation="{% trans 'Are you sure that the students of this class are away for a reason?' %}" {% if disable_attendance %}disabled{% endif %}>{% trans "Exam day" %}</button>
                                </li>
                            </ol>
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    {{ level.name }} - {{ section.name }}
                                </li>
                                <li class="breadcrumb-item">
                                    <span class="badge badge-primary">{{ current_level_section.total }}: {% trans "Total students" %}</span> -
                                    <span class="badge badge-success">{{ current_level_section.total_attended }}: {% trans "Total attended" %}</span> -
                                    <span class="badge badge-danger">{{ current_level_section.total_absences }}: {% trans "Total absences" %}</span>
                                    <a href="#" class="btn btn-success absolute-right-30 absolute-top-7 {% if disable_attendance %}disabled{% endif %}" id="save_attendances" translation="{% trans 'Are you sure you want to save the attendance for this class?' %}">{% trans "Save" %}</a>
                                </li>
                            </ol>
                                {% endif %}
                                {% if not level %}
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    {% if attendance and attendance.close_reason %}
                                        <button class="btn btn-default"><b>{% trans 'School is closed for: ' %}{{ attendance.close_reason }}</b></button>
                                    {% else %}
                                      <button type="button" class="closing-reason-b btn btn-primary" itemref="public_holiday" translation="{% trans 'Are you sure that the school is closed today for a public holiday?' %}" {% if attendance.validation_date %}disabled{% endif %}>{% trans "Public Holiday" %}</button>
                                      <button type="button" class="closing-reason-b btn btn-warning" itemref="school_holiday" translation="{% trans 'Are you sure that the school is closed today for a school holiday?' %}" {% if attendance.validation_date %}disabled{% endif %}>{% trans "School Holiday" %}</button>
                                      <button type="button" class="closing-reason-b btn btn-danger" itemref="strike" translation="{% trans 'Are you sure that the school is closed today for a strike?' %}" {% if attendance.validation_date %}disabled{% endif %}>{% trans "Strike" %}</button>
                                      <button type="button" class="closing-reason-b btn btn-info" itemref="weekly_holiday" translation="{% trans 'Are you sure that the school is closed today for a weekly holiday?' %}" {% if attendance.validation_date %}disabled{% endif %}>{% trans "Weekly Holiday" %}</button>
                                    {% endif %}
                                    {% if attendance %}
{#                                        {% if request.user|has_group:"DIRECTOR" or request.user|has_group:"ALP_DIRECTOR" %}#}
                                        {% if attendance.validation_date %}
                                            <button class="btn btn-default absolute-right-30 absolute-top-15"><b>{% trans 'Attendances validated on' %}: {{ attendance.validation_date }}</b></button>
                                        {% else %}
                                            <button type="button" itemref="{{ attendance.id }}" class="btn btn-success absolute-right-30 absolute-top-15" id="attendance_validate" translation="{% trans 'Are you sure you want to validate all attendances?' %}">{% trans "Validate all" %}</button>
                                        {% endif %}
{#                                        {% endif %}#}
                                    {% endif %}
                                </li>
                            </ol>
                                {% endif %}
                          </div>
                        </div>
                    </div>
                </div>
            </section>

            <div id="attendance-sheet" class="">
                <input type="hidden" name="school" value="{{ request.user.school_id }}" id="school" />
                <input type="hidden" name="owner" value="{{ request.user.id }}" id="owner" />
            {% if not level %}
                {% for row in levels_by_sections %}
                <a class="row row-class" href="{% url "attendances:attendance" %}?date={{ selected_date }}&level={{ row.level }}&section={{ row.section }}">
                    <div class="col-xs-4 col-sm-4 col-md-4 s-lft s-col" style="border-left: 10px solid #2aabd2;">
                        <div>{{ row.level_name }}</div>
                        <div>{{ row.section_name }}</div>
                    </div>
                    <div class="col-xs-3 col-sm-3 col-md-3 s-col">
                        {% if row.validation_date %}
                            <span class="attendance-status icon-2-check"></span>
                            {% if row.exam_day %}
                            <span class="attendance-status icon-exam-check"></span>
                            {% endif %}
                        {% elif row.exam_day %}
                            <span class="attendance-status icon-exam-check"></span>
                        {% elif row.total_attended or row.total_absences %}
                            <span class="attendance-status icon-check"></span>
                        {% else %}
                            <span class="attendance-status icon-pending-check"></span>
                        {% endif %}
                    </div>
                    <div class="col-xs-3 col-sm-3 col-md-3 s-progs s-col">
                        <div class="progress progress-success">
                            <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="{{ row.total_attended }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ row.total_attended|percentage_int:row.total }}%">
                               {{ row.total_attended }} ({{ row.total_attended|percentage_int:row.total }})%
                            </div>
                         </div>
                        <div class="progress progress-danger">
                            <div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="{{ row.total_absences }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ row.total_absences|percentage_int:row.total }}%">
                               {{ row.total_absences }} ({{ row.total_absences|percentage_int:row.total }})%
                            </div>
                         </div>
                    </div>
                    <div class="col-xs-2 col-sm-2 col-md-2 s-rgt s-col">
                        <span class="icon-students"></span>
                        <span style="font-size: 30px; color: #fff; position: absolute; bottom: -5px; left: 22px; text-shadow: 1px 1px 1px;">{{ row.total }}</span>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <form action="/api/attendances/" method="post" onsubmit="return false;" id="attendance_class">
                    <input type="hidden" name="attendance_date" value="{{ selected_date }}" id="attendance_date" />
                    <input type="hidden" name="school" value="{{ request.user.school_id }}" id="school" />
                    <input type="hidden" name="owner" value="{{ request.user.id }}" id="owner" />
                    <input type="hidden" name="section" value="{{ section.id }}" id="section" />
                    <input type="hidden" name="level" value="{{ level.id }}" id="level" />
                {% for line in students %}
                    <div class="row row-student">
                        <input type="hidden" name="enrollment_id[]" value="{{ line.id }}" class="enrollment_id" />
                        <input type="hidden" name="student_id[]" id="student_id_{{ line.id }}" value="{{ line.student.id }}" />
                        <input type="hidden" name="student_fullname[]" id="student_fullname_{{ line.id }}" value="{{ line.student }}" />
                        <input type="hidden" name="student_sex[]" id="student_sex_{{ line.id }}" value="{{ line.student.sex }}" />
                        <input type="hidden" name="student_age[]" id="student_age_{{ line.id }}" value="{{ line.student.age }}" />
                        <input type="hidden" name="student_birthday[]" id="student_birthday_{{ line.id }}" value="{{ line.student.birthday }}" />
                        <input type="hidden" name="level[]" id="level_{{ line.id }}" value="{{ level.id }}" />
                        <input type="hidden" name="level_name[]" id="level_name_{{ line.id }}" value="{{ level.name }}" />
                        <input type="hidden" name="section[]" id="section_{{ line.id }}" value="{{ section.id }}" />
                        <input type="hidden" name="section_name[]" id="section_name_{{ line.id }}" value="{{ section.name }}" />

                        <div class="col-xs-6 col-sm-2 icon-student-{{ line.student.sex }} s-col" style="border-left: 10px solid #2aabd2;"></div>
                        <div class="col-xs-3 col-sm-3 s-col">
                            <span>{{ line.student }}</span>
                        </div>
                        <div class="col-xs-3 col-sm-3 s-col">
                            <span class="icon-mother"></span>
                            <span>{{ line.student.mother_fullname }}</span>
                        </div>
                        <div class="col-xs-2 col-sm-2 col-md-2 s-col">
                            <span class="icon-age"></span>
                            <span>{{ line.student.age }}</span>
                        </div>
                        <div class="col-xs-6 col-sm-2 col-md-2 s-col">
                            <input type="checkbox" name="status[]" id="status_{{ line.id }}" {% if line.attendance_status == 'True' or line.attendance_status == None %}checked="checked" value="True"{% else %}value="False"{% endif %} itemid="{{ line.id }}" class="toggle-status" data-on-text="{% trans "Present" %}" data-off-text="{% trans "Absent" %}" {% if disable_attendance %}disabled{% endif %}/>
                        </div>
                        <div class="col-sm-8 absence-reasons {% if line.attendance_status == 'True' or line.attendance_status == None %}d-none{% endif %}" id="reasons-{{ line.id }}">
                            <label class="radio-inline"><input type="radio" {% if line.absence_reason == 'sick' %}checked="checked"{% endif %} value="sick" name="absence_reason[{{ line.id }}]" class="absence_reason_{{ line.id }}" {% if disable_attendance %}disabled{% endif %}/>{% trans "Sick" %}</label>
                            <label class="radio-inline"><input type="radio" {% if line.absence_reason == 'no_reason' %}checked="checked"{% endif %} value="no_reason" name="absence_reason[{{ line.id }}]" class="absence_reason_{{ line.id }}" {% if disable_attendance %}disabled{% endif %}/>{% trans "No reason" %}</label>
                            <label class="radio-inline"><input type="radio" {% if line.absence_reason == 'no_transport' %}checked="checked"{% endif %} value="no_transport" name="absence_reason[{{ line.id }}]" class="absence_reason_{{ line.id }}" {% if disable_attendance %}disabled{% endif %}/>{% trans "No transport" %}</label>
                            <label class="radio-inline"><input type="radio" {% if line.absence_reason == 'other' %}checked="checked"{% endif %} value="other" name="absence_reason[{{ line.id }}]" class="absence_reason_{{ line.id }}" {% if disable_attendance %}disabled{% endif %}/>{% trans "Other" %}</label>
                        </div>
                    </div>
                {% endfor %}

                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a class="btn btn-info" href="{% url "attendances:attendance" %}?date={{ selected_date }}">{% trans "Back to " %} {{ selected_date_view }}</a>
                            <a href="#" class="btn btn-success absolute-right-30 absolute-top-7 {% if disable_attendance %}disabled{% endif %}" id="save_attendances" translation="{% trans 'Are you sure you want to save the attendance for this class?' %}">{% trans "Save" %}</a>
                        </li>
                    </ol>
                </form>
            {% endif %}
            </div>
         </section>

{% endblock %}

{% block extra_js %}
    {% get_user_token request.user.id as user_token %}

    <script type="text/javascript" language="javascript" src="{% static 'js/jquery-1.12.3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/util.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap-switch.min.js' %}"></script>
    <script type="text/javascript">
        var user_token = '{{ user_token }}';
        var total_enrolled = {{ total }};

        $(document).ready(function(){

            $('[data-toggle="tooltip"]').tooltip();

            $(document).on('click', '.closing-reason-b', function () {
                if(confirm($(this).attr('translation'))){
                    var data = {
                        owner: $('input#owner').val(),
                        attendance_date: $('select#dates').val(),
                        school: $('input#school').val(),
                        close_reason: $(this).attr('itemref'),
                        students: {}
                    };
                    set_attendances(data);
                    $('.closing-reason-b').hide();
                    $('.closing-reason-b').addClass('disabled');
                    $(this).show();
                }
            });

            $(document).on('change', '#dates', function(){
                if($(this).val()) {
                    window.location = $('#dates').find('option:selected').attr('data-action');
                }
            });

            $(document).on('click', '#save_attendances', function(){
                if(confirm($(this).attr('translation'))) {
                    var level_section = get_level_section_attendances(false);

                    var data = {
                            owner: $('input#owner').val(),
                            attendance_date: $('input#attendance_date').val(),
                            school: $('input#school').val(),
                            total_enrolled: total_enrolled
                    };
                    set_attendances(data, level_section);
                }
            });

            $(document).on('click', '#attendance_validate', function(){
                var today = new Date();
                var dd = today.getDate();
                var mm = today.getMonth()+1; //January is 0!
                var yyyy = today.getFullYear();
                var attendance = $(this).attr('itemref');
                if(confirm($(this).attr('translation'))) {
                    var data = {
                        validation_owner: $('input#owner').val(),
                        validation_status: true,
                        validation_date: yyyy+'-'+mm+'-'+dd
                    };
                    patch_attendances(attendance, data);
                    $(this).addClass('disabled');
                    $('.attendance-status').removeClass('icon-pending-check');
                    $('.attendance-status').removeClass('icon-check');
                    $('.attendance-status').addClass('icon-2-check');
                }
            });

            $(document).on('click', '#exam_day', function(){
                if(confirm($(this).attr('translation'))) {
                    var level_section = {};
                    var level_section_name = $('#level').val() + "-" + $('#section').val();
                    level_section[level_section_name] = {
                        students: {},
                        total_enrolled: $('.enrollment_id').length,
                        total_absences: 0,
                        total_attended: 0,
                        total_attended_male: 0,
                        total_attended_female: 0,
                        total_absent_male: 0,
                        total_absent_female: 0,
                        exam_day: true
                    };

                    var data = {
                            owner: $('input#owner').val(),
                            attendance_date: $('input#attendance_date').val(),
                            school: $('input#school').val(),
                            total_enrolled: total_enrolled
                    };
                    set_attendances(data, level_section);
                    $(this).remove();
                    $('#save_attendances').remove();
                    $("[class='toggle-status']").remove();
                }
            });

            $("[class='toggle-status']").bootstrapSwitch();
            $("[class='toggle-status']").on('switchChange.bootstrapSwitch', function(event, state) {
                $("[class='status-checkbox']").bootstrapSwitch('state', state);
                var itemid = $(event.target).attr('itemid');
                $(event.target).val(state);
                if(state == false){
                    $('#reasons-'+itemid).removeClass('d-none');
                }else{
                    $('#reasons-'+itemid).addClass('d-none');
                }
            });
        });

        function get_level_section_attendances(exam_day)
        {
            var students = new Array();
            var level_section = {};
            var total_absences = 0;
            var total_attended = 0;
            var total_attended_male = 0;
            var total_attended_female = 0;
            var total_absent_male = 0;
            var total_absent_female = 0;
            $('.enrollment_id').each(function (i, item) {
                var enrollment_id = $(item).val();
                var status = null;
                var sex = $('#student_sex_'+enrollment_id).val();
                var absence_reason = null;

                if($('#status_'+enrollment_id).val() == '' || $('#status_'+enrollment_id).val() == 'True'){
                    status = 'True';
                    absence_reason  = '';
                    if(sex == 'Male'){
                        total_attended_male = total_attended_male + 1;
                    }else{
                        total_attended_female = total_attended_female + 1;
                    }
                }else{
                    status = 'False';
                    absence_reason  = $('.absence_reason_' + enrollment_id+':checked').val();
                    if(sex == 'Male'){
                        total_absent_male = total_absent_male + 1;
                    }else{
                        total_absent_female = total_absent_female + 1;
                    }
                }

                total_attended = total_attended_male + total_attended_female;
                total_absences = total_absent_male + total_absent_female;
                var student_id = $('#student_id_' + enrollment_id).val();

                students.push({
                    student_id: student_id,
                    student_fullname: $('#student_fullname_' + enrollment_id).val(),
                    student_sex: sex,
                    student_age: $('#student_age_' + enrollment_id).val(),
                    student_birthday: $('#student_birthday_' + enrollment_id).val(),
                    section: $('#section_' + enrollment_id).val(),
                    section_name: $('#section_name_' + enrollment_id).val(),
                    level: $('#level_' + enrollment_id).val(),
                    level_name: $('#level_name_' + enrollment_id).val(),
                    status: status,
                    absence_reason: absence_reason
                });

            });

            var level_section_name = $('#level').val() + "-" + $('#section').val();
            level_section[level_section_name] = {
                students: students,
                total_enrolled: students.length,
                total_absences: total_absences,
                total_attended: total_attended,
                total_attended_male: total_attended_male,
                total_attended_female: total_attended_female,
                total_absent_male: total_absent_male,
                total_absent_female: total_absent_female,
                exam_day: exam_day
            };
            return level_section;
        }

        function disable_attendance()
        {
            $('.closing-reason-b').attr('disabled', 'disabled');
            $('.row-class').addClass('disabled');
        }

        function set_attendances(data, patch_data)
        {
            $.ajax({
                type: "POST",
                url: "/api/attendances/",
                data: data,
                cache: false,
                async: true,
                headers: getHeader(),
                dataType: 'json',
                success: function (response, result, jqXHR) {
                    if(response.data && patch_data){
                        update_attendances(response.data, patch_data);
                    }else{
                        display_feedback(true);
                    }
                },
                error: function (response) {
                    console.log(response);
                    display_feedback(false);
                }
            });
        }

        function update_attendances(id, data)
        {
            $.ajax({
                type: "PUT",
                url: "/api/attendances/"+id+"/",
                data: JSON.stringify(data),
                cache: false,
                async: true,
                headers: getHeader(),
                dataType: 'json',
                success: function (response, result, jqXHR) {
                    if(response.data){
                        display_feedback(true);
                    }
                },
                error: function (response) {
                    display_feedback(false);
                }
            });
        }

        function patch_attendances(id, data)
        {
            $.ajax({
                type: "PATCH",
                url: "/api/attendances/"+id+"/",
                data: data,
                cache: false,
                async: true,
                headers: getHeader(),
                dataType: 'json',
                success: function (response, result, jqXHR) {
                    if(response.data){
                        display_feedback(true);
                    }
                },
                error: function (response) {
                    display_feedback(false);
                }
            });
        }

        function display_feedback(status)
        {
            $('.alert').addClass('d-none');

            if(status){
                $('.alert-success').removeClass('d-none');
            }else{
                $('.alert-danger').removeClass('d-none');
            }
        }

    </script>

{% endblock %}
