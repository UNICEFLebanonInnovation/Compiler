{% extends "base.offline.html" %}
{% load staticfiles i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% load util_tags %}

{% block extra_head %}

    <link rel="stylesheet" type="text/css" href="{% static 'css/sly.css' %}"
          xmlns:font-weight="http://www.w3.org/1999/xhtml" xmlns:font-weight="http://www.w3.org/1999/xhtml">
    <link rel="stylesheet" type="text/css" href="{% static 'css/signature_pad.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-breadcrumbs.css' %}">

{% endblock %}


{% block content %}

<div class="alert alert-success" role="alert" id="alert-synchro-success" style="display: none;;">
    {% trans 'Application submission success' %}.
    {% trans 'Please click' %}
    <a class="nav-link" href="{% url 'registrations:registering_pilot' %}?ln={{ LANGUAGE_CODE }}">{% trans "here" %}</a>
    {% trans 'to start a new application' %}.
</div>
<div class="alert alert-success" role="alert" id="alert-cancel-success" style="display: none;;">
    {% trans 'Application registration cancelled' %}.
    {% trans 'Please click' %}
    <a class="nav-link" href="{% url 'registrations:registering_pilot' %}?ln={{ LANGUAGE_CODE }}">{% trans "here" %}</a>
    {% trans 'to start a new application' %}.
</div>

{#<button type="button" id="registration-synchro">synch</button>#}

<form method="post" action="" class="inlineForm" id="mainForm" style="display: block;">
    <input type="hidden" name="id_registration" id="main_id" />
{#    {% csrf_token %}#}
    {% if form.errors %}
        {% for field in form %}
            {% for error in field.errors %}
                <div class="alert alert-danger">
                    <strong>{{ error|escape }}</strong>
                </div>
            {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
            <div class="alert alert-danger">
                <strong>{{ error|escape }}</strong>
            </div>
        {% endfor %}
    {% endif %}
    <div class="panel-body">
        <div id="oneperframe" class="frame oneperframe" {% if LANGUAGE_CODE == 'ar-ar' %}lang="en" dir="ltr"{% endif %}>
            <ul class="slidee" {% if LANGUAGE_CODE == 'ar-ar' %}lang="en" dir="ltr"{% endif %}>

                {# 1 Slide select a school #}
                <li class="active framebox">
                    <h3 class="panel-title">{% trans "Registration Household" %}</h3>
                    <div class="line">
                        <label class="text">{% trans "Select School" %}</label>
                        {{ form.school }}
                        <span class="error" id="school_error">{% trans "This field is required" %}</span>
                    </div>
                </li>

                {# 2 Slide introduction part 1 #}
                <li class="framebox">
                    <p>
                        <strong>{% trans "Welcome to the Registration Desk of the Min Ila Pilot" %}</strong>
                    </p>
                    <p>{% trans "The Min Ila Pilot will provide children enrolled in 2nd shift with a cash transfer. Each child aged 5 to 9 will receive USD 20 per month. Each child aged 10 and above will receive USD 65 per month." %}</p>
                    <p>{% trans "This cash is intended to help children regularly attend 2nd shift school in order that their future opportunities are improved." %}</p>
                </li>

                {# 3 Slide introduction part 2 #}
                <li class="framebox">
                    <p>{% trans "If a student stops attending school, you will receive an SMS reminder of the purpose of this cash." %}</p>
                    <p>{% trans "If the student does not return to school, you will receive a household visit to help us understand why the student cannot attend and to offer you more services to help the student attend school." %}</p>
                </li>

                {# 4 Slide introduction part 3 #}
                <li class="framebox">
                    <p>{% trans "This desk is to Register for the Min Ila Pilot, not to enroll in school. Children must already be enrolled in school in order to Register for the Pilot." %}</p>
                    <p>{% trans "If your child does not enroll in school he/she will be removed from the Min Ila Pilot." %}</p>
                    <p>{% trans "If your child is not already enrolled in school, please go and do so now, then return to Register for the Pilot" %}</p>
                </li>

                {# 5 Slide introduction part 4 #}
                <li class="framebox">
                    <p>{% trans "If your address or phone number changes, you must inform us by calling 81-313940. If your household cannot be found after 2 months you will stop receiving benefits." %}</p>
                    <p>{% trans "Please take a leaflet now so you have this important phone number with you." %}</p>
                </li>

                {# 6 #}
                <li class="framebox">
                    <h3 class="panel-title" >{% trans "Register New Household" %}</h3>
                    <div class="line">
                        <label class="text">{% trans "Nationality" %}<span class="asterisque">*</span></label>
                        {{ form.nationality }}
                        <span class="error" id="nationality_error">{% trans "This field is required" %}</span>
                    </div>
                     <div class="line">
                        <label class="text">{% trans "ID Type" %}<span class="asterisque">*</span></label>
                        {{ form.id_type }}
                          <span class="error" id="id_type_error">{% trans "This field is required" %}</span>
                     </div>

                     <div class="line" id="household_visit_note" style="display: none;">
                         <span class="error">{% trans "NOTE: Your household will receive a visit to confirm this child belongs to your household." %}</span>
                     </div>

                    <div id="HouseholdUNHCR" style="display:none">
                        <div class="line">
                            <label class="text">{% trans "Is the principal applicant still with your household?" %}<span class="asterisque"></span></label>
                            {% for choice in form.principal_applicant_living_in_house %}
                            <span class="hidden-field">{{ choice }}</span>
                        {% endfor %}
                        <div id="radioBtn" class="btn-group PrincipalHouseHold_block">
                            <a class="btn btn-primary btn-sm active" data-toggle="id_principal_applicant_living_in_house" data-title="1">{% trans "Yes" %}</a>
                            <a class="btn btn-primary btn-sm notActive" data-toggle="id_principal_applicant_living_in_house" data-title="0">{% trans "No" %}</a>
                        </div>

                        </div>

                    </div>

                    <div class="line" id="Household_block"style="display:none">
                        <label class="text" id="HouseholdRegistrationNumber" style = "display:none">{% trans "UNHCR Household Registration Number" %}<span class="asterisque">*</span></label>
                        <label class="text" id="HouseholdOtherID" style="display: none;">{% trans "Household ID Number" %}<span class="asterisque">*</span></label>
                        <span>{{ form.id_number }}</span>
                        <span class="error" id="id_number_UNHCR_Other_error">{% trans "This field is required" %}</span>
                        <span class="error" id="id_number_UNHCR_Other_format_error">{% trans "The UNHCR ID is not valid" %}</span>
                        <span class="error" id="id_number_national_id_format_error">{% trans "The National ID is not valid" %}</span>
                        <button class="btn btn-primary" type="button" id="getUNHCRDatatButton" style="display: none">
                            {% trans "UNHCR Data" %}
                        </button>
                    </div>

                    <div class="line" id="Individual_block"style="display:none">
                        <label class="text" >{% trans "UNHCR Individual Registration Number of the Household Representative" %}<span class="asterisque">*</span></label>
                        <span>{{ form.individual_id_number }}</span>
                        <span class="error" id="individual_id_number_error">{% trans "This field is required" %}</span>
                        <span class="error" id="individual_id_number_format_error">{% trans "The ID is not valid" %}</span>
                        <span class="error" >{% trans "NOTE: If the Household Representative is not listed on the UNHCR Certificate, it cannot be used to regiter for the Pilot. Another form of ID must be used." %}</span>
                    </div>

                    <div class="line" id="HouseholdOtherID_Note" style="display: none;">
                         <span class="error">{% trans "NOTE: in order to register with other ID, the ID Holder must be present AND must be 18 years of age or older." %}</span>
                    </div>



                    <div id="HouseholdInformation" style="display:none">
                        <div class="line">
                            <label class="text">{% trans "First Name" %}<span class="asterisque">*</span></label>
                            {{ form.first_name }}
                            <span class="error" id="first_name_error">{% trans "This field is required" %}</span>
                        </div>
                        <div class="line">
                            <label class="text">{% trans "Father's Name" %}<span class="asterisque">*</span></label>
                            {{ form.father_name }}
                            <span class="error" id="father_name_error">{% trans "This field is required" %}</span>
                        </div>
                        <div class="line">
                            <label class="text">{% trans "Last Name" %}<span class="asterisque">*</span></label>
                            {{ form.last_name }}
                            <span class="error" id="last_name_error">{% trans "This field is required" %}</span>
                        </div>
                        <div class="line">
                            <label class="text">{% trans "Mother's Full name" %}<span class="asterisque">*</span></label>
                            {{ form.mother_fullname }}
                            <span class="error" id="mother_fullname_error">{% trans "This field is required" %}</span>
                        </div>
                        <div class="line">
                            <label class="text">{% trans "Age" %}<span class="asterisque">*</span></label>
                            {{ form.age }}
                             <span class="error" id="age_error">{% trans "This field is required" %}</span>
                        </div>
                        <div class="line field-select-small-size">
                            <label class="text">{% trans "Date of birth" %}</label>
                            {{ form.birthday_day }}
                            {{ form.birthday_month }}
                            {{ form.birthday_year }}
                            <span class="error" id="dob_error">{% trans "This field is required" %}</span>
                        </div>
                        <div class="line">
                            <label class="text">{% trans "Gender" %}<span class="asterisque">*</span></label>
                            {{ form.sex }}
                             <span class="error" id="gender_error">{% trans "This field is required" %}</span>
                        </div>
                        <div class="line">
                            <label class="text">{% trans "Relationship to Household head" %}<span class="asterisque">*</span></label>
                            {{ form.relation_to_householdhead }}
                             <span class="error" id="relationship_householdhead_error">{% trans "This field is required" %}</span>
                        </div>
                    </div>
                </li>
               {# 7 Confirm ID#}
                <li class="framebox">
                     <div class="line">
                        <label class="text" id="HouseholdRegistrationNumber_confirm" style = "display:none">{% trans "Confirm UNHCR Household Registration Number" %}<span class="asterisque">*</span></label>
                        <label class="text" id="HouseholdOtherID_confirm" style="display: none;">{% trans "Confirm Household ID Number" %}<span class="asterisque">*</span></label>
                       <span>{{ form.id_number_duplicate }}</span>
                        <span class="error" id="id_number_UNHCR_confirm_error">{% trans "This field is required" %}</span>
                        <span class="error" id="id_number_UNHCR_confirm_format_error">{% trans "The ID is not valid" %}</span>
                         <span class="error" id="id_number_UNHCR_Other_confirm_error">{% trans "The ID provided do not match" %}</span>
                    </div>
                </li>

                {# 8 Slide card introduction part 1 #}
                <li class="framebox">
                    <p>{% trans "You will receive your payments on an ATM Card. If you do not already have a Burgundy ATM Card, you will be provided with one. UNICEF will send you an SMS to tell you the date, time and place you can collect the Burgundy ATM Card." %}</p>
                    <p>{% trans "Note: It is very important that you provide us a working phone number so we can send you the details of where and when to collect your ATM Card" %}</p>
                </li>

                {# 9 Slide card introduction part 2 #}
                <li class="framebox">
                    <h3 class="panel-title">{% trans "Collect existing ATM case number" %}</h3>
                    <label class="text">{% trans "Please copy case number directly from card" %}</label>

{#                    <div class="line">#}
{#                        <label class="text">{% trans "Blue Card Case Number" %}</label>#}
{#                        {{ form.wfp_case_number }}#}
{#                    </div>#}
{#                    <div class="line">#}
{#                        <label class="text">{% trans "White Card Case Number" %}</label>#}
{#                        {{ form.csc_case_number }}#}
{#                    </div>#}
                    <div class="line">
                        <label class="text">{% trans "Red Card Case Number" %}</label>
                        {{ form.red_case_number }}
                    </div>
                </li>


                {# 10 Registre Child #}
                <li class="framebox">
                    <h3 class="panel-title">{% trans "Register Children in Pilot" %}</h3>
                    <div class="line">
                        <label class="text">{% trans "Do you have any children enrolled in other 2nd shift schools?" %}</label>
                        {% for choice in form.child_enrolled_in_other_schools %}
                            <span class="hidden-field">{{ choice }}</span>
                        {% endfor %}
                        <div id="radioBtn" class="btn-group child_enrolled_in_other_schools_block">
                            <a class="btn btn-primary btn-sm notActive" data-toggle="id_child_enrolled_in_other_schools" data-title="1">{% trans "Yes" %}</a>
                            <a class="btn btn-primary btn-sm notActive" data-toggle="id_child_enrolled_in_other_schools" data-title="0">{% trans "No" %}</a>
                        </div>
                    </div>
                    <div class="line" id="registration_status_block" style="display: none;">
                        <label class="text">{% trans "Have you already completed the registration process for this pilot in other school?" %}</label>
                        {% for choice in form.previously_registered_status %}
                            <span class="hidden-field">{{ choice }}</span>
                        {% endfor %}
                        <div id="radioBtn" class="btn-group previously_registered_status_block">
                            <a class="btn btn-primary btn-sm notActive" data-toggle="id_previously_registered_status" data-title="1">{% trans "Yes" %}</a>
                            <a class="btn btn-primary btn-sm notActive" data-toggle="id_previously_registered_status" data-title="0">{% trans "No" %}</a>
                        </div>
                    </div>
                    <div class="line" id="previously_registered_block" style="display: none;">
                        <label class="text">{% trans "You would have been required to present your ID when completing the Pilot Registration Process in the other school. Do you have the ID Number that was presented during your previous Pilot Registration?" %}</label>
                        {% for choice in form.previously_registered %}
                            <span class="hidden-field">{{ choice }}</span>
                        {% endfor %}
                        <div id="radioBtn" class="btn-group">
                            <a class="btn btn-primary btn-sm notActive" data-toggle="id_previously_registered" data-title="1">{% trans "Yes" %}</a>
                            <a class="btn btn-primary btn-sm notActive" data-toggle="id_previously_registered" data-title="0">{% trans "No" %}</a>
                        </div>
                    </div>
                    <span class="error" id="previously_registered_error" style="display: none;">
                        {% trans "To ensure that your household receives complete payment you must provide the ID Number under which your other registration took place. You can either come back tomorrow, or you can call the hotline to do this. It is important that you do this in order to not delay your payment" %}
                    </span>
                    <div class="line" id="id_number_block" style="display: none;">
                      <label class="text">{% trans "ID Number" %}<span class="asterisque">*</span></label>
                      {{ form.previously_registered_number }}
                      <button class="btn btn-primary" type="button" id="get_household_children_data_button">
                        {% trans "Edit File" %}
                      </button>
                     </div>
                    <span class="error" id="confirm_child_belong" style="display: none;">
                        {% trans "You must confirm that the child belongs to this household by checking the UNHCR Certificate or Family Book. If the household has neither, inform them that a Pilot Officer will visit their household to confirm the child lives with them" %}
                    </span>
                    <div id="no_id_block" style="display: none;">
                        <table class="table table-striped table-bordered cell-border children_table" id="no_id_table"
                               data-height="500"
                               data-pagination="true"
                               data-search="true"
                               cellspacing="0"
                               width="100%">
                            <thead>
                                <th>{% trans "School" %}</th>
                                <th>ID</th>
                                <th>{% trans "Full Name" %}</th>
                                <th>{% trans "Mother's Full name" %}</th>
{#                                <th>{% trans "Date of birth" %}</th>#}
                                <th>{% trans "Age" %}</th>
                                <th>{% trans "Relationship to Household representative" %}</th>
                                <th>{% trans "Was this child enrolled in any school last year" %}</th>
                                <th></th>
                                <th></th>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <button class="btn btn-success" id="add_child_noid" type="button">
                            {% trans "Add Child" %}
                            <i class="icon-plus-sign icon-white"></i>
                        </button>
                    </div>
                    <div id="with_id_block" style="display: none;">
                        <table class="table table-striped table-bordered cell-border children_table" id="with_id_table"
                               data-height="500"
                               data-pagination="true"
                               data-search="true"
                               cellspacing="0"
                               width="100%">
                            <thead>
                                <th>{% trans "School" %}</th>
                                <th>{% trans "Child's UNHCR Individual Number" %}</th>
                                <th>{% trans "Relationship to Household representative" %}</th>
                                <th>{% trans "Was this child enrolled in any school last year" %}</th>
                                <th></th>
                                <th></th>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <button class="btn btn-success" id="add_child_withid" type="button">
                            {% trans "Add Child" %}
                            <i class="icon-plus-sign icon-white"></i>
                        </button>
                    </div>

                </li>

                {# 11 Contact information #}
                <li class="framebox">
                    <h3 class="panel-title">{% trans "Contact Information" %}</h3>
                    <p>
                        {% trans "Officers of the Min Ila Cash Pilot must be able to reach you by phone and household visit in order for your household to benefit from the pilot. Your information will only be provided to officers of the pilot who will be trained to handle your information carefully and will only visit you if your child drops out of school." %}
                    </p>
                    <p>
                        <strong>{% trans "If you change your phone number or address, please inform the program by calling 81-313940, or you will be removed after we are unable to locate you." %}</strong>
                    </p>
                    <p>
                        <strong>{% trans "This number is on the leaflet provided to you." %}</strong>
                    </p>
                </li>

                {# 12 Declaration #}
                <li class="framebox">
                    <h3 class="panel-title">{% trans "Declaration and Consent" %}</h3>
                    <p>
                        {% trans "Every month your household will receive a cash amount intended to help the children you have registered in the pilot to attend school. Each child 5 to 9 years old will get USD 20 and each child aged 10 and above will receive USD 65. If your child stops attending school you will receive an SMS to remind you of the purpose of the cash after 10 days. After 20 days you will receive a household visit from Min Ila Pilot officers to help guide you to additional support to keep your children in school." %}
                    </p>
                    <p>
                        {% trans "If Pilot Officers are unable to locate you by household visit after 3 attempts within a 2 month time period, you will stop receiving payments." %}
                    </p>
                    </li>
             {# 13 Declaration #}
                <li class="framebox">
                    <h3 class="panel-title">{% trans "Declaration and Consent" %}</h3>
                    <p>
                        {% trans "Please indicate that you understand the above as it has been read to you and that you consent to be contacted by telephone and by household visit by officers of the program by signing below. Those knowingly providing false information or committing fraud against the program will be removed from the pilot." %}
                    </p>
                    <p>
                        {% trans "By signing this agreement you also consent to allow us to share the data collected today with UNHCR and WFP in order to help ensure that you are paid. Some data will also be shared with the Ministry of Education and Higher Education (MEHE). We will ensure that your data is handled carefully and confidentially. If you have any questions please ask them before signing." %}
                    </p>
                </li>

                {# 14 Signature #}
                <li class="framebox">
                    <h3 class="panel-title">{% trans "Signature of Household Representative" %}</h3>
                        <div class="alert alert-error" role="alert" id="alert-signature-error" style="display: none;">
                            {% trans "Signature is empty" %}
                        </div>
                        <div style="display: none;">
                            {{ form.signature }}
                        </div>
                      <div id="signature-pad" class="m-signature-pad">
                        <div class="m-signature-pad--body">
                            <canvas width="600" height="300" style="touch-action: none;"></canvas>
                        </div>
                        <div class="m-signature-pad--footer">
                            <button type="button" class="btn btn-warning" data-action="clear">
                                <i class="icon-clear-sign icon-white"></i>{% trans "Clear" %}
                            </button>
                            <button type="button" class="btn btn-success" data-action="save">
                                <i class="icon-validation-sign icon-white"></i>{% trans "Confirm" %}
                            </button>
                        </div>
                      </div>
                </li>

                {# 15 Contact information #}
                <li class="framebox">
                    <h3 class="panel-title">{% trans "Contact Information" %}</h3>
                    <p>
                        {% trans "To benefit from the cash pilot, you must provide us with an address where carefully selected, trained officers who work for the pilot can visit your household and a phone number where we can reach you. These officers will be trained to handle your information carefully and will only visit you if a child you have registered drops out of school." %}
                    </p>
                    <p>
                        <strong>{% trans "If you change your phone number or address, please inform the program by calling 81-313940, or you will be removed after we are unable to locate you." %}</strong>
                    </p>
                    <div class="line">
                        <label class="text">{% trans "Address" %}<span class="asterisque">*</span></label>
                        {{ form.address }}
                        <span class="error" id="address_error">{% trans "This field is required" %}</span>
                    </div>
                    <div class="line">
                        <label class="text">{% trans "Primary Phone Number" %}<span class="asterisque">*</span></label>
                        {{ form.primary_phone }}
                        <span class="error" id="primary_phone_error">{% trans "This field is required" %}</span>
                        <span class="error" id="primary_phone_length_error">{% trans "The phone number must be 8 digits" %}</span>
                    </div>
                    <div class="line">
                        <label class="text">{% trans "Phone Number are normally answered by" %}<span class="asterisque">*</span></label>
                        {{ form.primary_phone_answered }}
                        <span class="error" id="primary_phone_answered_error">{% trans "This field is required" %}</span>
                    </div>
                    <div class="line">
                        <label class="text">{% trans "Secondary Phone Number" %}</label>
                        {{ form.secondary_phone }}
                        <span class="error" id="secondary_phone_length_error">{% trans "The phone number must be 8 digits" %}</span>
                    </div>
                    <div class="line">
                        <label class="text">{% trans "Phone Number are normally answered by" %}</label>
                        {{ form.secondary_phone_answered }}
                    </div>
                    <div class="line">
                        <label class="text">&nbsp;</label>
                        <button class="btn btn-success" type="button" id="registration_save">{% trans "Submit this application" %}</button>
                    </div>
                </li>

            </ul>
        </div>

        <ul class="pages" id="slySlider">
            <li class="active">1</li>
            <li>2</li>
            <li>3</li>
            <li>4</li>
            <li>5</li>
            <li>6</li>
            <li>7</li>
            <li>8</li>
            <li>9</li>
            <li>10</li>
            <li>11</li>
            <li>12</li>
            <li>13</li>
            <li>14</li>
            <li>15</li>
        </ul>

        <div class="controls center">
        {% if LANGUAGE_CODE == 'ar-ar' %}

            <button class="btn btn-warning" type="button" id="cancelButton" style="float:left;">
                {% trans "Cancel registration" %}
            </button>

            <button class="btn btn-primary disabled" type="button" id="previousButton">
                <i class="icon-next-sign icon-white"></i> {% trans "previous" %}
            </button>
            <button class="btn btn-primary" type="button" id="nextButton">
                {% trans "next" %} <i class="icon-prev-sign icon-white"></i>
            </button>
        {% else %}

            <button class="btn btn-warning" type="button" id="cancelButton" style="float:right;">
                {% trans "Cancel registration" %}
            </button>

            <button class="btn btn-primary disabled" type="button" id="previousButton">
                <i class="icon-prev-sign icon-white"></i> {% trans "previous" %}
            </button>
            <button class="btn btn-primary" type="button" id="nextButton">
                {% trans "next" %} <i class="icon-next-sign icon-white"></i>
            </button>
        {% endif %}
        </div>

    </div>
</form>

    {% include 'registration-pilot/add_child.html' %}

{% endblock %}

{% block extra_js %}

    {% get_user_token request.user.id as user_token %}
    <script type="text/javascript" language="javascript" src="{% static 'js/jquery-1.12.3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/plugins.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/sly.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/signature_pad.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootbox.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/appcache.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/indexedDB.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/validator.js' %}"></script>
    <script type="text/javascript">
        var db = null;
        var language  = '{{ LANGUAGE_CODE }}';
        var user_id = {{ request.user.id }};
        var user_username = '{{ request.user.username }}';
        var user_email = '{{ request.user.email }}';
        var user_token = '{{ user_token }}';
        var $frame;
        var onePerFrameSly;
        var language  = '{{ LANGUAGE_CODE }}';
        var protocol = 'http://';
        {% if request.is_secure %}
            protocol = 'https://';
        {% endif %}
        var host = protocol+'{{ request.get_host }}';
        var checking_id_number_url = host+'/api/registrations-adult/';
        var synchro_path = host+'/api/registrations-adult/';
        var synchro_path_2 = host+'/api/registrations-child/';
        var arabic_fields = "#id_first_name, #id_last_name, #id_father_name, #id_mother_fullname";
        var numeric_fields = "#id_age, #id_primary_phone";
        var validation_mapping = new Array();
        validation_mapping['0'] = function() { return validateSection0() };
        validation_mapping['5'] = function() { return validateSection5() };
        validation_mapping['6'] = function() { return validateSection6() };
        validation_mapping['14'] = function() { return validateSection14() };


    $(document).ready(function() {
        onePerFrameSly = initializeSly($('#oneperframe'));
        initializeSignature();
        var callback = function(){ load_base_data(); };
        createDataStore('db_pilot_1', 1, 'registrations', true, callback);
        bootbox.addLocale(language, {
            OK : '{% trans "Ok" %}',
            CANCEL : '{% trans "Cancel" %}',
            CONFIRM : '{% trans "Confirm" %}'
        });
        bootbox.setLocale(language);

        setInterval(function(){
            if(navigator.onLine) {
                synchronize_data(false);
            }
        }, 3600000);

        $(document).on('blur', '#mainForm input, #mainForm select, #mainForm textarea', function(){
            update_item_store(parseInt($('#main_id').val()), $(this).attr('name'), $(this).val(), 'registrations');
        });

        $(document).on('blur', arabic_fields, function(){
                checkArabicOnly($(this));
        });

        $(document).on('blur', numeric_fields, function(){
            checkIsNumber($(this));
        });


        $(document).on('change', '.bootbox-body #id_enrolled_last_year_location', function(){
            console.log($(this).val());
            filterSchoolsByLocation(parseInt($(this).val()));
        });
        $(document).on('change', '.bootbox-body #id_age', function(){
            var age = $(this).val();
            if(age < 5 || age > 17 ) {
                <!--bootbox.alert("{% trans 'The child is not within the eligible age for the Pilot.' %}", function() {});-->
                $('.bootbox-body').find("#age_range_error").show();
            }else {
            $('.bootbox-body').find("#age_range_error").hide();
            }
        });

        $(document).on('change', '.bootbox-body #id_birthday_day, .bootbox-body #id_birthday_month, .bootbox-body #id_birthday_year', function () {
            calculate_child_dob();
        });

        $('#id_id_number').bind("cut copy paste",function(e) {
            e.preventDefault();
        });
        $('#id_number_duplicate').bind("cut copy paste",function(e) {
            e.preventDefault();
        });

        $('#registration_save').click(function(e){
            var sectionCheck = validateSection14();
            if(sectionCheck)
            {

                bootbox.confirm("{% trans 'Are you sure you want to submit this application?' %}", function(result) {
                if(result == true) {
                    var store = getStoreByName('registrations');
                    var request = store.get(parseInt($('#main_id').val()));
                    request.onsuccess = function(){
                        var result = request.result;

                        console.log(result);
                        if(result){
                            push_adult_data(result, synchro_path, 'registrations');
                        }
                    };
                    update_item_store(parseInt($('#main_id').val()), 'completed', true, 'registrations');
                    displayFeedback();
                }
                });

            }
        });

         $('#getUNHCRDatatButton').click(function(e){
             $("#id_number_UNHCR_Other_error").hide();
             var isValid = true ;
             isValid = validateUNCHRFormat(isValid);
             if(isValid)
             {
                 $("#no_id_table").find("tr:gt(0)").remove();
                 $.ajax({
                     type: "GET",
                     url: checking_id_number_url+$('#id_id_number').val(),
                     data: [],
                     cache: false,
                     async: false,
                     headers: getHeader(),
                     dataType: 'json',
                     success: function (response) {
                         var household = response;
                         update_item_store(parseInt($('#main_id').val()), "original_id", household.id, 'registrations');
                         $('#id_first_name').val(household.first_name);
                         $('#id_last_name').val(household.last_name);
                         $('#id_father_name').val(household.father_name);
                         $('#id_mother_fullname').val(household.mother_fullname);
                         $('#id_birthday_day').val(household.birthday_day);
                         $('#id_birthday_month').val(household.birthday_month);
                         $('#id_birthday_year').val(household.birthday_year);
                         calculatehousehold_DateOfBirth();
                         $('#id_sex').val(household.sex);
                         $('#id_address').val(household.address);
                         $('#id_primary_phone').val(household.primary_phone);
                         $('#id_primary_phone_answered').val(household.primary_phone_answered);
                         $('#id_secondary_phone').val(household.secondary_phone);
                         $('#id_secondary_phone_answered').val(household.secondary_phone_answered);
                         $('#id_first_name, #id_last_name, #id_father_name, #id_mother_fullname, #id_birthday_day, #id_birthday_month, #id_birthday_year, #id_sex').trigger('blur');
                         $('#id_address, #id_primary_phone, #id_primary_phone_answered, #id_secondary_phone, #id_secondary_phone_answered').trigger('blur');

                         for(childIndex in household.children)
                         {
                             addChild(household.children[childIndex]);
                             console.log(household.children[childIndex]);
                         }

                     },
                     error: function (response) {
                        var required_fields = JSON.parse(response.responseText);
                        console.log(response);
                     }
                 });
             }
             else
             {
             }


        });

         $('#get_household_children_data_button').click(function(e){
             $("#no_id_table").find("tr:gt(0)").remove();
                $.ajax({
                     type: "GET",
                     url: checking_id_number_url+$('#id_previously_registered_number').val(),
                     data: [],
                     cache: false,
                     async: false,
                     headers: getHeader(),
                     dataType: 'json',
                     success: function (response) {
                         var household = response;
                         update_item_store(parseInt($('#main_id').val()), "original_id", household.id, 'registrations');

                         $('#id_id_number').val($('#id_previously_registered_number').val());
                         $('#id_first_name').val(household.first_name);
                         $('#id_last_name').val(household.last_name);
                         $('#id_father_name').val(household.father_name);
                         $('#id_mother_fullname').val(household.mother_fullname);
                         $('#id_birthday_day').val(household.birthday_day);
                         $('#id_birthday_month').val(household.birthday_month);
                         $('#id_birthday_year').val(household.birthday_year);
                         calculatehousehold_DateOfBirth();
                         $('#id_sex').val(household.sex);
                         $('#id_address').val(household.address);
                         $('#id_primary_phone').val(household.primary_phone);
                         $('#id_primary_phone_answered').val(household.primary_phone_answered);
                         $('#id_secondary_phone').val(household.secondary_phone);
                         $('#id_secondary_phone_answered').val(household.secondary_phone_answered);
                         $('#id_first_name, #id_last_name, #id_father_name, #id_mother_fullname, #id_birthday_day, #id_birthday_month, #id_birthday_year, #id_sex').trigger('blur');
                         $('#id_address, #id_primary_phone, #id_primary_phone_answered, #id_secondary_phone, #id_secondary_phone_answered').trigger('blur');

                         for(childIndex in household.children)
                         {
                             addChild(household.children[childIndex]);
                             console.log(household.children[childIndex]);
                         }

                     },
                     error: function (response) {
                        var required_fields = JSON.parse(response.responseText);
                        console.log(response);
                     }
                 });
        });

        $(document).on('click', '#registration-synchro', function(){
            synchronize_data('registrations', synchro_path);
        });

        $("#id_id_type").change(function () {
            hideAll();
            var selectedOption = $(this).val();
           if(selectedOption == 1) {
               $("#HouseholdUNHCR").show();
               $("#HouseholdUNHCRNote").show();
               $("#Household_block").show();
               $("#HouseholdRegistrationNumber").show();
               $("#HouseholdRegistrationNumber_confirm").show();
{#               $("#getUNHCRDatatButton").show();#}
           }else if (selectedOption == 2 )  {
               $("#Household_block").show();
               $("#HouseholdOtherID").show();
               $("#HouseholdOtherID_confirm").show();
               $("#HouseholdOtherID_Note").show();
               $("#HouseholdInformation").show();
               $("#HouseholdRegistrationNumber").hide();
               $("#HouseholdRegistrationNumber_confirm").hide();
               $("#IndividualRegistrationNumber").hide();
           }else if ( selectedOption == 3 || selectedOption == 4|| selectedOption == 5)  {
               $("#Household_block").show();
               $("#HouseholdOtherID").show();
               $("#HouseholdOtherID_confirm").show();
               $("#HouseholdOtherID_Note").show();
               $("#HouseholdInformation").show();
               $("#household_visit_note").show();
               $("#HouseholdRegistrationNumber").hide();
               $("#HouseholdRegistrationNumber_confirm").hide();
               $("#IndividualRegistrationNumber").hide();

           }else if (selectedOption == 6) {
               $("#HouseholdInformation").show();
               $("#Household_block").hide();
               bootbox.alert("{% trans 'Please let the household know that we are currently not able to provide payments to those without ID. However, please offer them the option to complete data collection so that we can try to include them later once we develop a solution for them.' %}", function() {});
           }
        });

        $('input[name=principal_applicant_living_in_house]').click(function(){
            var PrincipalHouseHoldCBChecked = $(this).val();
            if(PrincipalHouseHoldCBChecked==1) {
            $("#Individual_block").hide();
            } else {
            $("#Individual_block").show();
            }
        });

        $('input[name=child_enrolled_in_other_schools]').click(function(){
            if($(this).val() == 1){
                $('#registration_status_block').show();
                $('#no_id_block').hide();
                $('#with_id_block').hide();
                $('#confirm_child_belong').hide();
            }else{
                $('#registration_status_block').hide();
                $('#previously_registered_block').hide();
                $('#previously_registered_error').hide();
                $('#id_number_block').hide();
                $('#no_id_block').show();
                $('#confirm_child_belong').show();
            }
        });

        $('input[name=previously_registered_status]').click(function(){
            if($(this).val() == 1){
                $('#previously_registered_block').show();
                $('#confirm_child_belong').hide();
                $('#no_id_block').hide();
                $('#with_id_block').hide();
            }else{
                $('#previously_registered_block').hide();
                $('#previously_registered_error').hide();
                $('#id_number_block').hide();
                $('#no_id_block').show();
                $('#confirm_child_belong').show();
            }
        });

        $('input[name=previously_registered]').click(function(){
            if($(this).val() == 1){
                $('#previously_registered_error').hide();
                $('#id_number_block').show();
                $('#no_id_block').show();
            }else{
                $('#previously_registered_error').show();
                $('#id_number_block').hide();
                $('#no_id_block').hide();
            }
        });

        $(document).on('click', '.delete-registration-child-row', function(){
            var block = $(this);
            bootbox.confirm("{% trans 'Are you sure you want to delete this child?' %}", function(result) {
                if(result == true) {
                    $('#child-'+block.attr('itemid')).remove();
                    $('.children_table').find('tr.child-row').each(function(i, item){
                        $(this).attr('id', 'child-'+(i+1));
                    });
                    $('.children_table').find('.delete-registration-child-row').each(function(i, item){
                        $(this).attr('itemid', i+1);
                    });
                    delete_subitem_store(parseInt($('#main_id').val()), 'children', block.attr('itemid'), 'registrations');
                }
            });
        });

        $(document).on('click', '.edit-registration-child-row', function(){
            var block = $(this).parent().parent().find(".delete-registration-child-row");

            var templateChildForm = $("#add_child_noid_block").find('#add_child_noid_form');

            var isSaved = false;
            bootbox.dialog({
                            title: "{% trans "Add Child" %}",
                            message: $('#add_child_noid_block').html(),
                            buttons: {
                                success: {
                                    label: "{% trans "Save" %}",
                                    className: "btn-success",
                                    callback: function () {
                                        var reslt = validate_add_child_noid();
                                        if (reslt)
                                        {

                                            var tr = $('<tr>');
                                            var form = $('.bootbox-body').find('#add_child_noid_form');
                                            tr.append($('<td>').html(form.find('#id_school').find(':selected').text()));
{#                                            tr.append($('<td>').html('&nbsp;'));#}
                                            tr.append($('<td>').html(form.find('#id_id_number').val()));
                                            tr.append($('<td>').html(form.find('#id_first_name').val()+' '+ form.find('#id_father_name').val()+' '+form.find('#id_last_name').val()));
                                            tr.append($('<td>').html(form.find('#id_mother_fullname').val()));
{#                                            tr.append($('<td>').html(form.find('#id_birthday_day').find(':selected').text()+'/'+form.find('#id_birthday_month').find(':selected').text()+'/'+form.find('#id_birthday_year').find(':selected').text()));#}
                                            tr.append($('<td>').html(form.find('#id_age').val()));
                                            tr.append($('<td>').html(form.find('#id_relation_to_adult').find(':selected').text()));
                                            tr.append($('<td>').html(form.find('#id_enrolled_last_year').find(':selected').text()));

                                            var editedIndex = block.attr('itemid');

                                            var button = $('<button class="btn btn-danger delete-registration-child-row" type="button" itemid="'+editedIndex+'"><i class="icon-trash icon-white"></i></button>');
                                            tr.append($('<td>').html(button));

                                            var editButton = $('<button class="btn edit-registration-child-row" type="button" ><i class="icon-edit icon-white"></i></button>');
                                            tr.append($('<td>').html(editButton));

                                            tr.attr('id', 'child-'+editedIndex);

                                            $('#no_id_table').find('tbody').find('#child-'+editedIndex).replaceWith(tr);

                                            var updateCallback = function(updateItem)
                                            {
                                                collect_form_values(form, updateItem);
                                                update_subitem_store(parseInt($('#main_id').val()), 'children', editedIndex, 'registrations', updateItem);
                                            };

                                            get_subitem_store(parseInt($('#main_id').val()), 'children', block.attr('itemid'), 'registrations', updateCallback);

                                        } else {
                                            return false;
                                        }
                                    }
                                },
                                cancel: {
                                    label: "{% trans "Cancel" %}",
                                    className: "btn-default",
                                    callback: function () {
                                        bootbox.hideAll();
                                    }
                                }
                            }
            });

            //$(".bootbox-body").find('#id_school').val($('#mainForm').find("#id_school").val());

            var updateCallback = function(updateItem)
            {
                var editForm = $('.bootbox-body').find('#add_child_noid_form');
                update_form_values(editForm, updateItem);
            };

            get_subitem_store(parseInt($('#main_id').val()), 'children', block.attr('itemid'), 'registrations', updateCallback);

        });

        $(document).on('click', '.edit-UNHCR-registration-child-row', function(){
            var block = $(this).parent().parent().find(".delete-registration-child-row");

            var templateChildForm = $("#add_child_withid_block").find('#add_child_withid_form');

            var isSaved = false;

            bootbox.dialog({
                            title: "{% trans "Add Child" %}",
                            message: $('#add_child_withid_block').html(),
                            buttons: {
                                success: {
                                    label: "{% trans "Save" %}",
                                    className: "btn-success",
                                    callback: function () {
                                        var reslt = validate_add_child_withid();
                                        if (reslt)
                                        {
                                            var tr = $('<tr>').addClass('child-row');
                                            var form = $('.bootbox-body').find('#add_child_withid_form');
                                            tr.append($('<td>').html(form.find('#id_school').find(':selected').text()));
                                            tr.append($('<td>').html(form.find('#id_id_number').val()));
                                            tr.append($('<td>').html(form.find('#id_relation_to_adult').find(':selected').text()));
                                            tr.append($('<td>').html(form.find('#id_enrolled_last_year').find(':selected').text()));

                                            var editedIndex = block.attr('itemid');

                                            var button = $('<button class="btn btn-danger delete-registration-child-row" type="button" itemid="'+editedIndex+'"><i class="icon-trash icon-white"></i></button>');
                                            tr.append($('<td>').html(button));

                                            var editButton = $('<button class="btn edit-UNHCR-registration-child-row" type="button" ><i class="icon-edit icon-white"></i></button>');
                                            tr.append($('<td>').html(editButton));

                                            tr.attr('id', 'child-'+editedIndex);

                                            $('#with_id_table').find('tbody').find('#child-'+editedIndex).replaceWith(tr);

                                            var updateCallback = function(updateItem)
                                            {
                                                collect_form_values(form, updateItem);
                                                update_subitem_store(parseInt($('#main_id').val()), 'children', editedIndex, 'registrations', updateItem);
                                            };

                                            get_subitem_store(parseInt($('#main_id').val()), 'children', block.attr('itemid'), 'registrations', updateCallback);

                                        } else {
                                            return false;
                                        }
                                    }
                                },
                                cancel: {
                                    label: "{% trans "Cancel" %}",
                                    className: "btn-default",
                                    callback: function () {
                                        bootbox.hideAll();
                                    }
                                }
                            }
            });

            //$(".bootbox-body").find('#id_school').val($('#mainForm').find("#id_school").val());

            var updateCallback = function(updateItem)
            {
                var editForm = $('.bootbox-body').find('#add_child_withid_form');
                update_form_values(editForm, updateItem);
            };

            get_subitem_store(parseInt($('#main_id').val()), 'children', block.attr('itemid'), 'registrations', updateCallback);

        });

        $('#add_child_noid').click(function(){

            var templateChildForm = $("#add_child_noid_block").find('#add_child_noid_form');

            var isSaved = false;

            bootbox.dialog({
                            title: "{% trans "Add Child" %}",
                            message: $('#add_child_noid_block').html(),
                            buttons: {
                                success: {
                                    label: "{% trans "Save" %}",
                                    className: "btn-success",
                                    callback: function () {
                                        var reslt = validate_add_child_noid();
                                        if (reslt)
                                        {
                                            var tr = $('<tr>').addClass('child-row');
                                            var form = $('.bootbox-body').find('#add_child_noid_form');
                                            tr.append($('<td>').html(form.find('#id_school').find(':selected').text()));
{#                                            tr.append($('<td>').html('&nbsp;'));#}
                                            tr.append($('<td>').html(form.find('#id_id_number').val()));
                                            tr.append($('<td>').html(form.find('#id_first_name').val()+' '+ form.find('#id_father_name').val()+' '+form.find('#id_last_name').val()));
                                            tr.append($('<td>').html(form.find('#id_mother_fullname').val()));
{#                                            tr.append($('<td>').html(form.find('#id_birthday_day').find(':selected').text()+'/'+form.find('#id_birthday_month').find(':selected').text()+'/'+form.find('#id_birthday_year').find(':selected').text()));#}
                                            tr.append($('<td>').html(form.find('#id_age').val()));
                                            tr.append($('<td>').html(form.find('#id_relation_to_adult').find(':selected').text()));
                                            tr.append($('<td>').html(form.find('#id_enrolled_last_year').find(':selected').text()));
                                            var button = $('<button class="btn btn-danger delete-registration-child-row" type="button" itemid=""><i class="icon-trash icon-white"></i></button>');
                                            tr.append($('<td>').html(button));

                                            var editButton = $('<button class="btn edit-registration-child-row" type="button"><i class="icon-edit icon-white"></i></button>');
                                            tr.append($('<td>').html(editButton));

                                            $('#no_id_table').find('tbody').append(tr);

                                            var item  = {};
                                            item = collect_form_values(form, item);
                                            item.owner= user_id;
                                            var year = new Date().getFullYear();
                                            if(!item.birthday_day) {
                                                item.birthday_day = 1;
                                            }
                                            if(!item.birthday_month){
                                                item.birthday_month = 1;
                                            }
                                            if(!item.birthday_year){
                                                item.birthday_year = year - parseInt(item.age);
                                            }
                                            if(!item.id_number){
                                                item.id_number = '00000';
                                            }
                                            var callback = function(index){
                                                button.attr('itemid', index);
                                                editButton.attr('itemid', index);
                                                tr.attr('id', 'child-'+index);
                                            };
                                            append_item_store(parseInt($('#main_id').val()), 'children', item, 'registrations', callback);

                                            if(!isSaved)
                                            {
                                                form.find("#id_father_name").each(function() {
                                                    $(this).attr("value", $(this).val());
                                                });
                                                form.find("#id_last_name").each(function() {
                                                    $(this).attr("value", $(this).val());
                                                });
                                                form.find("#id_mother_fullname").each(function() {
                                                    $(this).attr("value", $(this).val());
                                                });
                                                templateChildForm.html(form.html());
                                                isSaved = true;
                                            }
                                        } else {
                                            return false;
                                        }
                                    }
                                },
                                cancel: {
                                    label: "{% trans "Cancel" %}",
                                    className: "btn-default",
                                    callback: function () {
                                        bootbox.hideAll();
                                    }
                                }
                            }
            });

            $(".bootbox-body").find('#id_school').val($('#mainForm').find("#id_school").val());
        });

        $('#add_child_withid').click(function(){

            bootbox.dialog({
                            title: "{% trans "Add Child" %}",
                            message: $('#add_child_withid_block').html(),
                            buttons: {
                                success: {
                                    label: "{% trans "Save" %}",
                                    className: "btn-success",
                                    callback: function () {
                                        var reslt = validate_add_child_withid();
                                        if (reslt) {
                                            var tr = $('<tr>').addClass('child-row');
                                            var form = $('.bootbox-body').find('#add_child_withid_form');
                                            tr.append($('<td>').html(form.find('#id_school').find(':selected').text()));
                                            tr.append($('<td>').html(form.find('#id_id_number').val()));
                                            tr.append($('<td>').html(form.find('#id_relation_to_adult').find(':selected').text()));
                                            tr.append($('<td>').html(form.find('#id_enrolled_last_year').find(':selected').text()));
                                            var button = $('<button class="btn btn-danger delete-registration-child-row" type="button" itemid=""><i class="icon-trash icon-white"></i></button>')
                                            tr.append($('<td>').html(button));
                                            var editButton = $('<button class="btn edit-UNHCR-registration-child-row" type="button"><i class="icon-edit icon-white"></i></button>');
                                            tr.append($('<td>').html(editButton));
                                            $('#with_id_table').find('tbody').append(tr);

                                            var item  = {};
                                            item = collect_form_values(form, item);
                                            if(!item.id_number){
                                                item.id_number = '00000';
                                            }
                                            item.first_name = 'Unknown';
                                            item.father_name = 'Unknown';
                                            item.last_name = 'Unknown';
                                            item.mother_fullname = 'Unknown';
                                            item.sex = 'Male';
                                            var year = new Date().getFullYear();
                                            item.age = 1;
                                            item.birthday_day = 1;
                                            item.birthday_month = 1;
                                            item.birthday_year = year - parseInt(item.age);
                                            item.owner = user_id;
                                            var callback = function(index){
                                                button.attr('itemid', index);
{#                                                editButton.attr('itemid', index);#}
                                                tr.attr('id', 'child-'+index);
                                            };
                                            append_item_store(parseInt($('#main_id').val()), 'children', item, 'registrations', callback);
                                        } else {
                                            return false;
                                        }
                                    }
                                },
                                cancel: {
                                    label: "{% trans "Cancel" %}",
                                    className: "btn-default",
                                    callback: function () {
                                        bootbox.hideAll();
                                    }
                                }
                            }
            });

            $(".bootbox-body").find('#id_school').val($('#mainForm').find("#id_school").val());
        });

        $(document).on('change', '.bootbox-body #id_enrolled_last_year', function(){

            if($(this).val() == "no") {
                $('.bootbox-body').find("#enrolled_in_school_location").hide();
            }else {
                $('.bootbox-body').find("#enrolled_in_school_location").show();
            }
        });
        $("#id_birthday_day, #id_birthday_month, #id_birthday_year").change(function () {
            calculatehousehold_DateOfBirth();
        });

        $("#id_age").blur(function () {
            if($('#id_age').val() < 18 && $('#id_age').val() >0) {
                bootbox.alert("{% trans 'Currently ATM Cards can only be issued for those over the age of 18. We are working on a solution for this. You can continue the Registration Process so we have your information in case a solution is found. However, until then you will not receive payments.' %}", function() {});
            }
        });

        $("#cancelButton").click(function() {
            bootbox.confirm("{% trans 'Are you sure you want to cancel this registration?' %}", function(result) {
                if(result == true) {
                    $('#mainForm').remove();
                    $('#alert-cancel-success').show();
                }
            });
        });

        $("#previousButton").click(function() {
            if(!$("#previousButton").hasClass("disabled")) {
               onePerFrameSly.prev();
            }
        });

        $("#nextButton").click(function()
        {
            if(!$("#nextButton").hasClass("disabled"))
            {
                var sectionCheck = validateSection(onePerFrameSly, onePerFrameSly.rel.activeItem);

                if(sectionCheck)
                {
                    if(onePerFrameSly.rel.activeItem == 9)
                    {
                       var rowCount = $("#no_id_table td").closest("tr").length;
                        if(rowCount >0)
                        {
                          //var check1 = $('.child_enrolled_in_other_schools_block').find('a.active').attr('data-title');
                          //var check2 = $('.previously_registered_status_block').find('a.active').attr('data-title');

                              //if(check1 == 0 || (check1 == 1 && check2 == 0)) {
                                  bootbox.confirm("{% trans 'Are all the children enrolled in the 2nd shift schools have been registered?' %}", function(result) {
                                      if(result == true) {
                                         onePerFrameSly.next();
                                      }
                                  });
                              //}else {
                              //    onePerFrameSly.next();
                              //}
                        }
                    }else {
                        onePerFrameSly.next();
                    }
                }
            }
        });

        onePerFrameSly.on('active', function(eventName, itemIndex) {
            if(onePerFrameSly.rel.activeItem == 0) {
                $("#previousButton").addClass("disabled");
            } else {
                $("#previousButton").removeClass("disabled");
            }

            if (onePerFrameSly.rel.activeItem == 6) {
                $("#id_id_type").prop("disabled", "disabled");
            } else {
                //$("#id_id_type").prop("disabled", false);
            }
            if(onePerFrameSly.rel.activeItem == onePerFrameSly.items.length-1) {
                $("#nextButton").addClass("disabled");
            } else {
                $("#nextButton").removeClass("disabled");
            }
        });

        $("#slySlider").find("li").click(function() {
            return false;
        });
    });

    function addChild(child)
    {
        var tr = $('<tr>').addClass('child-row');
        tr.append($('<td>').html(child.school_name));
        tr.append($('<td>').html(child.id_number));
        tr.append($('<td>').html(child.first_name+' '+ child.father_name+' '+child.last_name));
        tr.append($('<td>').html(child.mother_fullname));
        tr.append($('<td>').html(child.age));
        tr.append($('<td>').html(child.relation_to_adult));
        tr.append($('<td>').html(child.enrolled_last_year));
        var button = $('<button class="btn btn-danger delete-registration-child-row" type="button" itemid="" style = "display:none"><i class="icon-trash icon-white"></i></button>')
        tr.append($('<td>').html(button));
        var editButton = $('<button class="btn edit-UNHCR-registration-child-row" type="button" style = "display:none"><i class="icon-edit icon-white"></i></button>');
        tr.append($('<td>').html(editButton));
        $('#no_id_table').find('tbody').append(tr);
        var item  = {};
        item.id_school = child.school
        if(!item.id_number){
            item.id_number = '00000';
        }
        item.firs_name = 'Unknown';
        item.father_name = 'Unknown';
        item.last_name = 'Unknown';
        item.mother_fullname = 'Unknown';
        item.sex = 'Male';
        var year = new Date().getFullYear();
        item.age = 1;
        item.birthday_day = 1;
        item.birthday_month = 1;
        item.birthday_year = year - parseInt(item.age);
        item.owner = user_id;
        var callback = function(index){
            button.attr('itemid', index);
            tr.attr('id', 'child-'+index);
        };
{#        append_item_store(parseInt($('#main_id').val()), 'children', item, 'registrations', callback);#}
    }

    function updateDropDownValue(dropDownElement, value)
    {
        dropDownElement.find('option:selected').removeAttr('selected');
        dropDownElement.find('option[value="'+value+'"]').attr("selected",true);
        dropDownElement.val(value);
    }

    function getDropDownValueText(dropDownElement, value)
    {
        return dropDownElement.find('option[value="'+value+'"]').text();
    }


    function displayFeedback()
    {
        $('#mainForm').remove();
        $('#alert-synchro-success').show();
    }

    function load_base_data()
    {
        pull_data_from_server(host+'/api/schools/', 'schools');
    }

    function filterSchoolsByLocation(location)
    {
        $('.bootbox-body').find('#id_enrolled_last_year_school').find('option').hide();
        var store = getStoreByName('schools');
        var request = store.index('location').getAll(location);
        request.onsuccess = function() {
            var result = request.result;
            if(result){
                $(result).each(function(i, item){
                    $('.bootbox-body').find('#id_enrolled_last_year_school').find('option[value='+item.id+']').show();
                });
            }
        }
    }

    function hideAll()
    {
        $("#HouseholdUNHCR").hide();
        $("#HouseholdUNHCRNote").hide();
        $("#HouseholdOtherID").hide();
        $("#HouseholdOtherID_confirm").hide();
        $("#HouseholdOtherID_Note").hide();
        $("#HouseholdInformation").hide();
        $("#HouseholdRegistrationNumber").hide();
        $("#HouseholdRegistrationNumber_confirm").hide();
        $("#IndividualRegistrationNumber").hide();
        $("#household_visit_note").hide();
        $("#getUNHCRDatatButton").hide();
        $("#Individual_block").hide();
        }

    function calculatehousehold_DateOfBirth()
    {
        var birthday_day = $('#id_birthday_day').val();
        var birthday_month = $('#id_birthday_month').val();
        var birthday_year = $('#id_birthday_year').val();
        var age = getCalculatedAge(birthday_day, birthday_month, birthday_year);

        if(age!=null) {
            $('#id_age').val(age);
            $('#id_age').trigger('blur');
        } else {
            $('#id_age').val("");
        }
    }

    function calculate_child_dob()
    {
        var birthday_day = $('.bootbox-body').find("#id_birthday_day").val();
        var birthday_month = $('.bootbox-body').find("#id_birthday_month").val();
        var birthday_year = $('.bootbox-body').find("#id_birthday_year").val();
        var age = getCalculatedAge(birthday_day, birthday_month, birthday_year);

        if(age!=null) {

            $('.bootbox-body').find("#id_age").val(age);
            $('.bootbox-body').find("#id_age").trigger('blur');

            if(age < 5 || age > 17) {
               <!--bootbox.alert("{% trans 'The child is not within the eligible age for the Pilot.' %}", function() {});-->
               $('.bootbox-body').find("#age_range_error").show();
            }
            else{
            $('.bootbox-body').find("#age_range_error").hide();
            }
        } else {
            $('.bootbox-body').find("#id_age").val("");
            $('.bootbox-body').find("#age_range_error").hide();
        }
    }

    function getCalculatedAge(birthday_day ,birthday_month, birthday_year)
    {
        var age = null;

{#        var birthday_day = $('#id_birthday_day').val();#}
{#        var birthday_month = $('#id_birthday_month').val()-1;#}
{#        var birthday_year = $('#id_birthday_year').val();#}

        var birthDate = new Date(birthday_year, birthday_month, birthday_day);

        if(birthday_day != "" && birthday_month != "" && birthday_year != "" ) {
            age = calculateAge(birthDate,new Date());
        }

        return age;
    }

    function calculateAge(dateOfBirth, dateToCalculate) {
        var calculateYear = dateToCalculate.getFullYear();
        var calculateMonth = dateToCalculate.getMonth();
        var calculateDay = dateToCalculate.getDate();

        var birthYear = dateOfBirth.getFullYear();
        var birthMonth = dateOfBirth.getMonth();
        var birthDay = dateOfBirth.getDate();

        var age = calculateYear - birthYear;
        var ageMonth = calculateMonth - birthMonth;
        var ageDay = calculateDay - birthDay;

        if (ageMonth < 0 || (ageMonth == 0 && ageDay < 0)) {
            age = parseInt(age) - 1;
        }

        return age;
    }

    function synchronize_data(store_name, url, callback)
    {
        var store = getStoreByName(store_name);
        var request = store.getAll();
        request.onsuccess = function() {
            var result = request.result;
            $(result).each(function(i, item){
                if(item.synchronized == false && item.completed == true) {
                    push_adult_data(item, url, store_name);
                }
{#                if(item.synchronized == true || (item.synchronized == false && item.completed == false)){#}
{#                    delete_from_store(parseInt(item.id), store_name, true);#}
{#                }#}
            });
            if(callback){
                callback();
            }
        };
    }

    function push_adult_data(item, url, store_name)
    {
        //var formID = item.id;
        //item.id=item.update_id;
        //item.id_registration=item.update_id;
        {#            url: url + (item.update_id != null ? item.update_id+"/" : ""),      #}
        $.ajax({
            type: item.original_id != null ? "PUT":"POST",
            url: url + (item.original_id != null ? item.id_number+"/" : ""),
            data: item,
            cache: false,
            async: false,
            headers: getHeader(),
            dataType: 'json',
            success: function (response) {
{#                if(response.status == '201' || response.status == 201){#}
                if(response.id){
                    update_item_store(parseInt(item.id), 'synchronized', true, store_name);
                    $(item.children).each(function(i, child){
                        child.registering_adult = response.id;
                        push_child_data(child);
                    });
                }
            },
            error: function (response) {
                console.log(response);
            }
        });
    }

    function push_child_data(item)
    {
        $.ajax({
            type: "POST",
            url: synchro_path_2,
            data: item,
            cache: false,
            async: false,
            headers: getHeader(),
            dataType: 'json',
            success: function (response) {
                if(response.status == '201' || response.status == 201){

                }
            },
            error: function (response) {
                console.log(response);
            }
        });
    }


    </script>

{% endblock %}
