{% extends "base.html" %}
{% load staticfiles i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% load util_tags %}

{% block extra_head %}
  <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-breadcrumbs.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/jquery.dataTables.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/buttons.dataTables.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/select.dataTables.min.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/sly.css' %}"
          xmlns:font-weight="http://www.w3.org/1999/xhtml" xmlns:font-weight="http://www.w3.org/1999/xhtml">


    <style>
        .row-class {
            cursor: pointer;
        }
        .row-class:hover {
           background-color: gainsboro !IMPORTANT;
        }

        .child-row-class {
            cursor: pointer;
        }
        .child-row-class:hover {
           background-color: gainsboro !IMPORTANT;
        }

        .transparent-header
        {
           background-color: transparent !IMPORTANT;
           border: solid 0px transparent !IMPORTANT;
        }

    </style>

{% endblock %}


{% block content %}


         <div class="loader"></div>

         <section class="main-content-wrapper" id = "hhList">
            <section id="main-content">
                 <div class="row">
                    <div class="col-md-12">
                        </br>
                    </div>
                </div>
            <div class="row">

                <div class="alert alert-success" role="alert" style="display: none;">
                    <strong>{% trans 'Success' %}</strong> {% trans 'Your change is successfully Saved' %}
                </div>
                <div class="alert alert-warning" role="alert" style="display: none;">
                    <strong>{% trans 'Oops' %}</strong> {% trans 'Error saving changes, please contact system administrators' %}
                </div>

                    <div class="col-md-12">
                        <div class="panel panel-default">
                          <div class="panel-heading">
                            <h3 class="panel-title">
                                <ol class="breadcrumb">
                                  <li><a>{% trans "Household Update" %}</a></li>
                                  <li>

                                  </li>
                                </ol>
                            </h3>
                            <div class="actions pull-right">
                                <i class="fa fa-chevron-down"></i>
                                <i class="fa fa-times"></i>
                            </div>
                          </div>
                          <div class="panel-body">
                                <table id="registrations-table" class="table table-striped table-bordered cell-border"
                                       data-height="500"
                                       data-pagination="true"
                                       data-search="true"
                                       cellspacing="0"
                                       width="100%">
                                <thead>
                                    <tr id="thead-line-1">
                                        <th class = "transparent-header">
                                            <button class="btn btn-primary" type="button" id="notFoundButton" >
{#                                                style="visibility: hidden"#}
                                                Household Not Found
                                            </button>
                                        </th>
                                        <th class = "transparent-header"></th>
                                        <th class = "transparent-header"></th>
                                        <th class = "transparent-header"></th>
                                        <th class = "transparent-header">
                                            <button class="btn btn-primary" type="button" id="searchButton">
                                                Search
                                            </button>
                                        </th>
                                    </tr>

                                    <tr id="thead-line-1">
                                        <th class = "transparent-header">

                                            <select id="id_location">
                                              <option value="">---{% trans "Select District" %}---</option>
                                                {% for location in locations %}
                                                    <option value="{{ location.id }}" {% if selectedLocation == location.id %}selected="selected"{% endif %}>
                                                      {{ location }}
                                                    </option>
                                                {% endfor %}
                                            </select>

                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "repSearchText" value = "{{repSearchText}}" />
                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "idSearchText" value = "{{idSearchText}}" />
                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "primarySearchText" value = "{{primarySearchText}}" />
                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "secondarySearchText" value = "{{secondarySearchText}}" />
                                        </th>
                                    </tr>
                                    <tr id="thead-line-1">
                                        <th>{% trans "HH District" %}</th>
                                        <th>{% trans "Household Representative/PA Name" %}</th>
                                        <th>{% trans "ID Number" %}</th>
                                        <th>{% trans "Primary Phone" %}</th>
                                        <th>{% trans "Secondary Phone" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for adult in adults %}
                                        <tr class="row-class" adultID="{{ adult.id }}">
                                            <td>{{ adult.school.location.name }}</td>
                                            <td>{{ adult.adult_full_name }}</td>
                                            <td>{{ adult.id_number }}</td>
                                            <td>{{ adult.primary_phone }}</td>
                                            <td>{{ adult.secondary_phone }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                     </div>
                </div>
            </div>

            </section>
         </section>


     <div id = "hhEditForm" style ="display:none">

       {% include 'registration-pilot/registration-update.html' %}

     </div>

    <div id = "hhNotFoundForm" style ="display:none">
       {% include 'registration-pilot/household-not-found.html' %}
     </div>

{% endblock %}

{% block extra_js %}

    <script type="text/javascript" language="javascript" src="{% static 'js/jquery-1.12.3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/dataTables.bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/util.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/tooltip.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/plugins.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/sly.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootbox.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/date.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/registration-pilot/UI/SlyInitialisation.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/registration-pilot/Validation/validator.js' %}"></script>
    <script type="text/javascript">
        var oTable = null;
        var language  = '{{ LANGUAGE_CODE }}';
        var protocol = 'http://';
        {% if request.is_secure %}
            protocol = 'https://';
        {% endif %}
        var user_id = {{ request.user.id }};
        var complaint_hh_id = null;
        var host = protocol+'{{ request.get_host }}';
        var synchro_path = host+'/api/registry-search/';

        var checking_id_number_url = host+'/api/registrations-adult-id/';
        var childURL = host+'/api/registrations-child/';
        var complaintURL = host+'/api/registrations-complaint/';
        var missingchildURL = host+'/api/registrations-missingchild/';
        var notfoundURL = host+'/api/registrations-notfound/';
        var arabic_fields = "#first_name, #father_name, #last_name, #mother_full_name, #st_first_name, #st_father_name, #st_last_name, #st_mother_full_name ";


        var months = [
                'January', 'February', 'March', 'April', 'May',
                'June', 'July', 'August', 'September',
                'October', 'November', 'December'
            ];

        var hhID = null;
        var nfID = null;
        var mcID = null;
        var notFoundRecord = null;

        $(document).ready
        (
           function()
           {
               InitialiseDays('days', 1,31);
               InitialiseDays('complait_days', 1,31);
               InitialiseDays('nf_days', 1,31);
               InitialiseDays('st_days', 1,31);
               InitialiseDays('years',1930,2000);
               InitialiseDays('nf_years',1930,2000);
               InitialiseDays('st_years',1930,2000);
               InitialiseDays('complait_years',2017,2100);
               InitialiseDays('complait_hours',1,12);
               InitialiseDays('complait_minutes',1,60);
               InitialiseSave();
               InitialiseClose();
               InitialiseChildDropdown();
               InitialiseToggleRadioButtons();

              $(document).on
              (
                 'click',
                 '.row-class',
                 function()
                 {
                    block = $(this);
                    hhID = block.attr('adultID')
                    $("#hhList").hide();
                    $("#changeOption")[0].selectedIndex = 0;
                    LoadData(hhID);
                    hideAll();
                    $("#hhEditForm").show();
                    CheckInitialiseSly();

                 }
               );

              $(document).on('blur', arabic_fields, function(){
                  checkArabicOnly($(this));
              });

                // get the list of household and fill the table with it
               /*
                $("#id_location").change(function(){
                   var selected_location = $(this).val();
                   // reload the page with the location id passed in post
                    var url = '{% url "registrations:registry_search" %}';
                    if(selected_location){
                        url = url+'?location='+selected_location;
                    }
                    window.location.href = url;
                });
                */
                $("#notFoundButton").click(function(){
                    hideForms();
                    $("#hhNotFoundForm").show();
                });

                $("#searchButton").click(function(){
                    Search();
                });

                $("#repSearchText,#idSearchText,#primarySearchText,#secondarySearchText").keyup
                (
                    function(event)
                    {
                        if(event.keyCode == 13)
                        {
                            Search();
                        }
                    }
                );
                function hideForms()
                {
                    $("#hhList").hide();
                    $("#hhEditForm").hide();
                    $("#hhNotFoundForm").hide();
                }
                function Search()
                {
                   var selected_location = $("#id_location").val();
                   var repSearchText = $("#repSearchText").val();
                   var idSearchText = $("#idSearchText").val();
                   var primarySearchText = $("#primarySearchText").val();
                   var secondarySearchText = $("#secondarySearchText").val();
                   // reload the page with the location id passed in post

                    var url = '{% url "registrations:registry_search" %}';
                    if(selected_location){
                        url = url+'?location='+selected_location;
                        url = AddParameter(url,"repSearchText");
                        url = AddParameter(url,"idSearchText");
                        url = AddParameter(url,"primarySearchText");
                        url = AddParameter(url,"secondarySearchText");
                    }
                    else
                        {
                            url = url+'?repSearchText='+repSearchText;
                            url = AddParameter(url,"idSearchText");
                            url = AddParameter(url,"primarySearchText");
                            url = AddParameter(url,"secondarySearchText");
                        }
                        window.location.href = url;
                }

                function AddParameter( url, id)
                {
                   var parameterText = $("#"+id).val();
                   url = url+'&'+id+'='+parameterText;

                   return url;
                }

            function load_base_data()
              {
                  pull_data_from_server(host+'/api/schools/', 'schools');
              }

              $("#card_distribution_complaint").change(function () {
              var selectedOption = $(this).val();

              if(selectedOption == 12)
              {
                  bootbox.alert("Please update household phone number");
                  $("#cardPhoneFields").show();
              }
              else
                  {
                      $("#cardPhoneFields").hide();
                  }
              });

                $("#reason").change(function () {
                    var selectedOptionText =  $("#reason option:selected").text();
                    if(selectedOptionText == "Other (Specify)")
                    {
                        $("#beneficiary_reason").show();
                    }
                    else
                    {
                        $("#beneficiary_reason").hide();
                    }
                });

                $("#not_eligible_select").change(function () {
                    var selectedOptionText =  $("#not_eligible_select option:selected").text();
                    if(selectedOptionText == "Other (Specify)")
                    {
                        $("#not_eligible_specify_reason").show();
                    }
                    else
                    {
                        $("#not_eligible_specify_reason").hide();
                    }
                });

                $("#card_complaint").change(function () {

                    var selectedOptionText =  $("#card_complaint option:selected").text();
                    if(selectedOptionText == "Other")
                    {
                        $("#complaint_Other_type").show();
                    }
                    else
                    {
                        $("#complaint_Other_type").hide();
                    }
                });


            // get selected option to update and set the fields visible
            $("#changeOption").change(function () {
              hideAll();
              var selectedOption = $(this).val();

              if(selectedOption == 'phone') {
                $("#phoneFields").show();
                }
                else if (selectedOption =='address' )  {
                $("#addressFields").show();
                }
                else if (selectedOption == 'school_change' ) {
                  $("#schoolChangeFields").show();
                }
                else if (selectedOption == 'beneficiary' ) {
                  $("#beneficiaryFields").show();
                }
                else if (selectedOption == 'payment' ) {
                  $("#paymentFields").show();
                  $("#ComplaintFields").show();
                  $("#ComplaintHistory").show();
                }
                else if (selectedOption == 'cardStatus' ) {
                  $("#cardStatusFields").show();
                  $("#ComplaintFields").show();
                  $("#ComplaintHistory").show();
                }
                else if (selectedOption == 'card' ) {
                  bootbox.alert("Please collect complaint type and refer beneficiary to BLF Hotline:01242477/03242477. Please explain that we can do nothing and they must call the bank");
                  $("#cardFields").show();
                  $("#ComplaintHistory").show();
                }
                else if (selectedOption == 'reinstateBeneficiary' ) {
                  $("#reinstateBeneficiaryFields").show();
                  $("#ComplaintFields").show();
                  $("#ComplaintHistory").show();
                }
                else if (selectedOption == 'schoolRefusedEntrance' ) {
                  UpdateChildSchool();
                  $("#schoolRefusedEntranceFields").show();
                  $("#ComplaintFields").show();
                  $("#ComplaintHistory").show();
                }
                else if (selectedOption == 'otherComplaint' ) {
                  $("#otherFields").show();
                  $("#ComplaintFields").show();
                  $("#ComplaintHistory").show();
                }
                else if (selectedOption == 'refusedServiceBLF' ) {
                  $("#bankFields").show();
                  $("#ComplaintFields").show();
                  $("#ComplaintHistory").show();
                }
                else if (selectedOption == 'twoCards' ) {
                  $("#twoCardsFields").show();
                  $("#ComplaintHistory").show();
                }
                else if (selectedOption == 'missingChild' ) {
                  $("#missingChildFields").show();
                  $("#ComplaintFields").show();
                  $("#ComplaintHistory").show();
                }
                else if (selectedOption == 'notEligible' ) {
                  $("#notEligibleFields").show();
                  $("#ComplaintHistory").show();
                }

                });



          function hideAll()
          {
            $("#phoneFields").hide();
            $("#addressFields").hide();
            $("#schoolChangeFields").hide();
            $("#beneficiaryFields").hide();
            $("#paymentFields").hide();
            $("#cardFields").hide();
            $("#cardStatusFields").hide();
            $("#removeFields").hide();
            $("#otherFields").hide();
            $("#schoolRefusedEntranceFields").hide();
            $("#ComplaintFields").hide();
            $("#reinstateBeneficiaryFields").hide();
            $("#bankFields").hide();
            $("#twoCardsFields").hide();
            $("#cardPhoneFields").hide();
            $("#ComplaintHistory").hide();
            $("#complaint_Other_type").hide();
            $("#notEligibleFields").hide();
            $("#missingChildFields").hide();
          }

              function loadAjaxCall(regId , data)
            {
                 $.ajax({
                    type: "PATCH",
                    url: synchro_path+regId+'/',
                    cache: false,
                    headers: getHeader(),
                    dataType: 'json',
                    data: data,
                    beforeSend: function( ) {
                       // show loader
                        $(".loader").show();
                      }
                 }).done(function(data) {
                  // hide loader, show success message
                    $(".loader").hide();
                     if(data) {
                         $(".alert-success").fadeIn();
                         setTimeout(function () {
                             $(".alert-success").fadeOut();
                         }, 1000);
                     }
                     else {
                         $(".alert-danger").fadeIn();
                         setTimeout(function () {
                             $(".alert-danger").fadeOut();
                         }, 2000);
                     }
                });
            }

      });


      function InitialiseToggleRadioButtons()
      {
        $(document).on('click', '.toggleRadioBtn a', function(){
            var sel = $(this).data('title');
            var tog = $(this).data('toggle');
            $('#'+tog).prop('value', sel);
            $('#'+tog+'_'+sel).trigger('click');

            $('a[data-toggle="'+tog+'"]').not('[data-title="'+sel+'"]').removeClass('active').addClass('notActive');
            $('a[data-toggle="'+tog+'"][data-title="'+sel+'"]').removeClass('notActive').addClass('active');
        });
      }


      var householdRecord = null;


      function LoadData(hhID)
      {
         $.ajax({
                     type: "GET",
                     url: checking_id_number_url+hhID,
                     data: [],
                     cache: false,
                     async: false,
                     headers: getHeader(),
                     dataType: 'json',
                     success: function (response) {
                         var household = response;
                         householdRecord = household;
                         console.log(response);
                         complaint_hh_id = hhID;
                         HideAllErrors();
                         $("#hhName").text(household.first_name+' '+household.father_name+' '+household.last_name);
                         $("#hhIdNumber").text(household.id_number);
                         $("#hhDOB").text(household.birthday_day+'/'+household.birthday_month+'/'+household.birthday_year);
                         $("#hhLastcardgigits").text(household.card_last_four_digits);
                         $("#hhprimary_phone").text(household.primary_phone);
                         $("#hhsecondary_phone").text(household.secondary_phone);
                         $("#hh_current_primary_phone").text(household.primary_phone);
                         $("#hh_current_secondary_phone").text(household.secondary_phone);
                         $("#hh_card_primary_phone").text(household.primary_phone);
                         updateDropDownValue($("#not_eligible_select"),household.no_logner_eligible_reason);
                         var selectedOptionText =  $("#not_eligible_select option:selected").text();
                         if(selectedOptionText == "Other (Specify)")
                            {
                                $("#not_eligible_specify_reason").show();
                            }
                            else
                            {
                                $("#not_eligible_specify_reason").hide();
                            }

                         $("#not_eligible_reason_specify").val(household.no_logner_eligible_specify);
                         $("#no_logner_eligible_comment").val(household.no_logner_eligible_comment);


                         $("#hhAddess").text(household.address);

                         $("#hhCardStatus").text(household.card_status);
                         var cardStatus = household.card_status;
                         if (cardStatus=='Active')
                         {
                             document.getElementById('hhCardStatus').style.color = "#7b7b7b";
                         }
                         else
                         {
                             document.getElementById('hhCardStatus').style.color = "red";
                         }


                         if (household.card_distribution_date == null)
                         {
                           $("#hhDateOfDistribution").text('');
                         }
                         else
                         {
                             $("#hhDateOfDistribution").text(household.card_distribution_date);
                         }

                         $("#primary_phone").val('');
                         $("#primary_phone_confirm").val('');
                         updateDropDownValue($("#primary_phone_answered"),household.primary_phone_answered);
                         $("#secondary_phone").val('');
                         $("#secondary_phone_confirm").val('');
                         updateDropDownValue($("#secondary_phone_answered"),household.secondary_phone_answered);
                         $("#address").val('');
                         $("#card_phone").val('');
                         $("#card_phone_confirm").val('');

                         var suspended = household.household_suspended;
                         if (suspended)
                         {
                             $("#hhsuspended").show();
                             $("#hhsuspended_payment").text('Suspended');
                             document.getElementById('hhsuspended_payment').style.color = "red";
                         }
                         else
                         {
                             $("#hhsuspended").hide();
                             $("#hhsuspended_payment").text('Active');
                             document.getElementById('hhsuspended_payment').style.color = "#7b7b7b";
                         }
                         $("#id_number").val(household.beneficiary_changed_id_number);
                         $("#first_name").val(household.beneficiary_changed_first_name);
                         $("#father_name").val(household.beneficiary_changed_father_name);
                         $("#last_name").val(household.beneficiary_changed_last_name);
                         $("#mother_full_name").val(household.beneficiary_changed_mother_full_name);
                         $("#beneficiary_phone").val(household.beneficiary_changed_phone);
                         $("#beneficiary_phone_confirm").val('');
                         ChangeBooleanSelection($("#radioBtn"), household.beneficiary_changed_same_as_caller)
                         updateDropDownValue($("#idType"),household.beneficiary_changed_id_type);
                         updateDropDownValue($("#gender"),household.beneficiary_changed_gender);
                         updateDropDownValue($("#days"),household.beneficiary_changed_birthday_day);
                         updateDropDownValue($("#months"),household.beneficiary_changed_birthday_month);
                         updateDropDownValue($("#years"),household.beneficiary_changed_birthday_year);
                         updateDropDownValue($("#relation_to_householdhead"),household.beneficiary_changed_relation_to_householdhead);
                         updateDropDownValue($("#reason"),household.beneficiary_changed_reason);
                         $("#beneficiary_specify_reason").val(household.beneficiary_specify_reason);



                         $("#first_card_case_number").val(household.duplicate_card_first_card_case_number);
                         $("#first_card_case_number_confirm").val('');
                         $("#first_card_last_four_digits").val(household.duplicate_card_first_card_last_four_digits);
                         $("#second_card_case_number").val(household.duplicate_card_second_card_case_number);
                         $("#second_card_case_number_confirm").val('');
                         $("#secondcard_last_four_digits").val(household.duplicate_card_secondcard_last_four_digits);

                         $("#complaint_bank_date_of_incident").val('');
                         $("#complaint_bank_time_of_incident").val('');
                         $("#complaint_bank_phone_used").val('');
                         $("#complaint_bank_service_requested").val('');
                         $("#complaint").val('');
                         $("#student_refused_entrance").val('');
                         $("#complaint_Other_type_specify").val('');


                         $("#st_idType").val('');
                         $("#st_id_number").val('');
                         $("#st_first_name").val('');
                         $("#st_father_name").val('');
                         $("#st_last_name").val('');
                         $("#st_mother_full_name").val('');
                         $("#st_gender").val('');
                         $("#st_days").val('');
                         $("#st_months").val('');
                         $("#st_years").val('');
                         $("#studentSchool").val('');

                         ChangeBooleanSelection($("#radioBtn_missingchild"), false);
                         ChangeBooleanSelection($("#radioBtn_urgent"), false);



                         $("#schools-table tbody").empty();
                         $("#children-table tbody").empty();
                         for(childIndex in household.children)
                         {
                            var child = household.children[childIndex];
                            AddChildSchoolRow(child);
                            AddChildAgeRow(child);
                         }
                          AddSchoolChild(household.children);

                         InitialiseLocationSchoolDropdowns();

                         $("#payments-table tbody").empty();
                         for(paymentIndex in household.payments)
                         {
                            var payment = household.payments[paymentIndex];
                            AddPaymentRow(payment);
                         }

                         $("#complaints-table tbody").empty();
                         for(complaintIndex in household.complaints)
                         {
                            var complaint = household.complaints[complaintIndex];
                            AddComplaintRow(complaint);
                         }



                     },
                     error: function (response) {
                        var required_fields = JSON.parse(response.responseText);
                        console.log(response);
                     }
                 });
      }

          function AddChildSchoolRow(entry)
            {
                var childFullName = entry.first_name+' '+entry.father_name+' '+entry.last_name;

                var childIDCell = "<td style = \"display:none\">"+(entry.reg_id)+"</td>";
                var childNameCell = "<td  >"+(childFullName)+"</td>";
                var currentSchoolCell = "<td  >"+(entry.school_name)+"</td>";
                var NewslocationCell = "<td>"+$("#childSchoolLocation").html()+"</td>";
                var NewschoolCell = "<td>"+$("#childSchool").html()+"</td>";

                $("#schools-table tbody").append
                (
                   "<tr>"+childIDCell+childNameCell+currentSchoolCell+NewslocationCell+NewschoolCell+"</tr>"
                );

                var location_id =
                    entry.school_changed_to_verify_location_id==null?
                    parseInt($("#id_location").val()):
                    entry.school_changed_to_verify_location_id;

                updateDropDownValue($("#schools-table tr:last-child td:nth-child(4) select"), location_id );

                FilterLocationSchools
                (
                    $("#schools-table tr:last-child "),
                    location_id
                );

                updateDropDownValue($("#schools-table tr:last-child td:nth-child(5) select"), entry.school_changed_to_verify );
            }

           function InitialiseLocationSchoolDropdowns()
           {
               var editForm = $("#schools-table tbody");

               editForm.on
               (
                 'change', '[name=childSchoolLocation]',
                 function()
                 {
                    var parentRow = $(this).parent().parent();

                    FilterLocationSchools(parentRow, parseInt($(this).val()));

                    updateDropDownValue(parentRow.find("[name=childSchool]"),null );

                 }
               );

               alert(householdRecord.location_id);
               FilterStudentLocationSchools($("#missingChildFields"),householdRecord.location_id);
           }


           function FilterLocationSchools(editForm, locationID)
           {
               FilterLocationSchoolsName(editForm, locationID,"childSchool");
           }

           function FilterStudentLocationSchools(editForm, locationID)
           {
               FilterLocationSchoolsName(editForm, locationID,"studentSchool");
           }

           function FilterLocationSchoolsName(editForm, locationID, dropDownName)
           {
              editForm.find("[name="+dropDownName+"] option[location-id!="+locationID+"]").hide();
              editForm.find("[name="+dropDownName+"] option[location-id="+locationID+"],[value='']").show();
           }

          function AddChildAgeRow(entry)
            {
                var childFullName = entry.first_name+' '+entry.father_name+' '+entry.last_name;
                var childNameCell = "<td  >"+(childFullName)+"</td>";
{#                var ChildDOB = entry.birthday_day+'/'+entry.birthday_month+'/'+entry.birthday_year;#}
{#                var childDOBCell = "<td  >"+(ChildDOB)+"</td>";#}
                var ageCell = "<td  >"+(entry.calculate_age)+"</td>";
                var schoolCell = "<td  >"+(entry.school_name)+"</td>";

                $("#children-table tbody").append
                (
                   "<tr>"+childNameCell+ageCell+schoolCell+"</tr>"
                );
            }

            function AddPaymentRow(entry)
            {

                var dateCell = "<td>"+FormatDate(entry.payment_date) +"</td>";
                var amountCell = "<td>"+entry.payment_amount+"</td>";
                var monthCell = "<td>"+entry.payment_month+"</td>";
                var yearCell = "<td>"+entry.payment_year+"</td>";

                var MonthshortName = monthNumToName(entry.payment_month);

                var MonthshortNameCell = "<td>"+MonthshortName+"</td>";

                $("#payments-table tbody").append
                (
                   "<tr>"+dateCell+amountCell+MonthshortNameCell+yearCell+"</tr>"
                );
            }
            function monthNumToName(monthnum) {
                    return months[monthnum - 1] || '';
                }

            function AddComplaintRow(entry)
            {
                var dateIssuedCell = "<td>"+FormatDate(entry.created)+"</td>";
                var typeCell = "<td>"+entry.complaint_category_name +"</td>";
                var noteCell = "<td>"+entry.complaint_note+"</td>";

                var dateReplyCell =
                    entry.complaint_resolution_date == null?
                    "<td>"+''+"</td>":
                    "<td>"+FormatDate(entry.complaint_resolution_date)+"</td>";

                var ReplyCell = "<td>"+entry.complaint_solution+"</td>";
                var statusCell = "<td>"+entry.complaint_status+"</td>";


                $("#complaints-table tbody").append
                (
                   "<tr>"+typeCell+dateIssuedCell+noteCell+statusCell+ReplyCell+dateReplyCell+"</tr>"
                );
            }


      function updateDropDownValue(dropDownElement, value)
      {
          dropDownElement.find('option:selected').removeAttr('selected');
          dropDownElement.find('option[value="'+value+'"]').attr("selected",true);
          dropDownElement.val(value);
      }


       function CreateChildData(childVisitID)
        {
           childData = [];

           $("#schools-table tbody tr")
           .each
           (
              function(i, obj)
              {
                 trElement = $(obj);

                 childRecord = new Object();

                 childRecord.reg_id = trElement.find('td:nth-child(1)').html();

                 dropDownElement = trElement.find('td:nth-child(5) select');

                 childRecord.school_changed_to_verify = dropDownElement.val();

                 childData.push(childRecord);

              }
           );

           return childData;
        }

      function CloseHousehold()
      {
          $("#hhEditForm").hide();
          $("#hhList").show();

        householdRecord = null;
        hhID = null;
      }

      function CloseMissingStudent()
      {
          mcID = null;
          $("#st_idType").val('');
          $("#st_id_number").val('');
          $("#st_first_name").val('');
          $("#st_father_name").val('');
          $("#st_last_name").val('');
          $("#st_mother_full_name").val('');
          $("#st_gender").val('');
          $("#st_days").val('');
          $("#st_months").val('');
          $("#st_years").val('');
          $("#studentSchool").val('');
          $("#confirm_child_registered_second_shift").val('');
          $("#st_idType_error").hide();
          $("#st_id_number_error").hide();
          $("#st_dob_error").hide();
          $("#st_first_name_error").hide();
          $("#st_father_name_error").hide();
          $("#st_last_name_error").hide();
          $("#st_mother_full_name_error").hide();
          $("#st_gender_error").hide();
          $("#st_school_error").hide();
      }

       function CloseHouseholdNotFound()
      {
          $("#hhNotFoundForm").hide();
          $("#hhList").show();
          nfID = null;
          notFoundRecord = null;

          $("#nf_idType").val('');
          $("#nf_id_number").val('');
          $("#nf_first_name").val('');
          $("#nf_father_name").val('');
          $("#nf_last_name").val('');
          $("#nf_mother_full_name").val('');
          $("#nf_gender").val('');
          $("#nf_days").val('');
          $("#nf_months").val('');
          $("#nf_years").val('');
          $("#nf_relation_to_householdhead").val('');
          $("#nf_address").val('');
          $("#nf_primary_phone").val('');
          $("#nf_primary_phone_confirm").val('');
          $("#nf_primary_phone_answered").val('');
          $("#nf_secondary_phone").val('');
          $("#nf_secondary_phone_confirm").val('');
          $("#nf_secondary_phone_answered").val('');
          $("#number_children_five_to_nine").val('');
          $("#number_children_ten_to_seventeen").val('');
          $("#nf_complaint").val('');
          $("#nf_primary_phone_length_error").hide();
          $("#nf_primary_phone_confirm_error").hide();
          $("#nf_primary_phone_answered_error").hide();
          $("#nf_secondary_phone_length_error").hide();
          $("#nf_secondary_phone_confirm_error").hide();
          $("#nf_secondary_phone_confirm_length_error").hide();
          $("#nf_secondary_phone_confirm_error").hide();
          $("#nf_secondary_phone_answered_error").hide();
          $("#nf_idType_error").hide();
          $("#nf_id_number_error").hide();
          $("#nf_dob_error").hide();
          $("#nf_gender_error").hide();
          $("#nf_number_children_error").hide();
          $("#nf_first_name_error").hide();
          $("#nf_father_name_error").hide();
          $("#nf_last_name_error").hide();
          $("#nf_mother_full_name_error").hide();
          $("#nf_complaint_error").hide();
      }


      function InitialiseDays(cntrl, from, to)
      {
        (function() {
            var elm = document.getElementById(cntrl), // get the select
                df = document.createDocumentFragment(); // create a document fragment to hold the options while we create them
            for (var i = from; i <= to; i++) { // loop, i like 42.
                var option = document.createElement('option'); // create the option element
                option.value = i; // set the value property
                option.appendChild(document.createTextNode(i)); // set the textContent in a safe way.
                df.appendChild(option); // append the option to the document fragment
            }
            elm.appendChild(df); // append the document fragment to the DOM. this is the better way rather than setting innerHTML a bunch of times (or even once with a long string)
        }());
      }

      function InitialiseSave()
      {
          $(document).on
          (
             'click',
             '#hhSaveButton',
             function()
             {
                if(ValidateHouseHoldUpdate())
                {
                   if($("#changeOption").val() == "phone" || $("#changeOption").val() == "address"
                       || $("#changeOption").val() == "beneficiary" || $("#changeOption").val() == "twoCards" || $("#changeOption").val() == "notEligible")
                   {
                      SaveHousehold(true);
                   }
                   else if($("#changeOption").val() == "school_change")
                   {
                      SaveChildren(true);
                   }
                    else if($("#changeOption").val() == "cardStatus" && ValidateComplaint())
                   {
                      SaveHousehold();
                      SaveComplaint(true);
                   }
                   else if($("#changeOption").val() == "missingChild" && ValidateComplaint() && ValidateMissingChild())
                   {
                       alert("missing ch");

                      SaveMissingChild();
                      SaveComplaint(true);
                      CloseMissingStudent();
                   }
                   else if
                   (
                            (
                                $("#changeOption").val() == "payment"
                               || $("#changeOption").val() == "refusedServiceBLF"|| $("#changeOption").val() == "schoolRefusedEntrance"
                               || $("#changeOption").val() == "reinstateBeneficiary" || $("#changeOption").val() == "otherComplaint"
                            )
                            && ValidateComplaint()
                   )
                   {
                       SaveComplaint(true);
                   }

                   else if
                   ( $("#changeOption").val() == "card" )
                   {
                       SaveComplaint(true);
                   }
                }
             }
           );
           $(document).on
          (
             'click',
             '#nfSaveButton',
             function()
             {
                if(ValidateHouseHoldNotFound())
                {
                      SaveNotFound();
                      SaveComplaint();

                }
             }
           );

      }

      function InitialiseClose()
      {
        $(document).on
          (
             'click',
             '#hhCloseButton',
             function()
             {
                 $("#hhEditForm").hide();
                 $("#hhNotFoundForm").hide();
                 $("#hhList").show();
                householdRecord = null;
                hhID = null;
             }
           );

        $(document).on
          (
             'click',
             '#nfCloseButton',
             function()
             {
                 $("#hhEditForm").hide();
                 $("#hhNotFoundForm").hide();
                 $("#hhList").show();
                 nfID = null;
                 notFoundRecord = null;
             }
           );
      }

      function SaveHousehold()
      {
          var houseHoldData = new Object();

          if($("#changeOption").val() == "phone")
          {
              houseHoldData.primary_phone = $("#primary_phone").val();
              houseHoldData.primary_phone_answered = $("#primary_phone_answered").val();
              if ($("#secondary_phone").val() !='')
              {
                  houseHoldData.secondary_phone = $("#secondary_phone").val();
                  houseHoldData.secondary_phone_answered = $("#secondary_phone_answered").val();
              }
          }
          else if($("#changeOption").val() == "address")
          {
              houseHoldData.address = $("#address").val();
          }
          else if($("#changeOption").val() == "beneficiary")
          {
              SaveNewBenificiary(houseHoldData);
          }
          else if($("#changeOption").val() == "twoCards")
          {
              houseHoldData.duplicate_card_first_card_case_number = $("#first_card_case_number").val();
              houseHoldData.duplicate_card_first_card_last_four_digits = $("#first_card_last_four_digits").val();
              houseHoldData.duplicate_card_second_card_case_number = $("#second_card_case_number").val();
              houseHoldData.duplicate_card_secondcard_last_four_digits = $("#secondcard_last_four_digits").val();
          }
          else if($("#changeOption").val() == "cardStatus")
          {
              houseHoldData.primary_phone = $("#card_phone").val();
          }
          else if($("#changeOption").val() == "notEligible")
          {
              houseHoldData.no_logner_eligible = true;
              houseHoldData.no_logner_eligible_reason = $("#not_eligible_select").val();
              houseHoldData.no_logner_eligible_specify = $("#not_eligible_reason_specify").val();
              houseHoldData.no_logner_eligible_comment = $("#no_logner_eligible_comment").val();
          }
          $.ajax
          (
              {
                  type: "PATCH",
                  url: checking_id_number_url + hhID +"/",
                  data: houseHoldData,
                  cache: false,
                  async: false,
                  headers: getHeader(),
                  dataType: 'json',
                  success: function (response)
                  {
                      var block = $("#registrations-table tr[adultid="+hhID+"]");
                      if ($("#primary_phone").val() !='')
                      {
                          block.find("td:nth-child(4)").text($("#primary_phone").val());
                      }
                      if ($("#card_phone").val() !='')
                      {
                          block.find("td:nth-child(4)").text($("#card_phone").val());
                      }
                      if ($("#secondary_phone").val() !='')
                      {
                          block.find("td:nth-child(5)").text($("#secondary_phone").val());
                      }
                      CloseHousehold();

                  },
                  error: function (response)
                  {
                      console.log(response);
                  }
              }
          );
      }

      function SaveNewBenificiary(houseHoldData)
      {

          var isbeneficiary_changed= GetBooleanSelection($("#radioBtn"));
          houseHoldData.beneficiary_changed_verify = true ;
          houseHoldData.beneficiary_changed_same_as_caller = isbeneficiary_changed ;

          houseHoldData.beneficiary_changed_id_type = $("#idType").val();
          houseHoldData.beneficiary_changed_id_number = $("#id_number").val();
          houseHoldData.beneficiary_changed_first_name = $("#first_name").val();
          houseHoldData.beneficiary_changed_father_name = $("#father_name").val();
          houseHoldData.beneficiary_changed_last_name = $("#last_name").val();
          houseHoldData.beneficiary_changed_mother_full_name = $("#mother_full_name").val()

          houseHoldData.beneficiary_changed_gender = $("#gender").val();
          houseHoldData.beneficiary_changed_birthday_day = $("#days").val();
          houseHoldData.beneficiary_changed_birthday_month = $("#months").val();
          houseHoldData.beneficiary_changed_birthday_year = $("#years").val();
          houseHoldData.beneficiary_changed_relation_to_householdhead = $("#relation_to_householdhead").val();

          houseHoldData.beneficiary_changed_phone = $("#beneficiary_phone").val();
          houseHoldData.beneficiary_changed_reason = $("#reason").val();
          houseHoldData.beneficiary_specify_reason = $("#beneficiary_specify_reason").val();
      }


       function GetBooleanSelection(element)
       {
          return element.find('a.active').attr('data-title')==1 ? "true":"false";
       }

       function ChangeBooleanSelection(element, isSelected)
       {
           ChangeBooleanSelectionOption(element.find('a[data-title=1]'),isSelected);
           ChangeBooleanSelectionOption(element.find('a[data-title=0]'),!isSelected);
       }
       function ChangeBooleanSelectionOption(element, isSelected)
           {
              if(isSelected)
              {
                 element.addClass("active");
                 element.removeClass("notActive");
              }
              else
              {
                 element.removeClass("active");
                 element.addClass("notActive");
              }
           }

       function SaveChildren()
       {
           var childData = CreateChildData();

           var isSuccessfull = true;

           childData.forEach
           (
              function(entry)
              {
                 isSuccessfull = isSuccessfull && SaveChild(entry);
              }
           );

           if(isSuccessfull)
           {
               CloseHousehold();
           }
       }


      function SaveChild(entry) {
          var childID = entry.reg_id;
          var childData = new Object();

          childData.school_changed_to_verify = entry.school_changed_to_verify;

          var isSuccessfull = false;

          $.ajax
          (
              {
                  type: "PATCH",
                  url: childURL + childID + "/",
                  data: childData,
                  cache: false,
                  async: false,
                  headers: getHeader(),
                  dataType: 'json',
                  success: function (response) {
                      isSuccessfull = true;
                  },
                  error: function (response) {
                      console.log(response);
                  },
                  async: false
              }
          );
          //alert(isSuccessfull);

          return isSuccessfull;
      }

      function UpdateChildSchool()
      {
{#         var childID = $("#child").val();#}
{##}
{#         var children = householdRecord.children.filter#}
{#         (#}
{#            function(child)#}
{#            {#}
{#               return child.student_id == childID;#}
{##}
{#            }#}
{#         );#}
{##}
{##}
{#         if(children.length > 0)#}
{#         {#}
{#            childRecord = children[0];#}
{##}
{#            console.log(childRecord);#}
{##}
{#            updateDropDownValue($("#student_refused_entrance"),childRecord.school_changed_to_verify);#}
{##}
{#         }#}

      }

      function InitialiseChildDropdown()
      {
          $(document).on
          (
             'change',
             '#child',
             function()
             {
                UpdateChildSchool();
             }


           );
      }

      function AddSchoolChild(children)
            {
                $('#student_refused_entrance').find('option').remove().end();
                (function() {
                    var elm = document.getElementById('student_refused_entrance'),
                        df = document.createDocumentFragment();
                    for(childIndex in  children)
                    {
                        var option = document.createElement('option');
                        var child = children[childIndex];
                        var childFullName = child.first_name+' '+child.father_name+' '+ child.last_name;
                        var child_school = childFullName + ' - ' + child.school_name;
                        option.value = child.student_id;
                        option.appendChild(document.createTextNode(child_school));
                        df.appendChild(option);
                    }
                    elm.appendChild(df);
                }());
            }




      function SaveComplaint(hh_Complaint)
      {
          var complaint_category_id;
          var note ;
          var complaintData = new Object();

         var urgent= GetBooleanSelection($("#radioBtn_urgent"));

          if (hh_Complaint)
          {
              if($("#changeOption").val() == "payment" )
              {
                  complaint_category_id = $("#payment_complaint").val();
              }
              else if($("#changeOption").val() == "cardStatus")
              {
                   complaint_category_id = $("#card_distribution_complaint").val();
              }
              else if($("#changeOption").val() == "card")
              {
                  complaint_category_id = $("#card_complaint").val();
              }
              else if($("#changeOption").val() == "refusedServiceBLF")
              {
                   complaint_category_id = $("#bank_complaint").val();
              }
              else if($("#changeOption").val() == "schoolRefusedEntrance")
              {
                   complaint_category_id = $("#school_complaint").val();
              }
              else if($("#changeOption").val() == "reinstateBeneficiary")
              {
                   complaint_category_id = $("#reinstate_complaint").val();
              }
              else if($("#changeOption").val() == "otherComplaint")
              {
                   complaint_category_id = $("#other_complaint").val();
              }
              else if($("#changeOption").val() == "missingChild")
              {
                  complaint_category_id = $("#missingChild_complaint").val();
                  complaintData.missing_child =mcID;
              }
              note = $("#complaint").val();
              complaintData.complaint_adult = complaint_hh_id;
          }
          else
          {
              complaint_category_id = $("#not_found_complaint").val();
              note = $("#nf_complaint").val();
              complaintData.household_not_found =nfID;
          }

         complaintData.complaint_category = complaint_category_id;
         complaintData.complaint_note = note;
         complaintData.complaint_urgent= urgent;

         complaintData.complaint_status = 'open';

         complaintData.owner = user_id;

         var selected_year = $("#complait_years").val().toString();
         var selected_month = $("#complait_months").val().toString() ;
         var selected_day = $("#complait_days").val().toString();
         var selected_date = [selected_year,
          (selected_month>9 ? '' : '0') + selected_month,
          (selected_day>9 ? '' : '0') + selected_day
         ].join('-');

         var selected_hour = $("#complait_am_pm").val()=='AM'
             ? $("#complait_hours").val().toString()
             : (parseInt($("#complait_hours").val()) + 12).toString() ;
         var hour = selected_hour < 10 ? "0" + selected_hour : selected_hour;

         var selected_minutes = $("#complait_minutes").val() < 10
             ? "0" + $("#complait_minutes").val()
             : $("#complait_minutes").val();

         var selected_time = hour + ":" + selected_minutes ;

         complaintData.complaint_bank_date_of_incident = formatDate_save(selected_date)+ ' '+ selected_time;
         complaintData.complaint_bank_phone_used = $("#complaint_bank_phone_used").val();
         complaintData.complaint_bank_service_requested =$("#complaint_bank_service_requested").val();
         complaintData.complaint_solution ='';
         complaintData.complaint_Other_type_specify =$("#complaint_Other_type_specify").val();
         if($("#changeOption").val() == "schoolRefusedEntrance"  && hh_Complaint)
          {
              complaintData.complaint_student_refused_entrance =$("#student_refused_entrance").val();
          }
         var isSuccessfull = false;

         console.log(complaintData);

         $.ajax
         (
            {
              type: "PUT",
              url: complaintURL,
              data: complaintData,
              cache: false,
              async: false,
              headers: getHeader(),
              dataType: 'json',
              success: function (response)
              {
                  isSuccessfull = true;
                  CloseHousehold();
                  CloseHouseholdNotFound();
              },
              error: function (response)
              {
                  console.log(response);
              },
              async: false
           }
         );
         //alert(isSuccessfull);

         return isSuccessfull;
      }

        function SaveMissingChild()
      {

         var missingChildData = new Object();
         var confirm_child_registered_second_shift= GetBooleanSelection($("#radioBtn_missingchild"));

          missingChildData.id_type = $("#st_idType").val();
          missingChildData.id_number = $("#st_id_number").val();
          missingChildData.first_name = $("#st_first_name").val();
          missingChildData.father_name = $("#st_father_name").val();
          missingChildData.last_name = $("#st_last_name").val();
          missingChildData.mother_fullname = $("#st_mother_full_name").val()
          missingChildData.sex = $("#st_gender").val();
          missingChildData.birthday_day = $("#st_days").val();
          missingChildData.birthday_month = $("#st_months").val();
          missingChildData.birthday_year = $("#st_years").val();
          //missingChildData.relation_to_householdhead = $("#studentSchool").val();
          missingChildData.confirm_child_registered_second_shift = confirm_child_registered_second_shift;

          //alert(missingChildData.confirm_child_registered_second_shift );

          console.log(missingChildData);

         var isSuccessfull = false;

         $.ajax
         (
            {
              type: "PUT",
              url: missingchildURL,
              data: missingChildData,
              cache: false,
              async: false,
              headers: getHeader(),
              dataType: 'json',
              success: function (response)
              {
                  isSuccessfull = true;
                  mcID = response.id
                  console.log(response);
              },
              error: function (response)
              {
                  console.log(response);
              },
              async: false
           }
         );

         return isSuccessfull;
      }



      function SaveNotFound()
      {

         var notfoundData = new Object();

         //   nationality_id
          notfoundData.id_type = $("#nf_idType").val();
          notfoundData.id_number = $("#nf_id_number").val();
          notfoundData.first_name = $("#nf_first_name").val();
          notfoundData.father_name = $("#nf_father_name").val();
          notfoundData.last_name = $("#nf_last_name").val();
          notfoundData.mother_fullname = $("#nf_mother_full_name").val()
          notfoundData.sex = $("#nf_gender").val();
          notfoundData.birthday_day = $("#nf_days").val();
          notfoundData.birthday_month = $("#nf_months").val();
          notfoundData.birthday_year = $("#nf_years").val();
          notfoundData.relation_to_householdhead = $("#nf_relation_to_householdhead").val();
          notfoundData.address = $("#nf_address").val();
          notfoundData.primary_phone = $("#nf_primary_phone").val();
          notfoundData.primary_phone_answered = $("#nf_primary_phone_answered").val();
          notfoundData.secondary_phone = $("#nf_secondary_phone").val();
          notfoundData.secondary_phone_answered = $("#nf_secondary_phone_answered").val();
          notfoundData.number_children_five_to_nine = $("#number_children_five_to_nine").val();
          notfoundData.number_children_ten_to_seventeen = $("#number_children_ten_to_seventeen").val();


         var isSuccessfull = false;

         $.ajax
         (
            {
              type: "PUT",
              url: notfoundURL,
              data: notfoundData,
              cache: false,
              async: false,
              headers: getHeader(),
              dataType: 'json',
              success: function (response)
              {
                  isSuccessfull = true;
                  nfID = response.id
                  console.log(response);
              },
              error: function (response)
              {
                  console.log(response);
              },
              async: false
           }
         );

         return isSuccessfull;
      }


      function formatDate_save(date) {
          var d = new Date(date),
              month = '' + (d.getMonth() + 1),
              day = '' + d.getDate(),
              year = d.getFullYear();
          if (month.length < 2) month = '0' + month;
          if (day.length < 2) day = '0' + day;
          return [year, month, day].join('-');
      }

      function FormatDate(dateString)
        {
           var date;

           if(isDate(dateString, "yyyy-MM-ddTHH:mm:ssZ") )
           {
              date = new Date(getDateFromFormat(dateString, "yyyy-MM-ddTHH:mm:ssZ"));
           }
           else
           {
              date = new Date(dateString);
           }

           var result =
           (
              date.getDate().toString() + '/' +
              (date.getMonth() + 1).toString() + '/' +
              date.getFullYear().toString()
           );

           return result;
        }

        function FormatJSONDate(dateString)
        {
           var date;

           if(isDate(dateString, "dd/MM/yyyy") )
           {
              date = new Date(getDateFromFormat(dateString, "d/MM/yyyy"));
           }
           else if(isDate(dateString, "d/MM/yyyy") )
           {
              date = new Date(getDateFromFormat(dateString, "d/MM/yyyy"));
           }
           else if(isDate(dateString, "dd/M/yyyy") )
           {
              date = new Date(getDateFromFormat(dateString, "dd/M/yyyy"));
           }
           else
           {
              date = new Date(dateString);
           }

           return date;
        }




    </script>

{% endblock %}


