{% extends "base.html" %}
{% load staticfiles i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% load util_tags %}

{% block extra_head %}
  <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-breadcrumbs.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/jquery.dataTables.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/buttons.dataTables.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/select.dataTables.min.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/sly.css' %}"
          xmlns:font-weight="http://www.w3.org/1999/xhtml" xmlns:font-weight="http://www.w3.org/1999/xhtml">


    <style>
        .row-class {
            cursor: pointer;
        }
        .row-class:hover {
           background-color: gainsboro !IMPORTANT;
        }

        .child-row-class {
            cursor: pointer;
        }
        .child-row-class:hover {
           background-color: gainsboro !IMPORTANT;
        }

        .transparent-header
        {
           background-color: transparent !IMPORTANT;
           border: solid 0px transparent !IMPORTANT;
        }

    </style>

{% endblock %}


{% block content %}


         <div class="loader"></div>

         <section class="main-content-wrapper" id = "hhList">
            <section id="main-content">
                 <div class="row">
                    <div class="col-md-12">
                        </br>
                    </div>
                </div>
            <div class="row">

                <div class="alert alert-success" role="alert" style="display: none;">
                    <strong>{% trans 'Success' %}</strong> {% trans 'Your change is successfully Saved' %}
                </div>
                <div class="alert alert-warning" role="alert" style="display: none;">
                    <strong>{% trans 'Oops' %}</strong> {% trans 'Error saving changes, please contact system administrators' %}
                </div>

                    <div class="col-md-12">
                        <div class="panel panel-default">
                          <div class="panel-heading">
                            <h3 class="panel-title">
                                <ol class="breadcrumb">
                                  <li><a>{% trans "Household Update" %}</a></li>
                                  <li>

                                  </li>
                                </ol>
                            </h3>
                            <div class="actions pull-right">
                                <i class="fa fa-chevron-down"></i>
                                <i class="fa fa-times"></i>
                            </div>
                          </div>
                          <div class="panel-body">
                                <table id="registrations-table" class="table table-striped table-bordered cell-border"
                                       data-height="500"
                                       data-pagination="true"
                                       data-search="true"
                                       cellspacing="0"
                                       width="100%">
                                <thead>
                                    <tr id="thead-line-1">
                                        <th class = "transparent-header">

                                        </th>
                                        <th class = "transparent-header">

                                        </th>
                                        <th class = "transparent-header"></th>
                                        <th class = "transparent-header"></th>
                                        <th class = "transparent-header"></th>
                                        <th class = "transparent-header">

                                            <button class="btn btn-primary" type="button" id="searchButton">
                                                Search
                                            </button>

                                        </th>
                                    </tr>

                                    <tr id="thead-line-1">
                                        <th class = "transparent-header">

                                            <select id="id_location">
                                              <option value="">---{% trans "Display by Location" %}---</option>
                                                {% for location in locations %}
                                                    <option value="{{ location.id }}" {% if selectedLocation == location.id %}selected="selected"{% endif %}>
                                                      {{ location }}
                                                    </option>
                                                {% endfor %}
                                            </select>

                                        </th>
                                        <th class = "transparent-header">
                                            <input class="form-control input-sm" id = "addressSearchText" value = "{{addressSearchText}}" />
                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "repSearchText" value = "{{repSearchText}}" />
                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "idSearchText" value = "{{idSearchText}}" />
                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "primarySearchText" value = "{{primarySearchText}}" />
                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "secondarySearchText" value = "{{secondarySearchText}}" />
                                        </th>
                                    </tr>
                                    <tr id="thead-line-1">
                                        <th>{% trans "HH District" %}</th>
                                        <th>{% trans "HH Address" %}</th>
                                        <th>{% trans "HH Representative Name" %}</th>
                                        <th>{% trans "ID Number" %}</th>
                                        <th>{% trans "Primary Phone" %}</th>
                                        <th>{% trans "Secondary Phone" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for adult in adults %}
                                        <tr class="row-class" adultID="{{ adult.id }}">
                                          <td>{{ adult.school.location.name }}</td>
                                          <td>{{ adult.address }}</td>
                                          <td>{{ adult.first_name }}</td>
                                          <td>{{ adult.id_number }}</td>
                                          <td>{{ adult.primary_phone }}</td>
                                          <td>{{ adult.secondary_phone }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                     </div>
                </div>
            </div>

            </section>
         </section>


     <div id = "hhEditForm" style ="display:none">

       {% include 'registration-pilot/registration-update.html' %}

     </div>

{% endblock %}

{% block extra_js %}

    <script type="text/javascript" language="javascript" src="{% static 'js/jquery-1.12.3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/dataTables.bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/util.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/tooltip.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/plugins.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/sly.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootbox.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/registration-pilot/UI/SlyInitialisation.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/registration-pilot/Validation/validator.js' %}"></script>
    <script type="text/javascript">
        var oTable = null;
        var language  = '{{ LANGUAGE_CODE }}';
        var protocol = 'http://';
        {% if request.is_secure %}
            protocol = 'https://';
        {% endif %}
        var host = protocol+'{{ request.get_host }}';
        var synchro_path = host+'/api/registry-search/';

        var checking_id_number_url = host+'/api/registrations-adult-id/';
        var childURL = host+'/api/registrations-child/';

        var hhID = null;

        $(document).ready
        (
           function()
           {
{#              oTable = $('#registrations-table').DataTable#}
{#              (#}
{#                 {#}
{#                    fixedHeader: false,#}
{#                    paging:   true,#}
{#                    ordering: true,#}
{#                    info:     true,#}
{#                    autoWidth: false,#}
{#                    scrollY: '50vh',#}
{#                    scrollX: true,#}
{#                    scrollCollapse: true,#}
{#                    "language": {#}
{#                        "url": "/static/locale/"+language+".json"#}
{#                    },#}
{#                    "fnInitComplete": function(oSettings, json) {#}
{#                        $('[data-toggle="tooltip"]').tooltip();#}
{#                    }#}
{#                 }#}
{#              );#}
              InitialiseSave();
              InitialiseClose();
              InitialiseChildDropdown();

              $(document).on
              (
                 'click',
                 '.row-class',
                 function()
                 {
                    block = $(this);
                    hhID = block.attr('adultID')
                    $("#hhList").hide();
                    LoadData(hhID);
                    $("#hhEditForm").show();
                    CheckInitialiseSly();
                 }
               );

                // get the list of household and fill the table with it
               /*
                $("#id_location").change(function(){
                   var selected_location = $(this).val();
                   // reload the page with the location id passed in post
                    var url = '{% url "registrations:registry_search" %}';
                    if(selected_location){
                        url = url+'?location='+selected_location;
                    }
                    window.location.href = url;
                });
                */

                $("#searchButton").click(function(){
                    Search();
                });

                $("#addressSearchText,#repSearchText,#idSearchText,#primarySearchText,#secondarySearchText").keyup
                (
                    function(event)
                    {
                        if(event.keyCode == 13)
                        {
                            Search();
                        }
                    }
                );


                function Search()
                {
                   var selected_location = $("#id_location").val();

                   // reload the page with the location id passed in post
                    var url = '{% url "registrations:registry_search" %}';
                    if(selected_location){
                        url = url+'?location='+selected_location;

                        url = AddParameter(url,"addressSearchText");
                        url = AddParameter(url,"repSearchText");
                        url = AddParameter(url,"idSearchText");
                        url = AddParameter(url,"primarySearchText");
                        url = AddParameter(url,"secondarySearchText");
                    }
                    window.location.href = url;
                }


                function AddParameter( url, id)
                {
                   var parameterText = $("#"+id).val();
                   url = url+'&'+id+'='+parameterText;

                   return url;
                }

            function load_base_data()
              {
                  pull_data_from_server(host+'/api/schools/', 'schools');
              }

            // get selected option to update and set the fields visible
            $("#changeOption").change(function () {
              hideAll();
              var selectedOption = $(this).val();

              if(selectedOption == 'phone') {
                $("#phoneFields").show();
                }
                else if (selectedOption =='address' )  {
                $("#addressFields").show();
                }
                else if (selectedOption == 'school' ) {
                  $("#schoolFields").show();
                  UpdateChildSchool();
                }
                else if (selectedOption == 'beneficiary' ) {
                  $("#beneficiaryFields").show();
                }
                else if (selectedOption == 'payment' ) {
                  $("#paymentFields").show();
                }
                else if (selectedOption == 'cardStatus' ) {
                  $("#cardStatusFields").show();
                }
                else if (selectedOption == 'card' ) {
                  $("#cardFields").show();
                }
                else if (selectedOption == 'removeComplaint' ) {
                  $("#removeFields").show();
                }
                else if (selectedOption == 'schoolComplaint' ) {
                  $("#schoolFields").show();
                }
                else if (selectedOption == 'otherComplaint' ) {
                  $("#otherFields").show();
                }
                });

          function hideAll()
          {
            $("#phoneFields").hide();
            $("#addressFields").hide();
            $("#schoolFields").hide();
            $("#beneficiaryFields").hide();
            $("#paymentFields").hide();
            $("#cardFields").hide();
            $("#cardStatusFields").hide();
            $("#removeFields").hide();
            $("#otherFields").hide();
            $("#schoolFields").hide();

          }

              function loadAjaxCall(regId , data)
            {
                 $.ajax({
                    type: "PATCH",
                    url: synchro_path+regId+'/',
                    cache: false,
                    headers: getHeader(),
                    dataType: 'json',
                    data: data,
                    beforeSend: function( ) {
                       // show loader
                        $(".loader").show();
                      }
                 }).done(function(data) {
                  // hide loader, show success message
                    $(".loader").hide();
                     if(data) {
                         $(".alert-success").fadeIn();
                         setTimeout(function () {
                             $(".alert-success").fadeOut();
                         }, 1000);
                     }
                     else {
                         $(".alert-danger").fadeIn();
                         setTimeout(function () {
                             $(".alert-danger").fadeOut();
                         }, 2000);
                     }
                });
            }

      });


      var householdRecord = null;

      function LoadData(hhID)
      {
         $.ajax({
                     type: "GET",
                     url: checking_id_number_url+hhID,
                     data: [],
                     cache: false,
                     async: false,
                     headers: getHeader(),
                     dataType: 'json',
                     success: function (response) {
                         var household = response;
                         householdRecord = household;
                         console.log(response);

                         $("#hhName").text(household.first_name+' '+household.father_name+' '+household.last_name);
                         $("#hhIdNumber").text(household.id_number);
                         $("#hhDOB").text(household.birthday_day+'/'+household.birthday_month+'/'+household.birthday_year);
                         $("#hhLastcardgigits").text(household.card_last_four_digits);
                         $("#hhprimary_phone").text(household.primary_phone);
                         $("#hhsecondary_phone").text(household.secondary_phone);
                         $("#hhAddess").text(household.address);
                         $("#hhCardStatus").text(household.card_status);
                         $("#hhDateOfDistribution").text(household.card_distribution_date);

                         $("#primary_phone").val(household.primary_phone);
                         updateDropDownValue($("#primary_phone_answered"),household.primary_phone_answered);
                         $("#secondary_phone").val(household.secondary_phone);
                         updateDropDownValue($("#secondary_phone_answered"),household.secondary_phone_answered);
                         $("#address").val(household.address);

                         $("#schools-table tbody").empty();
                         for(childIndex in household.children)
                         {
                            var child = household.children[childIndex];
                            AddChildRow(child);
                         }

                         $("#payments-table tbody").empty();
                         for(paymentIndex in household.payments)
                         {
                            var payment = household.payments[paymentIndex];
                            AddPaymentRow(payment);
                         }
                     },
                     error: function (response) {
                        var required_fields = JSON.parse(response.responseText);
                        console.log(response);
                     }
                 });
      }

          function AddChildRow(entry)
            {
                var childFullName = entry.first_name+' '+entry.father_name+' '+entry.last_name;

                var childIDCell = "<td style = \"display:none\">"+(entry.reg_id)+"</td>";
                var childNameCell = "<td  >"+(childFullName)+"</td>";

                var schoolCell = "<td>"+$("#childSchool").html()+"</td>";

                updateDropDownValue($("#schools-table tr:last-child td:nth-child(3) select"), entry.school_changed_to_verify );

                $("#schools-table tbody").append
                (
                   "<tr>"+childIDCell+childNameCell+schoolCell+"</tr>"
                );
            }

            function AddPaymentRow(entry)
            {
                var dateCell = "<td>"+entry.payment_date +"</td>";
                var amountCell = "<td>"+entry.payment_amount+"</td>";
                var monthCell = "<td>"+entry.payment_month+"</td>";
                var yearCell = "<td>"+entry.payment_year+"</td>";


                $("#payments-table tbody").append
                (
                   "<tr>"+dateCell+amountCell+monthCell+yearCell+"</tr>"
                );
            }


      function updateDropDownValue(dropDownElement, value)
      {
          dropDownElement.find('option:selected').removeAttr('selected');
          dropDownElement.find('option[value="'+value+'"]').attr("selected",true);
          dropDownElement.val(value);
      }


       function CreateChildData(childVisitID)
        {
           childData = [];

           $("#schools-table tbody tr")
           .each
           (
              function(i, obj)
              {
                 trElement = $(obj);

                 childRecord = new Object();

                 childRecord.reg_id = trElement.find('td:nth-child(1)').html();

                 dropDownElement = trElement.find('td:nth-child(3) select');

                 childRecord.school_changed_to_verify = dropDownElement.val();

                 childData.push(childRecord);

              }
           );

           return childData;
        }

      function CloseHousehold()
      {
        $("#hhList").show();

        $("#hhEditForm").hide();

        householdRecord = null;
        hhID = null;
      }

      function InitialiseSave()
      {
          $(document).on
          (
             'click',
             '#hhSaveButton',
             function()
             {
                if(ValidateHouseHoldUpdate())
                {
                   if($("#changeOption").val() == "phone" || $("#changeOption").val() == "address" || $("#changeOption").val() == "beneficiary" )
                   {
                      SaveHousehold();
                   }
                   else if($("#changeOption").val() == "school")
                   {
                      SaveChildren();
                   }
                }
             }
           );
      }

      function InitialiseClose()
      {
        $(document).on
          (
             'click',
             '#hhCloseButton',
             function()
             {
                $("#hhList").show();
                $("#hhEditForm").hide();
                householdRecord = null;
                hhID = null;
             }
           );
      }

      function SaveHousehold()
      {

         var houseHoldData = new Object();

         if($("#changeOption").val() == "phone")
         {
            houseHoldData.primary_phone = $("#primary_phone").val();
            houseHoldData.primary_phone_answered = $("#primary_phone_answered").val();
            houseHoldData.secondary_phone = $("#secondary_phone").val();
            houseHoldData.secondary_phone_answered  = $("#secondary_phone_answered").val();
         }
         else if($("#changeOption").val() == "address")
         {
            houseHoldData.address = $("#address").val();
         }
         else if($("#changeOption").val() == "beneficiary")
         {
             var isbeneficiary_changed= GetBooleanSelection($("#radioBtn"));
            houseHoldData.beneficiary_changed_verify = isbeneficiary_changed ;

         }

         $.ajax
         (
            {
              type: "PATCH",
              url: checking_id_number_url + hhID +"/",
              data: houseHoldData,
              cache: false,
              async: false,
              headers: getHeader(),
              dataType: 'json',
              success: function (response)
              {
                  var block = $("#registrations-table tr[adultid="+hhID+"]");

                  block.find("td:nth-child(5)").text($("#primary_phone").val());
                  block.find("td:nth-child(6)").text($("#secondary_phone").val());

                  block.find("td:nth-child(2)").text($("#address").val());

                  CloseHousehold();

              },
              error: function (response)
              {
                  console.log(response);
              }
           }
         );
      }


       function GetBooleanSelection(element)
       {
          return element.find('a.active').attr('data-title')==1 ? "true":"false";
       }

       function SaveChildren()
       {
           var childData = CreateChildData();

           var isSuccessfull = true;

           childData.forEach
           (
              function(entry)
              {
                 isSuccessfull = isSuccessfull && SaveChild(entry);
              }
           );

           if(isSuccessfull)
           {
               CloseHousehold();
           }
       }


      function SaveChild(entry)
      {
         var childID = entry.reg_id;
         var childData = new Object();

         childData.school_changed_to_verify = entry.school_changed_to_verify;

         var isSuccessfull = false;

         $.ajax
         (
            {
              type: "PATCH",
              url: childURL + childID +"/",
              data: childData,
              cache: false,
              async: false,
              headers: getHeader(),
              dataType: 'json',
              success: function (response)
              {
                  isSuccessfull = true;
              },
              error: function (response)
              {
                  console.log(response);
              },
              async: false
           }
         );

         alert(isSuccessfull);

         return isSuccessfull;
      }

      function UpdateChildSchool()
      {
         var childID = $("#child").val();

         var children = householdRecord.children.filter
         (
            function(child)
            {
               return child.student_id == childID;
            }
         );


         if(children.length > 0)
         {
            childRecord = children[0];

            console.log(childRecord);

            updateDropDownValue($("#school"),childRecord.school_changed_to_verify);

         }

      }

      function InitialiseChildDropdown()
      {
          $(document).on
          (
             'change',
             '#child',
             function()
             {
                UpdateChildSchool();
             }
           );
      }

    </script>

{% endblock %}


