{% extends "base.html" %}
{% load staticfiles i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% load util_tags %}

{% block extra_head %}
  <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-breadcrumbs.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/jquery.dataTables.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/buttons.dataTables.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'css/select.dataTables.min.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/sly.css' %}"
          xmlns:font-weight="http://www.w3.org/1999/xhtml" xmlns:font-weight="http://www.w3.org/1999/xhtml">


    <style>
        .row-class {
            cursor: pointer;
        }
        .row-class:hover {
           background-color: gainsboro !IMPORTANT;
        }

        .child-row-class {
            cursor: pointer;
        }
        .child-row-class:hover {
           background-color: gainsboro !IMPORTANT;
        }

        .transparent-header
        {
           background-color: transparent !IMPORTANT;
           border: solid 0px transparent !IMPORTANT;
        }

    </style>

{% endblock %}


{% block content %}


         <div class="loader"></div>

         <section class="main-content-wrapper" id = "hhList">
            <section id="main-content">
                 <div class="row">
                    <div class="col-md-12">
                        </br>
                    </div>
                </div>
            <div class="row">

                <div class="alert alert-success" role="alert" style="display: none;">
                    <strong>{% trans 'Success' %}</strong> {% trans 'Your change is successfully Saved' %}
                </div>
                <div class="alert alert-warning" role="alert" style="display: none;">
                    <strong>{% trans 'Oops' %}</strong> {% trans 'Error saving changes, please contact system administrators' %}
                </div>

                    <div class="col-md-12">
                        <div class="panel panel-default">
                          <div class="panel-heading">
                            <h3 class="panel-title">
                                <ol class="breadcrumb">
                                  <li><a>{% trans "Household Update" %}</a></li>
                                  <li>

                                  </li>
                                </ol>
                            </h3>
                            <div class="actions pull-right">
                                <i class="fa fa-chevron-down"></i>
                                <i class="fa fa-times"></i>
                            </div>
                          </div>
                          <div class="panel-body">
                                <table id="registrations-table" class="table table-striped table-bordered cell-border"
                                       data-height="500"
                                       data-pagination="true"
                                       data-search="true"
                                       cellspacing="0"
                                       width="100%">
                                <thead>
                                    <tr id="thead-line-1">
                                        <th class = "transparent-header">

                                        </th>
                                        <th class = "transparent-header">

                                        </th>
                                        <th class = "transparent-header"></th>
                                        <th class = "transparent-header"></th>
                                        <th class = "transparent-header"></th>
                                        <th class = "transparent-header">

                                            <button class="btn btn-primary" type="button" id="searchButton">
                                                Search
                                            </button>

                                        </th>
                                    </tr>

                                    <tr id="thead-line-1">
                                        <th class = "transparent-header">

                                            <select id="id_location">
                                              <option value="">---{% trans "Display by Location" %}---</option>
                                                {% for location in locations %}
                                                    <option value="{{ location.id }}" {% if selectedLocation == location.id %}selected="selected"{% endif %}>
                                                      {{ location }}
                                                    </option>
                                                {% endfor %}
                                            </select>

                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "repSearchText" value = "{{repSearchText}}" />
                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "idSearchText" value = "{{idSearchText}}" />
                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "primarySearchText" value = "{{primarySearchText}}" />
                                        </th>
                                        <th class = "transparent-header">
                                             <input class="form-control input-sm" id = "secondarySearchText" value = "{{secondarySearchText}}" />
                                        </th>
                                    </tr>
                                    <tr id="thead-line-1">
                                        <th>{% trans "HH District" %}</th>
                                        <th>{% trans "HH Representative Name" %}</th>
                                        <th>{% trans "ID Number" %}</th>
                                        <th>{% trans "Primary Phone" %}</th>
                                        <th>{% trans "Secondary Phone" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for adult in adults %}
                                        <tr class="row-class" adultID="{{ adult.id }}">
                                            <td>{{ adult.school.location.name }}</td>
                                            <td>{{ adult.adult_full_name }}</td>
                                            <td>{{ adult.id_number }}</td>
                                            <td>{{ adult.primary_phone }}</td>
                                            <td>{{ adult.secondary_phone }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                     </div>
                </div>
            </div>

            </section>
         </section>


     <div id = "hhEditForm" style ="display:none">

       {% include 'registration-pilot/registration-update.html' %}

     </div>

{% endblock %}

{% block extra_js %}

    <script type="text/javascript" language="javascript" src="{% static 'js/jquery-1.12.3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/dataTables.bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/util.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/tooltip.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/plugins.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/sly.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootbox.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/date.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/registration-pilot/UI/SlyInitialisation.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/registration-pilot/Validation/validator.js' %}"></script>
    <script type="text/javascript">
        var oTable = null;
        var language  = '{{ LANGUAGE_CODE }}';
        var protocol = 'http://';
        {% if request.is_secure %}
            protocol = 'https://';
        {% endif %}
        var host = protocol+'{{ request.get_host }}';
        var synchro_path = host+'/api/registry-search/';

        var checking_id_number_url = host+'/api/registrations-adult-id/';
        var childURL = host+'/api/registrations-child/';
        var complaintURL = host+'/api/registrations_complaint/';

        var hhID = null;

        $(document).ready
        (
           function()
           {
               InitialiseDays('days', 1,31);
               InitialiseDays('years',1930,2000);
               InitialiseSave();
               InitialiseClose();
               InitialiseChildDropdown();

              $(document).on
              (
                 'click',
                 '.row-class',
                 function()
                 {
                    block = $(this);
                    hhID = block.attr('adultID')
                    $("#hhList").hide();
                    $("#changeOption")[0].selectedIndex = 0;
                    hideAll();
                    LoadData(hhID);
                    $("#hhEditForm").show();
                    CheckInitialiseSly();
                 }
               );

                // get the list of household and fill the table with it
               /*
                $("#id_location").change(function(){
                   var selected_location = $(this).val();
                   // reload the page with the location id passed in post
                    var url = '{% url "registrations:registry_search" %}';
                    if(selected_location){
                        url = url+'?location='+selected_location;
                    }
                    window.location.href = url;
                });
                */

                $("#searchButton").click(function(){
                    Search();
                });

                $("#repSearchText,#idSearchText,#primarySearchText,#secondarySearchText").keyup
                (
                    function(event)
                    {
                        if(event.keyCode == 13)
                        {
                            Search();
                        }
                    }
                );
                function Search()
                {
                   var selected_location = $("#id_location").val();

                   // reload the page with the location id passed in post
                    var url = '{% url "registrations:registry_search" %}';
                    if(selected_location){
                        url = url+'?location='+selected_location;
                        url = AddParameter(url,"repSearchText");
                        url = AddParameter(url,"idSearchText");
                        url = AddParameter(url,"primarySearchText");
                        url = AddParameter(url,"secondarySearchText");
                    }
                    window.location.href = url;
                }


                function AddParameter( url, id)
                {
                   var parameterText = $("#"+id).val();
                   url = url+'&'+id+'='+parameterText;

                   return url;
                }

            function load_base_data()
              {
                  pull_data_from_server(host+'/api/schools/', 'schools');
              }

            // get selected option to update and set the fields visible
            $("#changeOption").change(function () {
              hideAll();
              var selectedOption = $(this).val();

              if(selectedOption == 'phone') {
                $("#phoneFields").show();
                }
                else if (selectedOption =='address' )  {
                $("#addressFields").show();
                }
                else if (selectedOption == 'school_change' ) {
                  $("#schoolChangeFields").show();
                  UpdateChildSchool();
                }
                else if (selectedOption == 'beneficiary' ) {
                  $("#beneficiaryFields").show();
                }
                else if (selectedOption == 'payment' ) {
                  $("#paymentFields").show();
                  $("#ComplaintFields").show();
                }
                else if (selectedOption == 'cardStatus' ) {
                  $("#cardStatusFields").show();
                  $("#ComplaintFields").show();
                }
                else if (selectedOption == 'card' ) {
                  $("#cardFields").show();
                  $("#ComplaintFields").show();
                }
                else if (selectedOption == 'reinstateBeneficiary' ) {
                  $("#reinstateBeneficiaryFields").show();
                  $("#ComplaintFields").show();
                }
                else if (selectedOption == 'schoolRefusedEntrance' ) {
                  $("#schoolRefusedEntranceFields").show();
                  $("#ComplaintFields").show();
                }
                else if (selectedOption == 'otherComplaint' ) {
                  $("#otherFields").show();
                  $("#ComplaintFields").show();
                }
                else if (selectedOption == 'refusedServiceBLF' ) {
                  $("#bankFields").show();
                  $("#ComplaintFields").show();
                }
                else if (selectedOption == 'twoCards' ) {
                  $("#twoCardsFields").show();
                }

                });



          function hideAll()
          {
            $("#phoneFields").hide();
            $("#addressFields").hide();
            $("#schoolChangeFields").hide();
            $("#beneficiaryFields").hide();
            $("#paymentFields").hide();
            $("#cardFields").hide();
            $("#cardStatusFields").hide();
            $("#removeFields").hide();
            $("#otherFields").hide();
            $("#schoolRefusedEntranceFields").hide();
            $("#ComplaintFields").hide();
            $("#reinstateBeneficiaryFields").hide();
            $("#bankFields").hide();
            $("#twoCardsFields").hide();
          }

              function loadAjaxCall(regId , data)
            {
                 $.ajax({
                    type: "PATCH",
                    url: synchro_path+regId+'/',
                    cache: false,
                    headers: getHeader(),
                    dataType: 'json',
                    data: data,
                    beforeSend: function( ) {
                       // show loader
                        $(".loader").show();
                      }
                 }).done(function(data) {
                  // hide loader, show success message
                    $(".loader").hide();
                     if(data) {
                         $(".alert-success").fadeIn();
                         setTimeout(function () {
                             $(".alert-success").fadeOut();
                         }, 1000);
                     }
                     else {
                         $(".alert-danger").fadeIn();
                         setTimeout(function () {
                             $(".alert-danger").fadeOut();
                         }, 2000);
                     }
                });
            }

      });


      var householdRecord = null;

      function LoadData(hhID)
      {
         $.ajax({
                     type: "GET",
                     url: checking_id_number_url+hhID,
                     data: [],
                     cache: false,
                     async: false,
                     headers: getHeader(),
                     dataType: 'json',
                     success: function (response) {
                         var household = response;
                         householdRecord = household;
                         console.log(response);

                         $("#hhName").text(household.first_name+' '+household.father_name+' '+household.last_name);
                         $("#hhIdNumber").text(household.id_number);
                         $("#hhDOB").text(household.birthday_day+'/'+household.birthday_month+'/'+household.birthday_year);
                         $("#hhLastcardgigits").text(household.card_last_four_digits);
                         $("#hhprimary_phone").text(household.primary_phone);
                         $("#hhsecondary_phone").text(household.secondary_phone);
                         $("#hh_current_primary_phone").text(household.primary_phone);
                         $("#hh_current_secondary_phone").text(household.secondary_phone);

                         $("#hhAddess").text(household.address);

                         $("#hhCardStatus").text(household.card_status);
                         var cardStatus = household.card_status;
                         if (cardStatus=='Active')
                         {
                             document.getElementById('hhCardStatus').style.color = "#7b7b7b";
                         }
                         else
                         {
                             document.getElementById('hhCardStatus').style.color = "red";
                         }


                         $("#hhDateOfDistribution").text(household.card_distribution_date);

                         $("#primary_phone").val('');
                         $("#primary_phone_confirm").val('');
                         updateDropDownValue($("#primary_phone_answered"),household.primary_phone_answered);
                         $("#secondary_phone").val('');
                         $("#secondary_phone_confirm").val('');
                         updateDropDownValue($("#secondary_phone_answered"),household.secondary_phone_answered);
                         $("#address").val('');

                         var suspended = household.household_suspended;
                         if (suspended)
                         {
                             $("#hhsuspended").show();
                             $("#hhsuspended_payment").text('Suspended');
                             document.getElementById('hhsuspended_payment').style.color = "red";
                         }
                         else
                         {
                             $("#hhsuspended").hide();
                             $("#hhsuspended_payment").text('Active');
                             document.getElementById('hhsuspended_payment').style.color = "#7b7b7b";
                         }
                         $("#id_number").val(household.beneficiary_changed_id_number);
                         $("#first_name").val(household.beneficiary_changed_first_name);
                         $("#father_name").val(household.beneficiary_changed_father_name);
                         $("#last_name").val(household.beneficiary_changed_last_name);
                         $("#mother_full_name").val(household.beneficiary_changed_mother_full_name);
                         $("#beneficiary_phone").val(household.beneficiary_changed_phone);
                         $("#beneficiary_phone_confirm").val('');
                         ChangeBooleanSelection($("#radioBtn"), household.beneficiary_changed_phone)
                         updateDropDownValue($("#idType"),household.beneficiary_changed_id_type);
                         updateDropDownValue($("#gender"),household.beneficiary_changed_gender);
                         updateDropDownValue($("#days"),household.beneficiary_changed_birthday_day);
                         updateDropDownValue($("#months"),household.beneficiary_changed_birthday_month);
                         updateDropDownValue($("#years"),household.beneficiary_changed_birthday_year);
                         updateDropDownValue($("#relation_to_householdhead"),household.beneficiary_changed_relation_to_householdhead);
                         updateDropDownValue($("#reason"),household.beneficiary_changed_reason);


                         $("#first_card_case_number").val(household.duplicate_card_first_card_case_number);
                         $("#first_card_case_number_confirm").val('');
                         $("#first_card_last_four_digits").val(household.duplicate_card_first_card_last_four_digits);
                         $("#second_card_case_number").val(household.duplicate_card_second_card_case_number);
                         $("#second_card_case_number_confirm").val('');
                         $("#secondcard_last_four_digits").val(household.duplicate_card_secondcard_last_four_digits);

                         $("#schools-table tbody").empty();
                         $("#children-table tbody").empty();
                         for(childIndex in household.children)
                         {
                            var child = household.children[childIndex];
                            AddChildSchoolRow(child);
                            AddChildAgeRow(child);
                         }

                         $("#payments-table tbody").empty();
                         for(paymentIndex in household.payments)
                         {
                            var payment = household.payments[paymentIndex];
                            AddPaymentRow(payment);
                         }

                         $("#complaints-table tbody").empty();
                         for(complaintIndex in household.complaints)
                         {
                            var complaint = household.complaints[complaintIndex];
                            AddComplaintRow(complaint);
                         }



                     },
                     error: function (response) {
                        var required_fields = JSON.parse(response.responseText);
                        console.log(response);
                     }
                 });
      }

          function AddChildSchoolRow(entry)
            {
                var childFullName = entry.first_name+' '+entry.father_name+' '+entry.last_name;

                var childIDCell = "<td style = \"display:none\">"+(entry.reg_id)+"</td>";
                var childNameCell = "<td  >"+(childFullName)+"</td>";
                var currentSchoolCell = "<td  >"+(entry.school_name)+"</td>";
                var NewslocationCell = "<td>"+$("#childSchoolLocation").html()+"</td>";
                var NewschoolCell = "<td>"+$("#childSchool").html()+"</td>";
                updateDropDownValue($("#schools-table tr:last-child td:nth-child(5) select"), entry.school_changed_to_verify );

                $("#schools-table tbody").append
                (
                   "<tr>"+childIDCell+childNameCell+currentSchoolCell+NewslocationCell+NewschoolCell+"</tr>"
                );
            }

          function AddChildAgeRow(entry)
            {
                var childFullName = entry.first_name+' '+entry.father_name+' '+entry.last_name;
                var childNameCell = "<td  >"+(childFullName)+"</td>";

                var ChildDOB = entry.birthday_day+'/'+entry.birthday_month+'/'+entry.birthday_year;
                var childDOBCell = "<td  >"+(ChildDOB)+"</td>";

                var schoolCell = "<td  >"+(entry.school_name)+"</td>";

                $("#children-table tbody").append
                (
                   "<tr>"+childNameCell+childDOBCell+schoolCell+"</tr>"
                );
            }

            function AddPaymentRow(entry)
            {
                var dateCell = "<td>"+FormatDate(entry.payment_date) +"</td>";
                var amountCell = "<td>"+entry.payment_amount+"</td>";
                var monthCell = "<td>"+entry.payment_month+"</td>";
                var yearCell = "<td>"+entry.payment_year+"</td>";


                $("#payments-table tbody").append
                (
                   "<tr>"+dateCell+amountCell+monthCell+yearCell+"</tr>"
                );
            }

            function AddComplaintRow(entry)
            {
                var dateIssuedCell = "<td>"+FormatDate(entry.created)+"</td>";
                var typeCell = "<td>"+entry.complaint_category_name +"</td>";
                var noteCell = "<td>"+entry.complaint_note+"</td>";
                var dateReplyCell = "<td>"+FormatDate(entry.complaint_resolution_date)+"</td>";
                var ReplyCell = "<td>"+entry.complaint_solution+"</td>";
                var statusCell = "<td>"+entry.complaint_status+"</td>";


                $("#complaints-table tbody").append
                (
                   "<tr>"+typeCell+dateIssuedCell+noteCell+statusCell+ReplyCell+dateReplyCell+"</tr>"
                );
            }


      function updateDropDownValue(dropDownElement, value)
      {
          dropDownElement.find('option:selected').removeAttr('selected');
          dropDownElement.find('option[value="'+value+'"]').attr("selected",true);
          dropDownElement.val(value);
      }


       function CreateChildData(childVisitID)
        {
           childData = [];

           $("#schools-table tbody tr")
           .each
           (
              function(i, obj)
              {
                 trElement = $(obj);

                 childRecord = new Object();

                 childRecord.reg_id = trElement.find('td:nth-child(1)').html();

                 dropDownElement = trElement.find('td:nth-child(5) select');

                 childRecord.school_changed_to_verify = dropDownElement.val();

                 childData.push(childRecord);

              }
           );

           return childData;
        }

      function CloseHousehold()
      {
        $("#hhList").show();

        $("#hhEditForm").hide();

        householdRecord = null;
        hhID = null;
      }


      function InitialiseDays(cntrl, from, to)
      {
        (function() {
            var elm = document.getElementById(cntrl), // get the select
                df = document.createDocumentFragment(); // create a document fragment to hold the options while we create them
            for (var i = from; i <= to; i++) { // loop, i like 42.
                var option = document.createElement('option'); // create the option element
                option.value = i; // set the value property
                option.appendChild(document.createTextNode(i)); // set the textContent in a safe way.
                df.appendChild(option); // append the option to the document fragment
            }
            elm.appendChild(df); // append the document fragment to the DOM. this is the better way rather than setting innerHTML a bunch of times (or even once with a long string)
        }());
      }

      function InitialiseSave()
      {
          $(document).on
          (
             'click',
             '#hhSaveButton',
             function()
             {
                if(ValidateHouseHoldUpdate())
                {
                   if($("#changeOption").val() == "phone" || $("#changeOption").val() == "address"
                       || $("#changeOption").val() == "beneficiary" || $("#changeOption").val() == "twoCards")
                   {
                      SaveHousehold();
                   }
                   else if($("#changeOption").val() == "school_change")
                   {
                      SaveChildren();
                   }
                   else if($("#changeOption").val() == "payment" || $("#changeOption").val() == "cardStatus"
                       || $("#changeOption").val() == "card" || $("#changeOption").val() == "refusedServiceBLF"
                   || $("#changeOption").val() == "schoolRefusedEntrance" || $("#changeOption").val() == "reinstateBeneficiary"
                   || $("#changeOption").val() == "otherComplaint" )
                   {
                       SaveComplaint();
                   }
                }
             }
           );
      }

      function InitialiseClose()
      {
        $(document).on
          (
             'click',
             '#hhCloseButton',
             function()
             {
                $("#hhList").show();
                $("#hhEditForm").hide();
                householdRecord = null;
                hhID = null;
             }
           );
      }

      function SaveHousehold()
      {
          var houseHoldData = new Object();

          if($("#changeOption").val() == "phone")
          {
              houseHoldData.primary_phone = $("#primary_phone").val();
              houseHoldData.primary_phone_answered = $("#primary_phone_answered").val();
              houseHoldData.secondary_phone = $("#secondary_phone").val();
              houseHoldData.secondary_phone_answered  = $("#secondary_phone_answered").val();
          }
          else if($("#changeOption").val() == "address")
          {
              houseHoldData.address = $("#address").val();
          }
          else if($("#changeOption").val() == "beneficiary")
          {
              SaveNewBenificiary(houseHoldData);
          }
          else if($("#changeOption").val() == "twoCards")
          {
              houseHoldData.duplicate_card_first_card_case_number = $("#first_card_case_number").val();
              houseHoldData.duplicate_card_first_card_last_four_digits = $("#first_card_last_four_digits").val();
              houseHoldData.duplicate_card_second_card_case_number = $("#second_card_case_number").val();
              houseHoldData.duplicate_card_secondcard_last_four_digits = $("#secondcard_last_four_digits").val();
          }
          $.ajax
          (
              {
                  type: "PATCH",
                  url: checking_id_number_url + hhID +"/",
                  data: houseHoldData,
                  cache: false,
                  async: false,
                  headers: getHeader(),
                  dataType: 'json',
                  success: function (response)
                  {
                      var block = $("#registrations-table tr[adultid="+hhID+"]");

                      block.find("td:nth-child(4)").text($("#primary_phone").val());
                      block.find("td:nth-child(5)").text($("#secondary_phone").val());
                      CloseHousehold();

                  },
                  error: function (response)
                  {
                      console.log(response);
                  }
              }
          );
      }

      function SaveNewBenificiary(houseHoldData)
      {

          var isbeneficiary_changed= GetBooleanSelection($("#radioBtn"));
          houseHoldData.beneficiary_changed_verify = true ;
          houseHoldData.beneficiary_changed_same_as_caller = isbeneficiary_changed ;

          houseHoldData.beneficiary_changed_id_type = $("#idType").val();
          houseHoldData.beneficiary_changed_id_number = $("#id_number").val();
          houseHoldData.beneficiary_changed_first_name = $("#first_name").val();
          houseHoldData.beneficiary_changed_father_name = $("#father_name").val();
          houseHoldData.beneficiary_changed_last_name = $("#last_name").val();
          houseHoldData.beneficiary_changed_mother_full_name = $("#mother_full_name").val()

          houseHoldData.beneficiary_changed_gender = $("#gender").val();
          houseHoldData.beneficiary_changed_birthday_day = $("#days").val();
          houseHoldData.beneficiary_changed_birthday_month = $("#months").val();
          houseHoldData.beneficiary_changed_birthday_year = $("#years").val();
          houseHoldData.beneficiary_changed_relation_to_householdhead = $("#relation_to_householdhead").val();

          houseHoldData.beneficiary_changed_phone = $("#beneficiary_phone").val();
          houseHoldData.beneficiary_changed_reason = $("#reason").val();
      }


       function GetBooleanSelection(element)
       {
          return element.find('a.active').attr('data-title')==1 ? "true":"false";
       }

       function ChangeBooleanSelection(element, isSelected)
       {
           ChangeBooleanSelectionOption(element.find('a[data-title=1]'),isSelected);
           ChangeBooleanSelectionOption(element.find('a[data-title=0]'),!isSelected);
       }
       function ChangeBooleanSelectionOption(element, isSelected)
           {
              if(isSelected)
              {
                 element.addClass("active");
                 element.removeClass("notActive");
              }
              else
              {
                 element.removeClass("active");
                 element.addClass("notActive");
              }
           }

       function SaveChildren()
       {
           var childData = CreateChildData();

           var isSuccessfull = true;

           childData.forEach
           (
              function(entry)
              {
                 isSuccessfull = isSuccessfull && SaveChild(entry);
              }
           );

           if(isSuccessfull)
           {
               CloseHousehold();
           }
       }


      function SaveChild(entry) {
          var childID = entry.reg_id;
          var childData = new Object();

          childData.school_changed_to_verify = entry.school_changed_to_verify;

          var isSuccessfull = false;

          $.ajax
          (
              {
                  type: "PATCH",
                  url: childURL + childID + "/",
                  data: childData,
                  cache: false,
                  async: false,
                  headers: getHeader(),
                  dataType: 'json',
                  success: function (response) {
                      isSuccessfull = true;
                  },
                  error: function (response) {
                      console.log(response);
                  },
                  async: false
              }
          );
          //alert(isSuccessfull);

          return isSuccessfull;
      }

      function UpdateChildSchool()
      {
         var childID = $("#child").val();

         var children = householdRecord.children.filter
         (
            function(child)
            {
               return child.student_id == childID;
            }
         );


         if(children.length > 0)
         {
            childRecord = children[0];

            console.log(childRecord);

            updateDropDownValue($("#school"),childRecord.school_changed_to_verify);

         }

      }

      function InitialiseChildDropdown()
      {
          $(document).on
          (
             'change',
             '#child',
             function()
             {
                UpdateChildSchool();
             }


           );
      }




      function SaveComplaint()
      {
          var complaint_category_id;

          if($("#changeOption").val() == "payment" )
          {
              complaint_category_id = $("#payment_complaint").val();
          }
          else if($("#changeOption").val() == "cardStatus")
          {
               complaint_category_id = $("#card_distribution_complaint").val();
          }
          else if($("#changeOption").val() == "card")
          {
              complaint_category_id = $("#card_complaint").val();
          }
          else if($("#changeOption").val() == "refusedServiceBLF")
          {
               complaint_category_id = $("#bank_complaint").val();
          }
          else if($("#changeOption").val() == "schoolRefusedEntrance")
          {
               complaint_category_id = $("#school_complaint").val();
          }
          else if($("#changeOption").val() == "reinstateBeneficiary")
          {
               complaint_category_id = $("#reinstate_complaint").val();
          }
          else if($("#changeOption").val() == "otherComplaint")
          {
               complaint_category_id = $("#other_complaint").val();
          }
          alert(complaint_category_id);

{#         var complaintData = new Object();#}
{#         complaintData.complaint_category_id = complaint_category_id;#}
{#         complaintData.complaint_note = $("#complaint").val();#}
{##}
{#         var isSuccessfull = false;#}
{##}
{#         $.ajax#}
{#         (#}
{#            {#}
{#              type: "PATCH",#}
{#              url: complaintURL + hhID +"/",#}
{#              data: complaintData,#}
{#              cache: false,#}
{#              async: false,#}
{#              headers: getHeader(),#}
{#              dataType: 'json',#}
{#              success: function (response)#}
{#              {#}
{#                  isSuccessfull = true;#}
{#              },#}
{#              error: function (response)#}
{#              {#}
{#                  console.log(response);#}
{#              },#}
{#              async: false#}
{#           }#}
{#         );#}
{#         //alert(isSuccessfull);#}
{##}
{#         return isSuccessfull;#}
      }



      function FormatDate(dateString)
        {
           var date;

           if(isDate(dateString, "yyyy-MM-ddTHH:mm:ssZ") )
           {
              date = new Date(getDateFromFormat(dateString, "yyyy-MM-ddTHH:mm:ssZ"));
           }
           else
           {
              date = new Date(dateString);
           }

           var result =
           (
              date.getDate().toString() + '/' +
              (date.getMonth() + 1).toString() + '/' +
              date.getFullYear().toString()
           );

           return result;
        }

        function FormatJSONDate(dateString)
        {
           var date;

           if(isDate(dateString, "dd/MM/yyyy") )
           {
              date = new Date(getDateFromFormat(dateString, "d/MM/yyyy"));
           }
           else if(isDate(dateString, "d/MM/yyyy") )
           {
              date = new Date(getDateFromFormat(dateString, "d/MM/yyyy"));
           }
           else if(isDate(dateString, "dd/M/yyyy") )
           {
              date = new Date(getDateFromFormat(dateString, "dd/M/yyyy"));
           }
           else
           {
              date = new Date(dateString);
           }

           return date;
        }




    </script>

{% endblock %}


